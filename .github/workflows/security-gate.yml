name: Security Gate  # v2 — permanent API Token

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

concurrency:
  group: security-gate-${{ github.ref }}
  cancel-in-progress: true

env:
  WORKERS_URL: https://seobaike-remote-control.icanforyouthebest.workers.dev

jobs:
  # ── Job 1: Internal Compliance Scan (44-item framework audit) ──
  internal-compliance-scan:
    name: Compliance Scan (5 Frameworks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Apply latest migrations (pre-scan)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          for f in supabase/migrations/*.sql; do
            NAME=$(basename "$f")
            SQL=$(cat "$f")
            HTTP=$(curl -s -o /tmp/mig_result.json -w "%{http_code}" \
              -X POST "https://api.supabase.com/v1/projects/vmyrivxxibqydccurxug/database/query" \
              -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
              -H "Content-Type: application/json" \
              --data-raw "$(python3 -c "import json,sys; print(json.dumps({'query':open('$f').read()}))")")
            echo "  $NAME → HTTP $HTTP"
          done
          echo "Pre-scan migrations applied."

      - name: Run full compliance scan via RPC
        id: scan
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: bash scripts/ci-compliance-check.sh

  # ── Job 2: Security Headers Check ──
  security-headers-check:
    name: Security Headers (6/6)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check security headers
        run: bash scripts/ci-headers-check.sh "$WORKERS_URL"

  # ── Job 3: Nuclei Vulnerability Scan ──
  nuclei-vulnerability-scan:
    name: Nuclei CVE Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nuclei
        uses: projectdiscovery/actions/setup/nuclei@v1

      - name: Run Nuclei scan
        id: nuclei
        run: |
          echo "============================================================"
          echo "  Nuclei Vulnerability Scan"
          echo "  Target: $WORKERS_URL"
          echo "============================================================"
          echo ""

          nuclei -u "$WORKERS_URL" \
            -severity critical,high \
            -json-export nuclei-results.json \
            -markdown-export nuclei-report.md \
            -silent \
            || true

          # Count critical/high findings
          CRIT_HIGH=0
          if [ -f nuclei-results.json ]; then
            CRIT_HIGH=$(wc -l < nuclei-results.json)
          fi

          echo ""
          echo "------------------------------------------------------------"
          echo "  Critical/High findings: $CRIT_HIGH"
          echo "------------------------------------------------------------"

          if [ "$CRIT_HIGH" -gt 0 ]; then
            echo ""
            echo "FAIL: $CRIT_HIGH critical/high vulnerabilities found"
            cat nuclei-results.json
            exit 1
          fi

          echo "PASS: 0 critical/high vulnerabilities"

      - name: Upload Nuclei results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-scan-results
          path: |
            nuclei-results.json
            nuclei-report.md
          retention-days: 30
          if-no-files-found: ignore

  # ── Job 4: Deploy (only on push, after all gates pass) ──
  deploy:
    name: Deploy to Production
    needs: [internal-compliance-scan, security-headers-check, nuclei-vulnerability-scan]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Push database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Pushing database migrations via Management API..."
          # Find unapplied migrations and execute via Management API
          for f in supabase/migrations/*.sql; do
            NAME=$(basename "$f")
            echo "  Applying: $NAME"
            SQL=$(cat "$f")
            HTTP_CODE=$(curl -s -o /tmp/migrate_result.json -w "%{http_code}" \
              -X POST "https://api.supabase.com/v1/projects/vmyrivxxibqydccurxug/database/query" \
              -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
              -H "Content-Type: application/json" \
              --data-raw "$(jq -n --arg q "$SQL" '{query: $q}')")
            if [ "$HTTP_CODE" -ge 400 ]; then
              echo "    WARNING: $NAME returned HTTP $HTTP_CODE (may already be applied)"
              cat /tmp/migrate_result.json
            else
              echo "    OK"
            fi
          done
          echo "Migrations complete."

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase functions deploy boss-approval --project-ref vmyrivxxibqydccurxug
          supabase functions deploy remote-command --project-ref vmyrivxxibqydccurxug
          supabase functions deploy ai-gateway --project-ref vmyrivxxibqydccurxug
          supabase functions deploy order-created --project-ref vmyrivxxibqydccurxug
          supabase functions deploy payment-captured --project-ref vmyrivxxibqydccurxug

      - name: Deploy Workers
        continue-on-error: true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd workers
          npm ci --legacy-peer-deps
          npx wrangler@4 deploy --config wrangler.toml 2>&1 || echo "Worker deploy failed (non-blocking)"

      - name: Post-deploy compliance verification
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "============================================================"
          echo "  Post-Deploy Compliance Verification"
          echo "============================================================"
          echo ""
          bash scripts/ci-compliance-check.sh
