name: Security Gate

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  WORKERS_URL: https://seobaike-remote-control.icanforyouthebest.workers.dev

jobs:
  # ── Job 1: Internal Compliance Scan (44-item framework audit) ──
  internal-compliance-scan:
    name: Compliance Scan (5 Frameworks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run full compliance scan via RPC
        id: scan
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: bash scripts/ci-compliance-check.sh

  # ── Job 2: Security Headers Check ──
  security-headers-check:
    name: Security Headers (6/6)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check security headers
        run: bash scripts/ci-headers-check.sh "$WORKERS_URL"

  # ── Job 3: Nuclei Vulnerability Scan ──
  nuclei-vulnerability-scan:
    name: Nuclei CVE Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nuclei
        uses: projectdiscovery/actions/setup/nuclei@v1

      - name: Run Nuclei scan
        id: nuclei
        run: |
          echo "============================================================"
          echo "  Nuclei Vulnerability Scan"
          echo "  Target: $WORKERS_URL"
          echo "============================================================"
          echo ""

          nuclei -u "$WORKERS_URL" \
            -severity critical,high \
            -json-export nuclei-results.json \
            -markdown-export nuclei-report.md \
            -silent \
            || true

          # Count critical/high findings
          CRIT_HIGH=0
          if [ -f nuclei-results.json ]; then
            CRIT_HIGH=$(wc -l < nuclei-results.json)
          fi

          echo ""
          echo "------------------------------------------------------------"
          echo "  Critical/High findings: $CRIT_HIGH"
          echo "------------------------------------------------------------"

          if [ "$CRIT_HIGH" -gt 0 ]; then
            echo ""
            echo "FAIL: $CRIT_HIGH critical/high vulnerabilities found"
            cat nuclei-results.json
            exit 1
          fi

          echo "PASS: 0 critical/high vulnerabilities"

      - name: Upload Nuclei results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-scan-results
          path: |
            nuclei-results.json
            nuclei-report.md
          retention-days: 30
          if-no-files-found: ignore

  # ── Job 4: Deploy (only on push, after all gates pass) ──
  deploy:
    name: Deploy to Production
    needs: [internal-compliance-scan, security-headers-check, nuclei-vulnerability-scan]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Push database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Pushing database migrations via Management API..."
          # Find unapplied migrations and execute via Management API
          for f in supabase/migrations/*.sql; do
            NAME=$(basename "$f")
            echo "  Applying: $NAME"
            SQL=$(cat "$f")
            HTTP_CODE=$(curl -s -o /tmp/migrate_result.json -w "%{http_code}" \
              -X POST "https://api.supabase.com/v1/projects/vmyrivxxibqydccurxug/database/query" \
              -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
              -H "Content-Type: application/json" \
              --data-raw "$(jq -n --arg q "$SQL" '{query: $q}')")
            if [ "$HTTP_CODE" -ge 400 ]; then
              echo "    WARNING: $NAME returned HTTP $HTTP_CODE (may already be applied)"
              cat /tmp/migrate_result.json
            else
              echo "    OK"
            fi
          done
          echo "Migrations complete."

      - name: Deploy Workers
        env:
          CF_REFRESH_TOKEN: ${{ secrets.CLOUDFLARE_OAUTH_REFRESH_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd workers
          npm ci

          # If API Token exists, use wrangler directly
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            npx wrangler deploy
            exit $?
          fi

          # Otherwise: refresh OAuth → get access token → deploy via API
          echo "Refreshing Cloudflare OAuth token..."
          TOKEN_RESP=$(curl -s -X POST "https://dash.cloudflare.com/oauth2/token" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=$CF_REFRESH_TOKEN" \
            -d "client_id=54d11594-84e4-41aa-b438-e81b8fa78ee7")
          CF_TOKEN=$(echo "$TOKEN_RESP" | jq -r '.access_token // empty')
          if [ -z "$CF_TOKEN" ]; then
            echo "FAIL: Could not refresh OAuth token"
            echo "$TOKEN_RESP" | jq .
            exit 1
          fi
          echo "OAuth token refreshed."

          # Build worker with esbuild (same as wrangler does internally)
          npx esbuild src/index.ts --bundle --format=esm --outfile=dist/index.js \
            --external:cloudflare:workers --minify

          # Deploy via Cloudflare API (ES module format)
          echo "Deploying seobaike-remote-control via API..."
          DEPLOY_RESP=$(curl -s -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/workers/scripts/seobaike-remote-control" \
            -H "Authorization: Bearer $CF_TOKEN" \
            -F "index.js=@dist/index.js;type=application/javascript+module" \
            -F 'metadata={"main_module":"index.js","compatibility_date":"2024-01-01","bindings":[{"type":"ai","name":"AI"}]};type=application/json')

          SUCCESS=$(echo "$DEPLOY_RESP" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Workers deployed successfully."
          else
            echo "FAIL: Workers deploy failed"
            echo "$DEPLOY_RESP" | jq .
            exit 1
          fi

      - name: Post-deploy compliance verification
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "============================================================"
          echo "  Post-Deploy Compliance Verification"
          echo "============================================================"
          echo ""
          bash scripts/ci-compliance-check.sh
