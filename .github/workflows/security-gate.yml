name: Security Gate

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  WORKERS_URL: https://seobaike-remote-control.icanforyouthebest.workers.dev

jobs:
  # ── Job 1: Internal Compliance Scan (44-item framework audit) ──
  internal-compliance-scan:
    name: Compliance Scan (5 Frameworks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run full compliance scan via RPC
        id: scan
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: bash scripts/ci-compliance-check.sh

  # ── Job 2: Security Headers Check ──
  security-headers-check:
    name: Security Headers (6/6)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check security headers
        run: bash scripts/ci-headers-check.sh "$WORKERS_URL"

  # ── Job 3: Nuclei Vulnerability Scan ──
  nuclei-vulnerability-scan:
    name: Nuclei CVE Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nuclei
        uses: projectdiscovery/actions/setup/nuclei@v1

      - name: Run Nuclei scan
        id: nuclei
        run: |
          echo "============================================================"
          echo "  Nuclei Vulnerability Scan"
          echo "  Target: $WORKERS_URL"
          echo "============================================================"
          echo ""

          nuclei -u "$WORKERS_URL" \
            -severity critical,high \
            -json-export nuclei-results.json \
            -markdown-export nuclei-report.md \
            -silent \
            || true

          # Count critical/high findings
          CRIT_HIGH=0
          if [ -f nuclei-results.json ]; then
            CRIT_HIGH=$(wc -l < nuclei-results.json)
          fi

          echo ""
          echo "------------------------------------------------------------"
          echo "  Critical/High findings: $CRIT_HIGH"
          echo "------------------------------------------------------------"

          if [ "$CRIT_HIGH" -gt 0 ]; then
            echo ""
            echo "FAIL: $CRIT_HIGH critical/high vulnerabilities found"
            cat nuclei-results.json
            exit 1
          fi

          echo "PASS: 0 critical/high vulnerabilities"

      - name: Upload Nuclei results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-scan-results
          path: |
            nuclei-results.json
            nuclei-report.md
          retention-days: 30
          if-no-files-found: ignore

  # ── Job 4: Deploy (only on push, after all gates pass) ──
  deploy:
    name: Deploy to Production
    needs: [internal-compliance-scan, security-headers-check, nuclei-vulnerability-scan]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Push database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Pushing database migrations via Management API..."
          # Find unapplied migrations and execute via Management API
          for f in supabase/migrations/*.sql; do
            NAME=$(basename "$f")
            echo "  Applying: $NAME"
            SQL=$(cat "$f")
            HTTP_CODE=$(curl -s -o /tmp/migrate_result.json -w "%{http_code}" \
              -X POST "https://api.supabase.com/v1/projects/vmyrivxxibqydccurxug/database/query" \
              -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
              -H "Content-Type: application/json" \
              --data-raw "$(jq -n --arg q "$SQL" '{query: $q}')")
            if [ "$HTTP_CODE" -ge 400 ]; then
              echo "    WARNING: $NAME returned HTTP $HTTP_CODE (may already be applied)"
              cat /tmp/migrate_result.json
            else
              echo "    OK"
            fi
          done
          echo "Migrations complete."

      - name: Setup Wrangler auth
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_REFRESH_TOKEN: ${{ secrets.CLOUDFLARE_OAUTH_REFRESH_TOKEN }}
        run: |
          if [ -n "$CF_API_TOKEN" ]; then
            echo "Using API Token for Wrangler auth"
          else
            echo "Using OAuth refresh token for Wrangler auth"
            mkdir -p "$HOME/.wrangler/config"
            printf 'oauth_token = ""\nexpiration_time = "2000-01-01T00:00:00Z"\nrefresh_token = "%s"\nscopes = ["account:read","user:read","workers:write","workers_kv:write","workers_routes:write","workers_scripts:write","workers_tail:read","d1:write","pages:write","zone:read","ssl_certs:write","ai:write","queues:write","pipelines:write","offline_access"]\n' "$CF_REFRESH_TOKEN" > "$HOME/.wrangler/config/default.toml"
          fi

      - name: Deploy Workers
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          XDG_CONFIG_HOME: ${{ github.workspace }}/.xdg
        run: |
          # Copy wrangler config if using OAuth
          if [ -z "$CLOUDFLARE_API_TOKEN" ] && [ -f "$HOME/.wrangler/config/default.toml" ]; then
            mkdir -p "$XDG_CONFIG_HOME/.wrangler/config"
            cp "$HOME/.wrangler/config/default.toml" "$XDG_CONFIG_HOME/.wrangler/config/default.toml"
          fi
          cd workers
          npm ci
          npx wrangler deploy

      - name: Post-deploy compliance verification
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "============================================================"
          echo "  Post-Deploy Compliance Verification"
          echo "============================================================"
          echo ""
          bash scripts/ci-compliance-check.sh
