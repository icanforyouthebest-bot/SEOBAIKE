<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI æ–‡ä»¶åˆ†æå ±å‘Š â€” SEOBAIKE CaaS</title>
<meta name="description" content="ä¸Šå‚³æ–‡ä»¶ï¼ŒAI è‡ªå‹•ç”¢ç”Ÿçµæ§‹åŒ–åˆ†æå ±å‘Šã€‚å°ˆåˆ© L1-L4 æ¨ç†ç´„æŸï¼Œè·¨åœ‹ç”¢æ¥­å°é½Šã€‚">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#06060f;--surface:#0d0d1a;--card:#12122a;--border:#1e1e3a;
  --text:#e8e8f0;--dim:#8888aa;--accent:#6c5ce7;--green:#00ff88;
  --red:#ff4466;--gold:#ffaa00;--cyan:#00eeff;
}
body{font-family:'Inter','Noto Sans TC',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--cyan);text-decoration:none}
button{cursor:pointer;border:none;font-family:inherit}
.mono{font-family:'JetBrains Mono',monospace}

/* Layout */
.app{max-width:1100px;margin:0 auto;padding:20px}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border);margin-bottom:24px}
.logo{font-size:18px;font-weight:700;letter-spacing:1px}
.logo span{color:var(--accent)}
.user-bar{display:flex;align-items:center;gap:12px}
.credits-badge{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:6px 16px;font-size:13px;display:flex;align-items:center;gap:6px}
.credits-badge .pts{color:var(--gold);font-weight:600}
.btn{padding:8px 20px;border-radius:8px;font-size:14px;font-weight:500;transition:all .2s}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#7c6cf7;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--dim)}
.btn-outline:hover{border-color:var(--accent);color:var(--text)}
.btn-danger{background:var(--red);color:#fff}
.btn-sm{padding:5px 12px;font-size:12px}

/* Auth */
#auth-section{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh}
.auth-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:400px}
.auth-box h2{text-align:center;margin-bottom:8px}
.auth-box p{text-align:center;color:var(--dim);font-size:14px;margin-bottom:24px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;color:var(--dim);margin-bottom:4px}
.form-group input{width:100%;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;outline:none}
.form-group input:focus{border-color:var(--accent)}
.auth-toggle{text-align:center;margin-top:16px;font-size:13px;color:var(--dim)}
.auth-toggle a{cursor:pointer}
.auth-error{color:var(--red);font-size:13px;text-align:center;margin-top:8px;min-height:20px}

/* Main App */
#app-section{display:none}
.tabs{display:flex;gap:4px;margin-bottom:24px;border-bottom:1px solid var(--border);padding-bottom:0}
.tab{padding:10px 20px;font-size:14px;color:var(--dim);background:transparent;border:none;border-bottom:2px solid transparent;transition:all .2s}
.tab.active{color:var(--text);border-bottom-color:var(--accent)}
.tab:hover{color:var(--text)}
.tab-content{display:none}
.tab-content.active{display:block}

/* Upload Zone */
.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:60px 40px;text-align:center;transition:all .3s;cursor:pointer;position:relative}
.upload-zone:hover,.upload-zone.dragover{border-color:var(--accent);background:rgba(108,92,231,0.05)}
.upload-zone svg{width:48px;height:48px;margin-bottom:16px;color:var(--dim)}
.upload-zone h3{margin-bottom:8px;font-size:18px}
.upload-zone p{color:var(--dim);font-size:14px}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.file-info{margin-top:16px;padding:16px;background:var(--surface);border-radius:8px;display:none;text-align:left}
.file-info.show{display:block}
.file-meta{display:flex;gap:16px;flex-wrap:wrap;font-size:13px;color:var(--dim)}
.file-meta span{display:flex;align-items:center;gap:4px}

/* Preview */
.text-preview{margin-top:16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;max-height:200px;overflow-y:auto;font-size:13px;color:var(--dim);white-space:pre-wrap;word-break:break-all;display:none}
.text-preview.show{display:block}

/* Analyze Button */
.analyze-bar{margin-top:20px;display:flex;align-items:center;justify-content:space-between;gap:16px}
.cost-info{font-size:13px;color:var(--dim)}
.cost-info .pts{color:var(--gold);font-weight:600}
#btn-analyze{padding:12px 32px;font-size:16px;font-weight:600;border-radius:10px;background:linear-gradient(135deg,var(--accent),#8b5cf6);color:#fff;transition:all .3s}
#btn-analyze:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(108,92,231,0.4)}
#btn-analyze:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}

/* Progress */
.progress-section{display:none;margin-top:24px;text-align:center}
.progress-section.show{display:block}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.progress-text{color:var(--dim);font-size:14px}

/* Report */
.report-section{display:none;margin-top:24px}
.report-section.show{display:block}
.report-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:16px}
.report-card h3{font-size:15px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.report-card h3 .tag{font-size:11px;padding:2px 8px;border-radius:4px;font-weight:500}
.tag-l1{background:rgba(0,255,136,0.15);color:var(--green)}
.tag-l2{background:rgba(0,238,255,0.15);color:var(--cyan)}
.tag-l3{background:rgba(255,170,0,0.15);color:var(--gold)}
.tag-l4{background:rgba(108,92,231,0.15);color:var(--accent)}
.summary-text{font-size:15px;line-height:1.7;color:var(--text)}
.kv-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.kv-item{background:var(--surface);border-radius:8px;padding:12px 16px}
.kv-item .label{font-size:11px;text-transform:uppercase;color:var(--dim);letter-spacing:1px;margin-bottom:4px}
.kv-item .value{font-size:14px;font-weight:500}
.risk-bar{height:8px;border-radius:4px;background:var(--surface);overflow:hidden;margin-top:8px}
.risk-fill{height:100%;border-radius:4px;transition:width .5s}
.findings-list{list-style:none;padding:0}
.findings-list li{padding:8px 0;border-bottom:1px solid var(--border);font-size:14px;color:var(--text);display:flex;align-items:flex-start;gap:8px}
.findings-list li::before{content:'â†’';color:var(--accent);font-weight:bold;flex-shrink:0}
.trail-step{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.trail-level{font-size:12px;font-weight:600;padding:4px 10px;border-radius:6px;flex-shrink:0;min-width:36px;text-align:center}
.trail-content{flex:1}
.trail-node{font-weight:500;margin-bottom:2px}
.trail-reasoning{font-size:13px;color:var(--dim)}
.country-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.country-card{background:var(--surface);border-radius:8px;padding:12px;text-align:center}
.country-flag{font-size:24px;margin-bottom:4px}
.country-code{font-size:13px;font-weight:600;color:var(--cyan);font-family:'JetBrains Mono',monospace}
.country-name{font-size:12px;color:var(--dim);margin-top:2px}

/* History */
.history-table{width:100%;border-collapse:collapse}
.history-table th{text-align:left;font-size:12px;text-transform:uppercase;color:var(--dim);letter-spacing:1px;padding:8px 12px;border-bottom:1px solid var(--border)}
.history-table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-completed{background:var(--green)}
.status-processing{background:var(--gold)}
.status-failed{background:var(--red)}
.status-pending{background:var(--dim)}
.view-btn{color:var(--cyan);cursor:pointer;font-size:13px}
.view-btn:hover{text-decoration:underline}
.empty-state{text-align:center;padding:60px 20px;color:var(--dim)}

/* Patent Badge */
.patent-bar{text-align:center;padding:16px 0;font-size:12px;color:var(--dim);border-top:1px solid var(--border);margin-top:40px}
.patent-bar span{color:var(--gold)}

/* Responsive */
@media(max-width:768px){
  .app{padding:12px}
  .country-grid{grid-template-columns:repeat(2,1fr)}
  .kv-grid{grid-template-columns:1fr}
  .analyze-bar{flex-direction:column}
  .history-table{font-size:12px}
  .tabs{overflow-x:auto}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">SEO<span>BAIKE</span> <span style="font-size:13px;color:var(--dim);font-weight:400">CaaS Report</span></div>
    <div class="user-bar" id="user-bar" style="display:none">
      <div class="credits-badge">Points: <span class="pts" id="credits-display">â€”</span></div>
      <span id="user-email" style="font-size:13px;color:var(--dim)"></span>
      <button class="btn btn-outline btn-sm" onclick="logout()">ç™»å‡º</button>
    </div>
  </header>

  <!-- Auth -->
  <div id="auth-section">
    <div class="auth-box">
      <h2 id="auth-title">ç™»å…¥</h2>
      <p>ä¸Šå‚³æ–‡ä»¶ï¼ŒAI è‡ªå‹•ç”¢ç”Ÿ L1-L4 çµæ§‹åŒ–åˆ†æå ±å‘Š</p>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="auth-email" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label>å¯†ç¢¼</label>
        <input type="password" id="auth-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-primary" style="width:100%;padding:12px" id="auth-btn" onclick="handleAuth()">ç™»å…¥</button>
      <div class="auth-error" id="auth-error"></div>
      <div class="auth-toggle">
        <span id="auth-toggle-text">æ²’æœ‰å¸³è™Ÿï¼Ÿ</span>
        <a id="auth-toggle-link" onclick="toggleAuth()">è¨»å†Š</a>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app-section">
    <div class="tabs">
      <button class="tab active" data-tab="upload" onclick="switchTab('upload')">ä¸Šå‚³åˆ†æ</button>
      <button class="tab" data-tab="history" onclick="switchTab('history')">æ­·å²å ±å‘Š</button>
    </div>

    <!-- Upload Tab -->
    <div class="tab-content active" id="tab-upload">
      <div class="upload-zone" id="upload-zone">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 16V4m0 0L8 8m4-4l4 4M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"/></svg>
        <h3>æ‹–æ›³æª”æ¡ˆåˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡</h3>
        <p>æ”¯æ´ PDF / TXT / CSV / Word (.docx)</p>
        <input type="file" id="file-input" accept=".pdf,.txt,.csv,.docx,.doc,.xlsx,.xls">
      </div>

      <div class="file-info" id="file-info">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong id="file-name-display"></strong>
          <button class="btn btn-outline btn-sm" onclick="clearFile()">ç§»é™¤</button>
        </div>
        <div class="file-meta">
          <span>é¡å‹: <strong id="file-type-display"></strong></span>
          <span>å¤§å°: <strong id="file-size-display"></strong></span>
          <span>å­—å…ƒ: <strong id="file-chars-display"></strong></span>
        </div>
      </div>

      <div class="text-preview" id="text-preview"></div>

      <div class="analyze-bar">
        <div class="cost-info">æ¶ˆè€— <span class="pts" id="cost-display">50</span> SEO Points</div>
        <button id="btn-analyze" class="btn" disabled onclick="runAnalysis()">é–‹å§‹åˆ†æ</button>
      </div>

      <div class="progress-section" id="progress-section">
        <div class="spinner"></div>
        <div class="progress-text" id="progress-text">æ­£åœ¨åˆ†ææ–‡ä»¶...</div>
      </div>

      <div class="report-section" id="report-section"></div>
    </div>

    <!-- History Tab -->
    <div class="tab-content" id="tab-history">
      <div id="history-content"><div class="empty-state">è¼‰å…¥ä¸­...</div></div>
    </div>
  </div>

  <div class="patent-bar">
    <span>Patent 115100981</span> â€” ä¸–ç•Œå®šç¾©ç´„æŸæ³•ç”¨æ–¼AIæ¨ç† â€” å°è·¯å…‰æœ‰é™å…¬å¸ çµ±ç·¨ 60475510
  </div>
</div>

<script>
const SUPABASE_URL = 'https://vmyrivxxibqydccurxug.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteXJpdnh4aWJxeWRjY3VyeHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkyNjMxMTIsImV4cCI6MjA1NDgzOTExMn0.Nr5xN2c0vqOKToB2EcEyRHb_FBqcJD3f5NtZ0CZ5nFc'
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let currentUser = null
let extractedText = ''
let currentFile = null

// ============================================================
// Auth
// ============================================================
let isLogin = true

async function init() {
  const { data: { session } } = await sb.auth.getSession()
  if (session) {
    currentUser = session.user
    showApp()
  }
  sb.auth.onAuthStateChange((event, session) => {
    if (session) {
      currentUser = session.user
      showApp()
    } else {
      currentUser = null
      showAuth()
    }
  })
}

function toggleAuth() {
  isLogin = !isLogin
  document.getElementById('auth-title').textContent = isLogin ? 'ç™»å…¥' : 'è¨»å†Š'
  document.getElementById('auth-btn').textContent = isLogin ? 'ç™»å…¥' : 'è¨»å†Š'
  document.getElementById('auth-toggle-text').textContent = isLogin ? 'æ²’æœ‰å¸³è™Ÿï¼Ÿ' : 'å·²æœ‰å¸³è™Ÿï¼Ÿ'
  document.getElementById('auth-toggle-link').textContent = isLogin ? 'è¨»å†Š' : 'ç™»å…¥'
  document.getElementById('auth-error').textContent = ''
}

async function handleAuth() {
  const email = document.getElementById('auth-email').value.trim()
  const password = document.getElementById('auth-password').value
  const errEl = document.getElementById('auth-error')
  errEl.textContent = ''

  if (!email || !password) { errEl.textContent = 'è«‹å¡«å…¥ Email å’Œå¯†ç¢¼'; return }
  if (password.length < 6) { errEl.textContent = 'å¯†ç¢¼è‡³å°‘ 6 ä½'; return }

  const btn = document.getElementById('auth-btn')
  btn.disabled = true
  btn.textContent = 'è™•ç†ä¸­...'

  try {
    if (isLogin) {
      const { error } = await sb.auth.signInWithPassword({ email, password })
      if (error) throw error
    } else {
      const { error } = await sb.auth.signUp({ email, password })
      if (error) throw error
      errEl.style.color = 'var(--green)'
      errEl.textContent = 'è¨»å†ŠæˆåŠŸï¼è«‹æŸ¥çœ‹ä¿¡ç®±ç¢ºèªå¾Œç™»å…¥ã€‚'
      btn.disabled = false
      btn.textContent = 'è¨»å†Š'
      return
    }
  } catch (e) {
    errEl.style.color = 'var(--red)'
    errEl.textContent = e.message || 'èªè­‰å¤±æ•—'
  }
  btn.disabled = false
  btn.textContent = isLogin ? 'ç™»å…¥' : 'è¨»å†Š'
}

async function logout() {
  await sb.auth.signOut()
  showAuth()
}

function showAuth() {
  document.getElementById('auth-section').style.display = 'flex'
  document.getElementById('app-section').style.display = 'none'
  document.getElementById('user-bar').style.display = 'none'
}

function showApp() {
  document.getElementById('auth-section').style.display = 'none'
  document.getElementById('app-section').style.display = 'block'
  document.getElementById('user-bar').style.display = 'flex'
  document.getElementById('user-email').textContent = currentUser.email
  loadCredits()
}

async function loadCredits() {
  try {
    const { data: { session } } = await sb.auth.getSession()
    if (!session) return
    const res = await fetch(`${SUPABASE_URL}/functions/v1/analyze-document?action=credits`, {
      headers: { 'Authorization': `Bearer ${session.access_token}`, 'Content-Type': 'application/json' }
    })
    const d = await res.json()
    document.getElementById('credits-display').textContent = d.credits?.balance ?? 'â€”'
  } catch { document.getElementById('credits-display').textContent = 'â€”' }
}

// ============================================================
// File Handling
// ============================================================
const zone = document.getElementById('upload-zone')
const fileInput = document.getElementById('file-input')

zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover') })
zone.addEventListener('dragleave', () => zone.classList.remove('dragover'))
zone.addEventListener('drop', e => {
  e.preventDefault()
  zone.classList.remove('dragover')
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0])
})
fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]) })

async function handleFile(file) {
  currentFile = file
  const ext = file.name.split('.').pop().toLowerCase()

  document.getElementById('file-info').classList.add('show')
  document.getElementById('file-name-display').textContent = file.name
  document.getElementById('file-type-display').textContent = ext.toUpperCase()
  document.getElementById('file-size-display').textContent = formatBytes(file.size)

  extractedText = ''

  try {
    if (['txt', 'csv'].includes(ext)) {
      extractedText = await file.text()
    } else if (ext === 'pdf') {
      extractedText = await extractPDF(file)
    } else if (['doc', 'docx'].includes(ext)) {
      extractedText = await extractDocx(file)
    } else if (['xls', 'xlsx'].includes(ext)) {
      extractedText = `[Excel file: ${file.name}, ${formatBytes(file.size)}]\n(Excel text extraction - content will be analyzed by AI)`
    } else {
      extractedText = await file.text()
    }
  } catch (e) {
    extractedText = `[File: ${file.name}] Error extracting text: ${e.message}`
  }

  document.getElementById('file-chars-display').textContent = extractedText.length.toLocaleString()

  const preview = document.getElementById('text-preview')
  preview.textContent = extractedText.substring(0, 2000) + (extractedText.length > 2000 ? '\n...(truncated)' : '')
  preview.classList.add('show')

  const cost = extractedText.length > 5000 ? 100 : 50
  document.getElementById('cost-display').textContent = cost
  document.getElementById('btn-analyze').disabled = extractedText.length < 10

  document.getElementById('report-section').classList.remove('show')
  document.getElementById('report-section').innerHTML = ''
}

async function extractPDF(file) {
  const arrayBuffer = await file.arrayBuffer()
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise
  let text = ''
  for (let i = 1; i <= Math.min(pdf.numPages, 50); i++) {
    const page = await pdf.getPage(i)
    const content = await page.getTextContent()
    text += content.items.map(item => item.str).join(' ') + '\n'
  }
  return text.trim() || '[PDF content could not be extracted as text]'
}

async function extractDocx(file) {
  const arrayBuffer = await file.arrayBuffer()
  const uint8 = new Uint8Array(arrayBuffer)
  let text = ''
  let inTag = false
  for (let i = 0; i < uint8.length; i++) {
    const c = uint8[i]
    if (c === 60) { inTag = true; continue }
    if (c === 62) { inTag = false; continue }
    if (!inTag && c >= 32 && c < 127) text += String.fromCharCode(c)
  }
  return text.trim() || `[DOCX file: ${file.name}]`
}

function clearFile() {
  currentFile = null
  extractedText = ''
  fileInput.value = ''
  document.getElementById('file-info').classList.remove('show')
  document.getElementById('text-preview').classList.remove('show')
  document.getElementById('btn-analyze').disabled = true
  document.getElementById('report-section').classList.remove('show')
  document.getElementById('report-section').innerHTML = ''
}

// ============================================================
// Analysis
// ============================================================
async function runAnalysis() {
  if (!extractedText || extractedText.length < 10) return

  const btn = document.getElementById('btn-analyze')
  btn.disabled = true
  document.getElementById('progress-section').classList.add('show')
  document.getElementById('progress-text').textContent = 'æ­£åœ¨é€£æ¥ AI åˆ†æå¼•æ“ (L1-L4 ç´„æŸæ¨ç†)...'

  try {
    const { data: { session } } = await sb.auth.getSession()
    if (!session) throw new Error('Not authenticated')

    const res = await fetch(`${SUPABASE_URL}/functions/v1/analyze-document?action=analyze`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${session.access_token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        file_name: currentFile.name,
        file_type: currentFile.name.split('.').pop().toLowerCase(),
        file_size: currentFile.size,
        text_content: extractedText,
      }),
    })

    const data = await res.json()

    if (!res.ok) {
      if (res.status === 402) {
        alert(`é»æ•¸ä¸è¶³ï¼é¤˜é¡: ${data.balance}ï¼Œéœ€è¦: ${data.required}\nè«‹è³¼è²·æ›´å¤š SEO Pointsã€‚`)
      } else {
        alert(`åˆ†æå¤±æ•—: ${data.error || 'Unknown error'}`)
      }
      return
    }

    document.getElementById('credits-display').textContent = data.credits_remaining ?? 'â€”'
    renderReport(data.report)
  } catch (e) {
    alert('åˆ†æå¤±æ•—: ' + e.message)
  } finally {
    document.getElementById('progress-section').classList.remove('show')
    btn.disabled = false
  }
}

function renderReport(r) {
  const report = r.ai_full_report || {}
  const section = document.getElementById('report-section')

  const riskColor = (r.risk_score || 0) < 30 ? 'var(--green)' : (r.risk_score || 0) < 60 ? 'var(--gold)' : 'var(--red)'

  let html = `
    <div class="report-card">
      <h3>æ‘˜è¦</h3>
      <div class="summary-text">${esc(r.ai_summary || report.summary || 'â€”')}</div>
    </div>

    <div class="report-card">
      <h3>ç”¢æ¥­åˆ†é¡ (L1-L4 ç´„æŸå±¤ç´š)</h3>
      <div class="kv-grid">
        <div class="kv-item"><div class="label" style="color:var(--green)">L1 å¯¦é«”ä¸–ç•Œ</div><div class="value">${esc(r.industry_l1 || 'â€”')}</div></div>
        <div class="kv-item"><div class="label" style="color:var(--cyan)">L2 å•†æ¥­é‚è¼¯</div><div class="value">${esc(r.industry_l2 || 'â€”')}</div></div>
        <div class="kv-item"><div class="label" style="color:var(--gold)">L3 å®‰å…¨å±¤</div><div class="value">${esc(r.industry_l3 || 'â€”')}</div></div>
        <div class="kv-item"><div class="label" style="color:var(--accent)">L4 æŒ‡æ®å±¤</div><div class="value">${esc(r.industry_l4 || 'â€”')}</div></div>
      </div>
    </div>

    <div class="report-card">
      <h3>å…¨çƒç”¢æ¥­å°é½Š (è·¨åœ‹ä»£ç¢¼)</h3>
      <div class="country-grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr))">
        ${renderAllCountries(r.cross_country || {})}
      </div>
    </div>

    <div class="report-card">
      <h3>é¢¨éšªè©•åˆ†</h3>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
        <div style="font-size:32px;font-weight:700;color:${riskColor}" class="mono">${(r.risk_score || 0).toFixed(0)}</div>
        <div style="flex:1">
          <div class="risk-bar"><div class="risk-fill" style="width:${r.risk_score || 0}%;background:${riskColor}"></div></div>
        </div>
      </div>
      ${(report.risk_factors || []).length ? `<ul class="findings-list">${(report.risk_factors || []).map(f => `<li>${esc(f)}</li>`).join('')}</ul>` : ''}
    </div>`

  if ((report.key_findings || []).length) {
    html += `<div class="report-card"><h3>é—œéµç™¼ç¾</h3><ul class="findings-list">${report.key_findings.map(f => `<li>${esc(f)}</li>`).join('')}</ul></div>`
  }

  // Inference Trail (Patent Core)
  const trail = r.inference_trail || report.inference_trail || []
  if (trail.length) {
    const levelColors = { L1: 'var(--green)', L2: 'var(--cyan)', L3: 'var(--gold)', L4: 'var(--accent)' }
    const levelBgs = { L1: 'rgba(0,255,136,0.15)', L2: 'rgba(0,238,255,0.15)', L3: 'rgba(255,170,0,0.15)', L4: 'rgba(108,92,231,0.15)' }
    html += `<div class="report-card"><h3>æ¨ç†è·¯å¾‘è¿½æº¯ <span class="tag tag-l4">Patent 115100981</span></h3>`
    for (const step of trail) {
      const lvl = step.level || '?'
      html += `<div class="trail-step">
        <div class="trail-level" style="background:${levelBgs[lvl] || '#333'};color:${levelColors[lvl] || '#fff'}">${lvl}</div>
        <div class="trail-content">
          <div class="trail-node">${esc(step.node || 'â€”')}</div>
          <div class="trail-reasoning">${esc(step.reasoning || '')}</div>
        </div>
      </div>`
    }
    html += `</div>`
  }

  if ((report.compliance_flags || []).length) {
    html += `<div class="report-card"><h3>åˆè¦è­¦ç¤º</h3><ul class="findings-list">${report.compliance_flags.map(f => `<li style="color:var(--gold)">${esc(f)}</li>`).join('')}</ul></div>`
  }

  if ((report.recommendations || []).length) {
    html += `<div class="report-card"><h3>å»ºè­°è¡Œå‹•</h3><ul class="findings-list">${report.recommendations.map(f => `<li>${esc(f)}</li>`).join('')}</ul></div>`
  }

  section.innerHTML = html
  section.classList.add('show')
  section.scrollIntoView({ behavior: 'smooth', block: 'start' })
}

const FLAG_MAP = {
  intl:'ğŸŒ',tw:'ğŸ‡¹ğŸ‡¼',us:'ğŸ‡ºğŸ‡¸',eu:'ğŸ‡ªğŸ‡º',jp:'ğŸ‡¯ğŸ‡µ',cn:'ğŸ‡¨ğŸ‡³',kr:'ğŸ‡°ğŸ‡·',
  uk:'ğŸ‡¬ğŸ‡§',de:'ğŸ‡©ğŸ‡ª',fr:'ğŸ‡«ğŸ‡·',in:'ğŸ‡®ğŸ‡³',br:'ğŸ‡§ğŸ‡·',au:'ğŸ‡¦ğŸ‡º',ca:'ğŸ‡¨ğŸ‡¦',
  sg:'ğŸ‡¸ğŸ‡¬',hk:'ğŸ‡­ğŸ‡°',th:'ğŸ‡¹ğŸ‡­',vn:'ğŸ‡»ğŸ‡³',id:'ğŸ‡®ğŸ‡©',my:'ğŸ‡²ğŸ‡¾',ph:'ğŸ‡µğŸ‡­',
  mx:'ğŸ‡²ğŸ‡½',sa:'ğŸ‡¸ğŸ‡¦',ae:'ğŸ‡¦ğŸ‡ª',il:'ğŸ‡®ğŸ‡±',ru:'ğŸ‡·ğŸ‡º',za:'ğŸ‡¿ğŸ‡¦',se:'ğŸ‡¸ğŸ‡ª',
  nl:'ğŸ‡³ğŸ‡±',ch:'ğŸ‡¨ğŸ‡­',es:'ğŸ‡ªğŸ‡¸',it:'ğŸ‡®ğŸ‡¹',pl:'ğŸ‡µğŸ‡±',tr:'ğŸ‡¹ğŸ‡·',ar:'ğŸ‡¦ğŸ‡·',
  cl:'ğŸ‡¨ğŸ‡±',co:'ğŸ‡¨ğŸ‡´',eg:'ğŸ‡ªğŸ‡¬',ng:'ğŸ‡³ğŸ‡¬',ke:'ğŸ‡°ğŸ‡ª',nz:'ğŸ‡³ğŸ‡¿',no:'ğŸ‡³ğŸ‡´',
}
function renderAllCountries(cc) {
  return Object.entries(cc).filter(([k,v]) => v && typeof v === 'object').map(([k,v]) => {
    const flag = FLAG_MAP[k.toLowerCase()] || 'ğŸ³ï¸'
    return `<div class="country-card">
      <div class="country-flag">${flag}</div>
      <div style="font-weight:600;font-size:13px">${k.toUpperCase()}</div>
      <div class="country-code">${esc(v.code || 'â€”')}</div>
      <div class="country-name">${esc(v.name || 'â€”')}</div>
      ${v.system ? `<div style="font-size:10px;color:var(--dim);margin-top:2px">${esc(v.system)}</div>` : ''}
    </div>`
  }).join('')
}

// ============================================================
// History
// ============================================================
async function loadHistory() {
  const container = document.getElementById('history-content')
  try {
    const { data: { session } } = await sb.auth.getSession()
    if (!session) return

    const res = await fetch(`${SUPABASE_URL}/functions/v1/analyze-document?action=list`, {
      headers: { 'Authorization': `Bearer ${session.access_token}` }
    })
    const d = await res.json()
    const reports = d.reports || []

    if (!reports.length) {
      container.innerHTML = '<div class="empty-state">å°šç„¡åˆ†æå ±å‘Šã€‚ä¸Šå‚³ä¸€ä»½æ–‡ä»¶é–‹å§‹å§ï¼</div>'
      return
    }

    let html = `<table class="history-table"><thead><tr><th>ç‹€æ…‹</th><th>æª”æ¡ˆåç¨±</th><th>ç”¢æ¥­åˆ†é¡</th><th>é¢¨éšª</th><th>é»æ•¸</th><th>æ™‚é–“</th><th></th></tr></thead><tbody>`
    for (const r of reports) {
      const statusClass = `status-${r.status}`
      const riskColor = (r.risk_score || 0) < 30 ? 'var(--green)' : (r.risk_score || 0) < 60 ? 'var(--gold)' : 'var(--red)'
      html += `<tr>
        <td><span class="status-dot ${statusClass}"></span>${r.status}</td>
        <td>${esc(r.file_name)}</td>
        <td>${esc(r.industry_l1 || 'â€”')}</td>
        <td style="color:${riskColor}" class="mono">${r.risk_score ? r.risk_score.toFixed(0) : 'â€”'}</td>
        <td class="mono">${r.points_cost}</td>
        <td style="color:var(--dim)">${new Date(r.created_at).toLocaleString('zh-TW')}</td>
        <td>${r.status === 'completed' ? `<span class="view-btn" onclick="viewReport('${r.id}')">æŸ¥çœ‹</span>` : ''}</td>
      </tr>`
    }
    html += '</tbody></table>'
    container.innerHTML = html
  } catch (e) {
    container.innerHTML = `<div class="empty-state">è¼‰å…¥å¤±æ•—: ${e.message}</div>`
  }
}

async function viewReport(id) {
  try {
    const { data: { session } } = await sb.auth.getSession()
    const res = await fetch(`${SUPABASE_URL}/functions/v1/analyze-document?action=report&id=${id}`, {
      headers: { 'Authorization': `Bearer ${session.access_token}` }
    })
    const d = await res.json()
    if (d.report) {
      switchTab('upload')
      renderReport(d.report)
    }
  } catch (e) { alert('è¼‰å…¥å ±å‘Šå¤±æ•—: ' + e.message) }
}

// ============================================================
// Tabs
// ============================================================
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name))
  document.querySelectorAll('.tab-content').forEach(t => t.classList.toggle('active', t.id === `tab-${name}`))
  if (name === 'history') loadHistory()
}

// ============================================================
// Utils
// ============================================================
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML }
function formatBytes(b) { if (b < 1024) return b + ' B'; if (b < 1048576) return (b/1024).toFixed(1) + ' KB'; return (b/1048576).toFixed(1) + ' MB' }

init()
</script>
</body>
</html>
