<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="戰情室">
<meta name="theme-color" content="#000000">
<link rel="icon" href="/favicon.svg">
<title>指揮官戰情室 | SEOBAIKE WAR ROOM</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;600;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#000;--card:rgba(8,12,20,0.92);
  --green:#00ff88;--g2:#00cc6a;
  --red:#ff2244;--r2:#cc1133;
  --blue:#00aaff;--b2:#0066cc;
  --gold:#ffaa00;--purple:#aa44ff;--cyan:#00eeff;
  --white:#e8e8e8;--dim:rgba(255,255,255,0.08);
}
html,body{height:100%;overflow:hidden}
body{background:#000;color:var(--white);font-family:'JetBrains Mono','Noto Sans TC',monospace}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--green);border-radius:3px}
::-webkit-scrollbar-track{background:transparent}

/* === BACKGROUND EFFECTS === */
#matrix{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;opacity:0.04}
.grid-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1;pointer-events:none;
  background-image:linear-gradient(rgba(0,255,136,0.01) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,136,0.01) 1px,transparent 1px);
  background-size:60px 60px}
.hud-border{position:fixed;top:0;left:0;right:0;bottom:0;z-index:2;pointer-events:none;border:1px solid rgba(0,255,136,0.05)}
.hud-c{position:absolute;width:24px;height:24px}
.hud-c.tl{top:0;left:0;border-top:2px solid var(--green);border-left:2px solid var(--green)}
.hud-c.tr{top:0;right:0;border-top:2px solid var(--green);border-right:2px solid var(--green)}
.hud-c.bl{bottom:0;left:0;border-bottom:2px solid var(--green);border-left:2px solid var(--green)}
.hud-c.br{bottom:0;right:0;border-bottom:2px solid var(--green);border-right:2px solid var(--green)}
.scanline{position:fixed;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--green),transparent);z-index:999;pointer-events:none;animation:scan 8s linear infinite;opacity:0.15}
@keyframes scan{0%{top:-2px}100%{top:100vh}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes glow{0%,100%{text-shadow:0 0 20px rgba(255,170,0,0.3)}50%{text-shadow:0 0 40px rgba(255,170,0,0.6)}}
@keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
@keyframes pulseRing{0%,100%{box-shadow:0 0 10px rgba(0,255,136,0.2)}50%{box-shadow:0 0 25px rgba(0,255,136,0.5)}}

/* === APP LAYOUT === */
.app{position:relative;z-index:10;height:100vh;display:grid;
  grid-template-rows:48px 28px 1fr 32px;grid-template-columns:1fr;overflow:hidden}

/* === TOPBAR === */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 16px;
  background:rgba(0,0,0,0.95);border-bottom:1px solid rgba(0,255,136,0.15)}
.tb-left{display:flex;align-items:center;gap:12px}
.tb-right{display:flex;align-items:center;gap:14px}
.brand{font-family:'Orbitron',monospace;font-size:13px;font-weight:900;letter-spacing:3px;
  color:var(--green);text-shadow:0 0 20px rgba(0,255,136,0.3)}
.brand sub{font-size:8px;color:var(--gold);font-weight:400;letter-spacing:1px;margin-left:6px}
.status-lights{display:flex;gap:10px;align-items:center}
.s-light{display:flex;align-items:center;gap:4px;font-size:8px;letter-spacing:1px;color:rgba(255,255,255,0.4)}
.s-dot{width:7px;height:7px;border-radius:50%}
.s-dot.on{background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
.s-dot.off{background:var(--red);box-shadow:0 0 8px var(--red)}
.s-dot.warn{background:var(--gold);box-shadow:0 0 8px var(--gold);animation:pulse 1.5s infinite}
.clock-box{font-size:9px;color:rgba(255,255,255,0.35);text-align:right;line-height:1.3}
.cmd-name{font-family:'Noto Sans TC';font-size:11px;font-weight:700;color:var(--gold);
  text-shadow:0 0 10px rgba(255,170,0,0.2);animation:glow 4s infinite}
.sound-btn{background:none;border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.4);
  padding:2px 6px;border-radius:3px;cursor:pointer;font-size:12px}
.sound-btn.on{border-color:var(--green);color:var(--green)}

/* === PATENT STRIP === */
.patent-strip{display:flex;align-items:center;justify-content:center;padding:0 16px;
  background:linear-gradient(180deg,rgba(0,255,136,0.02),transparent);
  border-bottom:1px solid rgba(0,255,136,0.06);gap:16px}
.patent-text{font-family:'Orbitron';font-size:8px;letter-spacing:2px;color:var(--gold);animation:glow 4s infinite}
.patent-sep{color:rgba(255,170,0,0.15);font-size:8px}

/* === MAIN CONTENT === */
.main{display:grid;grid-template-columns:200px 1fr 260px;overflow:hidden;gap:0}

/* === LEFT COLUMN === */
.left-col{display:flex;flex-direction:column;gap:6px;padding:8px;overflow-y:auto;
  border-right:1px solid rgba(0,255,136,0.06);background:rgba(0,0,0,0.3)}
.section-label{font-family:'Orbitron';font-size:8px;letter-spacing:2px;color:rgba(255,255,255,0.25);
  text-transform:uppercase;padding:4px 0 2px}
.health-item{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px}
.health-item .h-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.health-item .h-name{flex:1;color:rgba(255,255,255,0.5);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.health-item .h-val{font-family:'Orbitron';font-size:9px;min-width:35px;text-align:right}
.gauge-box{position:relative;text-align:center;padding:4px 0}
.gauge-box canvas{display:block;margin:0 auto}
.gauge-center{position:absolute;left:50%;transform:translateX(-50%);font-family:'Orbitron';font-weight:900}
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.kpi-card{background:rgba(0,0,0,0.4);border:1px solid var(--dim);border-radius:4px;padding:6px 4px;text-align:center}
.kpi-val{font-family:'Orbitron';font-size:16px;font-weight:900;line-height:1}
.kpi-label{font-size:7px;letter-spacing:1px;color:rgba(255,255,255,0.3);margin-top:2px;text-transform:uppercase}

/* === CENTER === */
.center-col{display:flex;flex-direction:column;overflow:hidden}
.map-container{flex:1;position:relative;min-height:0;cursor:pointer;border-bottom:1px solid rgba(0,255,136,0.06)}
.map-container canvas{width:100%;height:100%;display:block}
.center-bottom{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;height:260px;flex-shrink:0}
.cb-panel{border-right:1px solid rgba(0,255,136,0.06);padding:8px;overflow:hidden;cursor:pointer;
  transition:background .2s}
.cb-panel:last-child{border-right:none}
.cb-panel:hover{background:rgba(0,255,136,0.02)}
.cb-title{font-family:'Orbitron';font-size:8px;letter-spacing:2px;color:rgba(255,255,255,0.3);
  margin-bottom:6px;text-transform:uppercase}
.provider-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:3px}
.prov-cell{width:100%;aspect-ratio:1;border-radius:3px;position:relative;cursor:pointer;transition:transform .1s}
.prov-cell:hover{transform:scale(1.3);z-index:5}
.prov-cell .prov-tip{display:none;position:absolute;bottom:110%;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.95);border:1px solid var(--green);border-radius:4px;padding:4px 8px;
  font-size:8px;white-space:nowrap;z-index:10;pointer-events:none}
.prov-cell:hover .prov-tip{display:block}
.mini-graph-wrap{position:relative;height:100%}
.mini-graph-wrap canvas{width:100%;height:100%;display:block}
.shield-box{text-align:center;display:flex;flex-direction:column;align-items:center;gap:6px}
.shield-ring-sm{width:70px;height:70px;border-radius:50%;border:2px solid var(--green);
  display:flex;align-items:center;justify-content:center;position:relative;
  box-shadow:0 0 20px rgba(0,255,136,0.1),inset 0 0 20px rgba(0,255,136,0.05);animation:pulseRing 3s infinite}
.shield-score-sm{font-family:'Orbitron';font-size:24px;font-weight:900;color:var(--green)}
.defense-dots{display:flex;gap:3px;flex-wrap:wrap;justify-content:center}
.d-dot{width:10px;height:10px;border-radius:2px;background:rgba(0,255,136,0.2);border:1px solid var(--green)}
.d-dot.active{background:var(--green);box-shadow:0 0 4px var(--green)}
.rls-bar{width:100%;height:4px;background:rgba(255,255,255,0.05);border-radius:2px;overflow:hidden;margin-top:4px}
.rls-fill{height:100%;background:var(--green);border-radius:2px;transition:width .5s}

/* === RIGHT COLUMN === */
.right-col{display:flex;flex-direction:column;overflow:hidden;
  border-left:1px solid rgba(0,255,136,0.06);background:rgba(0,0,0,0.3)}
.feed-section{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:8px}
.feed-section.alerts{flex:0 0 40%;border-top:1px solid rgba(0,255,136,0.06)}
.feed-section.activity{flex:0 0 60%}
.feed-header{font-family:'Orbitron';font-size:8px;letter-spacing:2px;color:rgba(255,255,255,0.25);
  text-transform:uppercase;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.feed-count{font-size:8px;color:var(--green);background:rgba(0,255,136,0.1);padding:1px 6px;border-radius:3px}
.feed-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:3px}
.feed-item{background:rgba(0,0,0,0.3);border-radius:4px;padding:6px 8px;font-size:9px;
  border-left:3px solid var(--dim);animation:slideIn .3s ease-out}
.feed-item.new{border-left-color:var(--green);background:rgba(0,255,136,0.03)}
.feed-item.alert-red{border-left-color:var(--red)}
.feed-item.alert-gold{border-left-color:var(--gold)}
.feed-item.alert-purple{border-left-color:var(--purple)}

/* === BOTTOM BAR === */
.bottombar{display:flex;align-items:center;justify-content:space-between;padding:0 16px;
  background:rgba(0,0,0,0.95);border-top:1px solid rgba(0,255,136,0.12)}
.bb-actions{display:flex;gap:6px}
.bb-btn{background:none;border:1px solid;padding:4px 12px;border-radius:4px;font-size:9px;
  font-family:'Orbitron';letter-spacing:1px;cursor:pointer;font-weight:700;transition:all .15s}
.bb-btn:hover{filter:brightness(1.3)}
.bb-btn.purge{color:var(--red);border-color:rgba(255,34,68,0.3)}
.bb-btn.purge:hover{background:rgba(255,34,68,0.1)}
.bb-btn.report{color:var(--blue);border-color:rgba(0,170,255,0.3)}
.bb-btn.report:hover{background:rgba(0,170,255,0.1)}
.bb-btn.defense{color:var(--gold);border-color:rgba(255,170,0,0.3)}
.bb-btn.defense:hover{background:rgba(255,170,0,0.1)}
.bb-status{font-size:8px;color:rgba(255,255,255,0.2);letter-spacing:1px}
.bb-patent{font-family:'Orbitron';font-size:7px;color:rgba(255,170,0,0.25);letter-spacing:1px}

/* === DRILL-DOWN OVERLAY === */
.drill-overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:1000;display:none;
  align-items:center;justify-content:center;background:rgba(0,0,0,0.85);backdrop-filter:blur(4px)}
.drill-overlay.open{display:flex}
.drill-panel{width:80vw;height:80vh;background:var(--card);border:1px solid rgba(0,255,136,0.15);
  border-radius:8px;overflow:hidden;display:flex;flex-direction:column;
  animation:fadeIn .25s ease-out;box-shadow:0 0 60px rgba(0,255,136,0.05)}
.drill-head{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;
  background:rgba(0,255,136,0.03);border-bottom:1px solid rgba(0,255,136,0.08)}
.drill-title{font-family:'Orbitron';font-size:12px;font-weight:700;letter-spacing:3px;color:var(--green)}
.drill-close{background:none;border:1px solid rgba(255,255,255,0.1);color:var(--white);
  width:32px;height:32px;border-radius:4px;cursor:pointer;font-size:16px;transition:all .15s}
.drill-close:hover{border-color:var(--red);color:var(--red)}
.drill-body{flex:1;overflow-y:auto;padding:20px}
.drill-body .stat{background:rgba(0,0,0,0.4);border-radius:6px;padding:14px 10px;text-align:center;border:1px solid var(--dim)}
.drill-body .stat-val{font-family:'Orbitron';font-size:26px;font-weight:900;line-height:1}
.drill-body .stat-label{font-size:9px;letter-spacing:2px;color:rgba(255,255,255,0.3);margin-top:6px;text-transform:uppercase}
.drill-body .row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:11px}
.drill-body .row:last-child{border:none}
.drill-body .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.drill-body .dot-g{background:var(--green);box-shadow:0 0 6px var(--green)}
.drill-body .dot-r{background:var(--red);box-shadow:0 0 6px var(--red)}
.drill-body .dot-y{background:var(--gold);box-shadow:0 0 6px var(--gold)}
.drill-body .bar-row{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:11px}
.drill-body .bar-label{width:100px;color:rgba(255,255,255,0.4);font-size:10px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.drill-body .bar-wrap{flex:1;height:5px;background:rgba(255,255,255,0.04);border-radius:3px;overflow:hidden}
.drill-body .bar-fill{height:100%;border-radius:3px}
.drill-body .bar-val{width:60px;text-align:right;font-family:'Orbitron';font-size:10px}
.g2d{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.g3d{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.g4d{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
.drill-section{margin-bottom:20px}
.drill-section-title{font-family:'Orbitron';font-size:9px;letter-spacing:2px;color:rgba(255,255,255,0.3);
  margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--dim);text-transform:uppercase}

/* === CONFIRM DIALOG === */
.confirm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:2000;display:none;
  align-items:center;justify-content:center;background:rgba(0,0,0,0.9)}
.confirm-overlay.open{display:flex}
.confirm-box{background:var(--card);border:2px solid var(--red);border-radius:8px;padding:24px;
  text-align:center;max-width:360px;animation:fadeIn .2s}
.confirm-box h3{font-family:'Orbitron';color:var(--red);margin-bottom:12px;letter-spacing:2px}
.confirm-box p{font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:16px}
.confirm-btns{display:flex;gap:10px;justify-content:center}
.confirm-btns button{padding:8px 20px;border-radius:4px;font-family:'Orbitron';font-size:10px;
  letter-spacing:1px;cursor:pointer;font-weight:700}
.confirm-yes{background:var(--red);border:none;color:#fff}
.confirm-no{background:none;border:1px solid rgba(255,255,255,0.2);color:var(--white)}

/* === RESPONSIVE === */
@media(max-width:1200px){
  .main{grid-template-columns:160px 1fr 220px}
  .center-bottom{height:220px}
}
@media(max-width:768px){
  .app{grid-template-rows:48px 28px 1fr 32px}
  .main{grid-template-columns:1fr;grid-template-rows:auto;overflow-y:auto}
  .left-col{flex-direction:row;flex-wrap:wrap;border-right:none;border-bottom:1px solid rgba(0,255,136,0.06);
    overflow-y:visible;padding:8px}
  .left-col>*{flex:1;min-width:140px}
  .center-col{min-height:500px}
  .map-container{min-height:250px}
  .center-bottom{height:auto;grid-template-columns:1fr 1fr}
  .right-col{border-left:none;border-top:1px solid rgba(0,255,136,0.06);min-height:300px}
  .feed-section.activity,.feed-section.alerts{flex:1}
  html,body{overflow:auto}
}
.spin{display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,0.1);border-top-color:var(--green);border-radius:50%;animation:sp .6s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<canvas id="matrix"></canvas>
<div class="grid-overlay"></div>
<div class="hud-border"><div class="hud-c tl"></div><div class="hud-c tr"></div><div class="hud-c bl"></div><div class="hud-c br"></div></div>
<div class="scanline"></div>

<div class="app">

<!-- TOPBAR -->
<div class="topbar">
  <div class="tb-left">
    <svg width="28" height="28" viewBox="0 0 36 36" fill="none" style="filter:drop-shadow(0 0 6px rgba(0,255,136,0.4))">
      <polygon points="18,2 33,10 33,26 18,34 3,26 3,10" fill="none" stroke="url(#lg)" stroke-width="1.5"/>
      <polygon points="18,7 28,12 28,24 18,29 8,24 8,12" fill="rgba(0,255,136,0.05)" stroke="url(#lg)" stroke-width="0.8"/>
      <text x="18" y="21" text-anchor="middle" font-family="Orbitron" font-size="8" font-weight="900" fill="url(#lg)">WR</text>
      <defs><linearGradient id="lg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#00ff88"/><stop offset="100%" stop-color="#00aaff"/></linearGradient></defs>
    </svg>
    <div class="brand">WAR ROOM<sub>指揮官戰情室</sub></div>
    <div class="status-lights">
      <div class="s-light"><div class="s-dot off" id="dotSystem"></div>SYS</div>
      <div class="s-light"><div class="s-dot off" id="dotRealtime"></div>RT</div>
      <div class="s-light"><div class="s-dot off" id="dotArsenal"></div>ARM</div>
    </div>
  </div>
  <div class="tb-right">
    <div class="clock-box"><div id="clockTPE">--:--:--</div><div id="clockUTC" style="color:rgba(255,255,255,0.2)">UTC --:--</div></div>
    <div class="cmd-name">指揮官 許竣翔</div>
    <button class="sound-btn" id="soundBtn" onclick="toggleSound()" title="音效">&#128264;</button>
  </div>
</div>

<!-- PATENT STRIP -->
<div class="patent-strip">
  <span class="patent-text">PATENT 115100981</span><span class="patent-sep">|</span>
  <span class="patent-text">CaaS L1-L4</span><span class="patent-sep">|</span>
  <span class="patent-text">世界定義約束法用於AI推理</span><span class="patent-sep">|</span>
  <span class="patent-text">小路光 60475510</span>
</div>

<!-- MAIN -->
<div class="main">

  <!-- LEFT COLUMN -->
  <div class="left-col">
    <div>
      <div class="section-label">LIFE SIGNS</div>
      <div id="healthChecks"><div style="text-align:center;padding:10px"><div class="spin"></div></div></div>
    </div>
    <div>
      <div class="section-label" style="cursor:pointer" onclick="openDrill('arsenal')">ARSENAL</div>
      <div class="gauge-box" onclick="openDrill('arsenal')" style="cursor:pointer">
        <canvas id="arsenalGauge" width="170" height="100"></canvas>
        <div class="gauge-center" style="bottom:20px;font-size:22px;color:var(--green)" id="arsenalPctLabel">--%</div>
      </div>
    </div>
    <div>
      <div class="section-label" style="cursor:pointer" onclick="openDrill('world')">WORLD DEF</div>
      <div class="gauge-box" onclick="openDrill('world')" style="cursor:pointer">
        <canvas id="wdGauge" width="170" height="100"></canvas>
        <div class="gauge-center" style="bottom:20px;font-size:16px;color:var(--cyan)" id="wdNodesLabel">-- NODES</div>
      </div>
    </div>
    <div>
      <div class="section-label" style="cursor:pointer" onclick="openDrill('kpi')">TODAY KPI</div>
      <div class="kpi-grid" id="kpiCards">
        <div class="kpi-card"><div class="kpi-val" style="color:var(--blue)">--</div><div class="kpi-label">對話</div></div>
        <div class="kpi-card"><div class="kpi-val" style="color:var(--green)">--</div><div class="kpi-label">成功</div></div>
        <div class="kpi-card"><div class="kpi-val" style="color:var(--red)">--</div><div class="kpi-label">錯誤</div></div>
        <div class="kpi-card"><div class="kpi-val" style="color:var(--gold)">--</div><div class="kpi-label">攔截</div></div>
      </div>
    </div>
    <div>
      <div class="section-label">LATENCY</div>
      <canvas id="sparkline" width="180" height="36" style="width:100%;height:36px"></canvas>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center-col">
    <div class="map-container" onclick="openDrill('map')">
      <canvas id="worldMap"></canvas>
    </div>
    <div class="center-bottom">
      <div class="cb-panel" onclick="openDrill('arsenal')">
        <div class="cb-title">PROVIDERS <span id="provCount" style="color:var(--green)"></span></div>
        <div class="provider-grid" id="providerGrid"></div>
      </div>
      <div class="cb-panel" onclick="openDrill('world')">
        <div class="cb-title">WORLD GRAPH <span id="miniGraphLabel" style="color:var(--cyan)"></span></div>
        <div class="mini-graph-wrap"><canvas id="miniGraph"></canvas></div>
      </div>
      <div class="cb-panel" onclick="openDrill('security')">
        <div class="cb-title">SECURITY SHIELD</div>
        <div class="shield-box">
          <div class="shield-ring-sm"><span class="shield-score-sm" id="shieldScore">--</span></div>
          <div class="defense-dots" id="defenseDots"></div>
          <div style="width:100%">
            <div style="font-size:7px;color:rgba(255,255,255,0.3);letter-spacing:1px;margin-bottom:2px">RLS COVERAGE</div>
            <div class="rls-bar"><div class="rls-fill" id="rlsFill" style="width:0%"></div></div>
            <div style="font-size:8px;color:var(--green);margin-top:2px" id="rlsLabel">--</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div class="right-col">
    <div class="feed-section activity">
      <div class="feed-header">LIVE ACTIVITY <span class="feed-count" id="actCount">0</span></div>
      <div class="feed-list" id="activityFeed"><div style="text-align:center;padding:20px;color:rgba(255,255,255,0.15)"><div class="spin"></div></div></div>
    </div>
    <div class="feed-section alerts">
      <div class="feed-header">ALERTS <span class="feed-count" id="alertCount" style="background:rgba(255,34,68,0.1);color:var(--red)">0</span></div>
      <div class="feed-list" id="alertFeed"><div style="text-align:center;padding:10px;color:rgba(255,255,255,0.15);font-size:9px">Monitoring...</div></div>
    </div>
  </div>

</div>

<!-- BOTTOM BAR -->
<div class="bottombar">
  <div class="bb-actions">
    <button class="bb-btn purge" onclick="confirmAction('action-purge','PURGE 全網清洗','purge')">&#128293; PURGE</button>
    <button class="bb-btn report" onclick="confirmAction('action-report','REPORT 生成日報','report')">&#128202; REPORT</button>
    <button class="bb-btn defense" onclick="confirmAction('action-defense','DEFENSE 防禦模式','defense')">&#128737;&#65039; DEFENSE</button>
  </div>
  <div class="bb-status" id="bbStatus">INIT...</div>
  <div class="bb-patent">SEOBAIKE OS &middot; Patent 115100981</div>
</div>

</div>

<!-- DRILL-DOWN OVERLAY -->
<div class="drill-overlay" id="drillOverlay" onclick="if(event.target===this)closeDrill()">
  <div class="drill-panel">
    <div class="drill-head">
      <span class="drill-title" id="drillTitle">--</span>
      <button class="drill-close" onclick="closeDrill()">&times;</button>
    </div>
    <div class="drill-body" id="drillBody"></div>
  </div>
</div>

<!-- CONFIRM OVERLAY -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3 id="confirmTitle">CONFIRM</h3>
    <p id="confirmMsg">Are you sure?</p>
    <div class="confirm-btns">
      <button class="confirm-yes" id="confirmYes">EXECUTE</button>
      <button class="confirm-no" onclick="closeConfirm()">CANCEL</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
// ============================================================
// CONFIG
// ============================================================
const SB_URL='https://vmyrivxxibqydccurxug.supabase.co';
const SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteXJpdnh4aWJxeWRjY3VyeHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNDAwMjksImV4cCI6MjA4NTYxNjAyOX0.iBV-23LGdm_uKffAExgqSV34-NWoAyv8_-M_cJQZ8Gg';
const SRK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteXJpdnh4aWJxeWRjY3VyeHVnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDA0MDAyOSwiZXhwIjoyMDg1NjE2MDI5fQ.fUSfCNn3hYZiaQt3O6hFG3asyVpWqHOJq_sqwzmUFuA';
const CEO_URL=SB_URL+'/functions/v1/ceo-dashboard';
const WD_URL=SB_URL+'/functions/v1/world-definition';
const HM_URL=SB_URL+'/functions/v1/health-monitor';
const sb=window.supabase.createClient(SB_URL,SK);
const startTime=Date.now();
let refreshCount=0;

// ============================================================
// STATE
// ============================================================
let S={
  arsenal:null, daily:null, globalStatus:null, health:null, wdStats:null,
  graph:null, latencyHistory:[], feedData:[], alertData:[], soundOn:false,
  audioCtx:null
};

// ============================================================
// MATRIX RAIN
// ============================================================
const mc=document.getElementById('matrix'),mx=mc.getContext('2d');
function resizeMC(){mc.width=window.innerWidth;mc.height=window.innerHeight}
window.addEventListener('resize',()=>{resizeMC();resizeMap()});resizeMC();
const cols=Math.floor(mc.width/14),drops=Array(cols).fill(1);
const mChars='SEOBAIKE01六界指揮戰情室物理AI約束CaaS'.split('');
function drawMatrix(){mx.fillStyle='rgba(0,0,0,0.05)';mx.fillRect(0,0,mc.width,mc.height);mx.font='12px JetBrains Mono';for(let i=0;i<drops.length;i++){mx.fillStyle=`hsl(${140+Math.random()*40},100%,${50+Math.random()*20}%)`;mx.fillText(mChars[Math.floor(Math.random()*mChars.length)],i*14,drops[i]*14);if(drops[i]*14>mc.height&&Math.random()>0.975)drops[i]=0;drops[i]++}}
setInterval(drawMatrix,50);

// ============================================================
// CLOCKS
// ============================================================
function updateClocks(){
  const now=new Date();
  document.getElementById('clockTPE').textContent='TPE '+now.toLocaleTimeString('en',{timeZone:'Asia/Taipei',hour12:false});
  document.getElementById('clockUTC').textContent='UTC '+now.toLocaleTimeString('en',{timeZone:'UTC',hour12:false,hour:'2-digit',minute:'2-digit'});
}
setInterval(updateClocks,1000);updateClocks();

// ============================================================
// SOUND SYSTEM
// ============================================================
function initAudio(){if(!S.audioCtx)S.audioCtx=new(window.AudioContext||window.webkitAudioContext)()}
function toggleSound(){
  S.soundOn=!S.soundOn;initAudio();
  const btn=document.getElementById('soundBtn');
  btn.textContent=S.soundOn?'\u{1F50A}':'\u{1F508}';
  btn.className='sound-btn'+(S.soundOn?' on':'');
  if(S.soundOn)notifySound();
}
function alertSound(){
  if(!S.soundOn||!S.audioCtx)return;
  const ctx=S.audioCtx;
  [880,1100].forEach((f,i)=>{
    const osc=ctx.createOscillator(),gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='square';osc.frequency.value=f;
    gain.gain.setValueAtTime(0.08,ctx.currentTime+i*0.15);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.15+0.15);
    osc.start(ctx.currentTime+i*0.15);osc.stop(ctx.currentTime+i*0.15+0.15);
  });
}
function notifySound(){
  if(!S.soundOn||!S.audioCtx)return;
  const ctx=S.audioCtx,osc=ctx.createOscillator(),gain=ctx.createGain();
  osc.connect(gain);gain.connect(ctx.destination);
  osc.type='sine';osc.frequency.value=660;
  gain.gain.setValueAtTime(0.05,ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.12);
  osc.start();osc.stop(ctx.currentTime+0.12);
}

// ============================================================
// API HELPERS
// ============================================================
async function ceoApi(action){const r=await fetch(CEO_URL+'?action='+action,{headers:{'Authorization':'Bearer '+SRK}});return r.json()}
async function wdApi(action,params=''){const r=await fetch(WD_URL+'?action='+action+params,{headers:{'Authorization':'Bearer '+SRK}});return r.json()}
async function hmApi(){const r=await fetch(HM_URL,{headers:{'Authorization':'Bearer '+SRK}});return r.json()}
async function rpc(fn){const r=await fetch(SB_URL+'/rest/v1/rpc/'+fn,{method:'POST',headers:{'apikey':SRK,'Authorization':'Bearer '+SRK,'Content-Type':'application/json'}});return r.ok?r.json():null}
function msColor(ms){return ms<500?'var(--green)':ms<2000?'var(--gold)':'var(--red)'}
function shortTime(ts){if(!ts)return'--';return new Date(ts).toLocaleTimeString('zh-TW',{timeZone:'Asia/Taipei',hour:'2-digit',minute:'2-digit',second:'2-digit'})}

// ============================================================
// INITIAL DATA LOAD
// ============================================================
async function loadAll(){
  const t0=Date.now();
  document.getElementById('bbStatus').textContent='LOADING...';
  const results=await Promise.allSettled([
    ceoApi('global-status'),
    ceoApi('arsenal'),
    ceoApi('daily-report'),
    hmApi().catch(()=>null),
    wdApi('stats')
  ]);
  S.globalStatus=results[0].status==='fulfilled'?results[0].value:null;
  S.arsenal=results[1].status==='fulfilled'?results[1].value:null;
  S.daily=results[2].status==='fulfilled'?results[2].value:null;
  S.health=results[3].status==='fulfilled'?results[3].value:null;
  S.wdStats=results[4].status==='fulfilled'?results[4].value:null;
  refreshCount++;
  const elapsed=Date.now()-t0;
  document.getElementById('bbStatus').textContent=`LOADED ${elapsed}ms | CYCLE #${refreshCount}`;
  updateStatusLights();
  renderHealthChecks();
  renderArsenalGauge();
  renderWdGauge();
  renderKPI();
  renderMap();
  renderProviderGrid();
  renderSecurityShield();
  updateSparkline(elapsed);
  loadInitialFeed();
}

// ============================================================
// STATUS LIGHTS
// ============================================================
function updateStatusLights(){
  const sys=document.getElementById('dotSystem');
  const rt=document.getElementById('dotRealtime');
  const arm=document.getElementById('dotArsenal');
  sys.className='s-dot '+(S.health||S.daily?'on':'off');
  arm.className='s-dot '+((S.arsenal&&S.arsenal.health_pct>=80)?'on':(S.arsenal?'warn':'off'));
}

// ============================================================
// HEALTH CHECKS (LEFT COL)
// ============================================================
function renderHealthChecks(){
  const el=document.getElementById('healthChecks');
  // Combine sources
  let checks=[];
  // From health-monitor if available
  if(S.health&&S.health.checks){
    checks=S.health.checks.map(c=>({name:c.name||c.service,status:c.status,val:c.latency_ms?c.latency_ms+'ms':(c.status||'--')}));
  }
  // Fallback: from daily-report system_health
  if(!checks.length&&S.daily&&S.daily.system_health){
    checks=S.daily.system_health.map(h=>({name:h.component||h.name,status:h.status,val:h.status}));
  }
  // Static fallback
  if(!checks.length){
    const gs=S.globalStatus;
    checks=[
      {name:'Database',status:gs?'healthy':'unknown',val:gs?'OK':'--'},
      {name:'AI Gateway',status:S.arsenal?'healthy':'unknown',val:S.arsenal?'OK':'--'},
      {name:'Edge Functions',status:'healthy',val:'OK'},
      {name:'Realtime',status:'checking',val:'--'},
      {name:'CDN',status:gs?'healthy':'unknown',val:gs?'OK':'--'},
      {name:'Auth',status:'healthy',val:'OK'},
      {name:'Storage',status:'healthy',val:'OK'},
    ];
  }
  el.innerHTML=checks.slice(0,7).map(c=>{
    const color=c.status==='healthy'||c.status==='ok'||c.status==='active'?'var(--green)':c.status==='degraded'||c.status==='warning'?'var(--gold)':c.status==='error'||c.status==='down'?'var(--red)':'rgba(255,255,255,0.3)';
    const dotCls=c.status==='healthy'||c.status==='ok'||c.status==='active'?'on':c.status==='error'||c.status==='down'?'off':'warn';
    return`<div class="health-item"><div class="h-dot s-dot ${dotCls}"></div><span class="h-name">${c.name}</span><span class="h-val" style="color:${color}">${c.val}</span></div>`;
  }).join('');
}

// ============================================================
// ARSENAL GAUGE (LEFT COL - Canvas half-circle)
// ============================================================
function renderArsenalGauge(){
  const canvas=document.getElementById('arsenalGauge');
  const ctx=canvas.getContext('2d');
  const pct=S.arsenal?S.arsenal.health_pct:0;
  ctx.clearRect(0,0,170,100);
  const cx=85,cy=90,r=70;
  // Background arc
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,0);
  ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.lineWidth=10;ctx.stroke();
  // Filled arc
  const angle=Math.PI+(pct/100)*Math.PI;
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,angle);
  ctx.strokeStyle=pct>=95?'#00ff88':pct>=80?'#ffaa00':'#ff2244';
  ctx.lineWidth=10;ctx.lineCap='round';ctx.stroke();
  document.getElementById('arsenalPctLabel').textContent=pct+'%';
  document.getElementById('arsenalPctLabel').style.color=pct>=95?'var(--green)':pct>=80?'var(--gold)':'var(--red)';
}

// ============================================================
// WORLD DEFINITION GAUGE (LEFT COL)
// ============================================================
function renderWdGauge(){
  const canvas=document.getElementById('wdGauge');
  const ctx=canvas.getContext('2d');
  const stats=S.wdStats||{};
  const total=stats.total_nodes||0;
  ctx.clearRect(0,0,170,100);
  const cx=85,cy=90,r=70;
  // Background
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,0);
  ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.lineWidth=10;ctx.stroke();
  // L1-L4 segments
  const levels=[
    {count:stats.by_level?stats.by_level[1]||0:0,color:'#00eeff'},
    {count:stats.by_level?stats.by_level[2]||0:0,color:'#00ff88'},
    {count:stats.by_level?stats.by_level[3]||0:0,color:'#ffaa00'},
    {count:stats.by_level?stats.by_level[4]||0:0,color:'#aa44ff'}
  ];
  let startAngle=Math.PI;
  const totalForArc=levels.reduce((s,l)=>s+l.count,0)||1;
  levels.forEach(lv=>{
    if(lv.count<=0)return;
    const sweep=(lv.count/totalForArc)*Math.PI;
    ctx.beginPath();ctx.arc(cx,cy,r,startAngle,startAngle+sweep);
    ctx.strokeStyle=lv.color;ctx.lineWidth=10;ctx.lineCap='round';ctx.stroke();
    startAngle+=sweep;
  });
  document.getElementById('wdNodesLabel').textContent=(total||'--')+' NODES';
}

// ============================================================
// KPI CARDS (LEFT COL)
// ============================================================
function renderKPI(){
  const k=S.daily?S.daily.kpi||{}:{};
  const cards=document.getElementById('kpiCards');
  cards.innerHTML=`
    <div class="kpi-card" onclick="openDrill('kpi')" style="cursor:pointer"><div class="kpi-val" style="color:var(--blue)">${k.total_conversations||0}</div><div class="kpi-label">對話</div></div>
    <div class="kpi-card" onclick="openDrill('kpi')" style="cursor:pointer"><div class="kpi-val" style="color:var(--green)">${k.success||0}</div><div class="kpi-label">成功</div></div>
    <div class="kpi-card" onclick="openDrill('kpi')" style="cursor:pointer"><div class="kpi-val" style="color:var(--red)">${k.errors||0}</div><div class="kpi-label">錯誤</div></div>
    <div class="kpi-card" onclick="openDrill('kpi')" style="cursor:pointer"><div class="kpi-val" style="color:var(--gold)">${k.blocked||0}</div><div class="kpi-label">攔截</div></div>`;
}

// ============================================================
// SPARKLINE (LEFT COL)
// ============================================================
function updateSparkline(val){
  S.latencyHistory.push(val);if(S.latencyHistory.length>30)S.latencyHistory.shift();
  const canvas=document.getElementById('sparkline');
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  const data=S.latencyHistory;if(data.length<2)return;
  const max=Math.max(...data,1);
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x=(i/(data.length-1))*W;
    const y=H-4-(v/max)*(H-8);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.strokeStyle='rgba(0,255,136,0.6)';ctx.lineWidth=1.5;ctx.stroke();
  // Fill
  const lastX=(data.length-1)/(data.length-1)*W;
  ctx.lineTo(lastX,H);ctx.lineTo(0,H);ctx.closePath();
  ctx.fillStyle='rgba(0,255,136,0.05)';ctx.fill();
}

// ============================================================
// WORLD MAP (CENTER - Canvas)
// ============================================================
const CONTINENTS=[
  // North America
  [[-130,55],[-120,60],[-105,62],[-95,70],[-80,70],[-65,60],[-55,50],[-60,47],[-67,45],[-70,42],[-75,37],[-80,30],[-82,25],[-85,25],[-90,28],[-98,20],[-105,25],[-110,30],[-118,33],[-122,40],[-125,48],[-130,55]],
  // South America
  [[-80,10],[-75,5],[-65,0],[-55,0],[-45,-3],[-38,-8],[-35,-15],[-38,-22],[-48,-27],[-55,-35],[-68,-53],[-73,-45],[-72,-30],[-75,-15],[-78,-5],[-80,5],[-80,10]],
  // Europe
  [[-10,36],[0,38],[2,43],[5,48],[10,48],[15,52],[18,55],[25,60],[30,68],[38,68],[40,62],[35,55],[30,50],[28,42],[25,38],[20,36],[10,38],[5,42],[0,40],[-5,42],[-10,36]],
  // Africa
  [[-15,30],[-5,35],[10,37],[25,33],[33,28],[38,20],[50,12],[42,0],[38,-12],[32,-28],[25,-35],[18,-35],[12,-28],[10,-18],[5,-5],[0,5],[-5,5],[-10,10],[-15,15],[-17,25],[-15,30]],
  // Asia
  [[28,38],[35,42],[42,45],[50,50],[60,55],[75,60],[90,65],[110,65],[120,60],[130,50],[138,42],[140,38],[135,35],[128,32],[120,22],[110,15],[100,5],[98,0],[95,5],[100,10],[80,15],[65,25],[50,32],[40,38],[28,38]],
  // Australia
  [[115,-12],[128,-12],[140,-14],[148,-20],[150,-30],[145,-37],[135,-35],[125,-30],[118,-22],[115,-15],[115,-12]],
  // Japan (small island group)
  [[130,31],[131,33],[133,35],[136,37],[140,40],[142,43],[143,45],[141,43],[138,38],[134,34],[130,31]],
  // UK
  [[-6,50],[-5,52],[-3,54],[-4,56],[-2,58],[0,56],[2,53],[0,51],[-4,50],[-6,50]],
  // Greenland
  [[-55,60],[-45,62],[-25,65],[-20,72],[-25,78],[-35,80],[-50,78],[-55,75],[-50,68],[-55,60]]
];

const MARKERS=[
  {id:'tw',name:'TAIWAN',lon:121,lat:23.5,color:'#00ff88',label:'TW'},
  {id:'us',name:'US-EAST',lon:-77,lat:39,color:'#00aaff',label:'US'},
  {id:'eu',name:'FRANKFURT',lon:8.7,lat:50,color:'#ffaa00',label:'EU'},
  {id:'jp',name:'TOKYO',lon:139.7,lat:35.7,color:'#aa44ff',label:'JP'}
];

let mapCtx,mapW,mapH,mapAnim=0;
function project(lon,lat,w,h){return[(lon+180)/360*w,(90-lat)/180*h]}

function resizeMap(){
  const canvas=document.getElementById('worldMap');
  const rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*2;canvas.height=rect.height*2;
  mapW=canvas.width;mapH=canvas.height;
  mapCtx=canvas.getContext('2d');
}

function renderMap(){
  const canvas=document.getElementById('worldMap');
  if(!mapCtx){resizeMap()}
  const ctx=mapCtx,W=mapW,H=mapH;
  ctx.clearRect(0,0,W,H);

  // Continents
  CONTINENTS.forEach(cont=>{
    ctx.beginPath();
    cont.forEach((p,i)=>{
      const[x,y]=project(p[0],p[1],W,H);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.closePath();
    ctx.fillStyle='rgba(0,255,136,0.04)';ctx.fill();
    ctx.strokeStyle='rgba(0,255,136,0.12)';ctx.lineWidth=1;ctx.stroke();
  });

  // Get site data for latency
  const sites=S.globalStatus?S.globalStatus.sites||[]:[];
  const siteMap={};
  sites.forEach(s=>{siteMap[s.name]=s;siteMap[(s.name||'').toLowerCase()]=s});

  // Data flow lines from TW to other 3
  const twPos=project(MARKERS[0].lon,MARKERS[0].lat,W,H);
  for(let i=1;i<MARKERS.length;i++){
    const m=MARKERS[i];
    const pos=project(m.lon,m.lat,W,H);
    ctx.beginPath();ctx.moveTo(twPos[0],twPos[1]);ctx.lineTo(pos[0],pos[1]);
    ctx.strokeStyle=m.color.replace(')',',0.3)').replace('rgb','rgba').replace('#','');
    ctx.strokeStyle=hexToRgba(m.color,0.25);
    ctx.lineWidth=2;ctx.setLineDash([8,6]);ctx.lineDashOffset=-mapAnim*0.5;
    ctx.stroke();ctx.setLineDash([]);
    // Animated flow particles
    const t=((mapAnim*0.01*((i%2)?1:-1))%1+1)%1;
    const px=twPos[0]+(pos[0]-twPos[0])*t;
    const py=twPos[1]+(pos[1]-twPos[1])*t;
    ctx.beginPath();ctx.arc(px,py,4,0,Math.PI*2);
    ctx.fillStyle=hexToRgba(m.color,0.8);ctx.fill();
  }

  // Markers with pulse
  MARKERS.forEach(m=>{
    const[x,y]=project(m.lon,m.lat,W,H);
    const site=findSite(m.id,sites);
    const isOnline=!site||site.status==='online'||site.color==='green';
    const mColor=isOnline?m.color:'#ff2244';
    // Pulse ring
    const pulseR=12+Math.sin(mapAnim*0.05)*5;
    ctx.beginPath();ctx.arc(x,y,pulseR,0,Math.PI*2);
    ctx.strokeStyle=hexToRgba(mColor,0.3);ctx.lineWidth=1.5;ctx.stroke();
    // Core dot
    ctx.beginPath();ctx.arc(x,y,6,0,Math.PI*2);
    ctx.fillStyle=mColor;ctx.shadowColor=mColor;ctx.shadowBlur=15;ctx.fill();ctx.shadowBlur=0;
    // Label
    const lat_ms=site?site.latency_ms:null;
    const labelText=m.label+(lat_ms!=null?' '+lat_ms+'ms':'');
    ctx.font='bold 18px Orbitron';ctx.fillStyle=mColor;ctx.textAlign='center';
    ctx.fillText(labelText,x,y-18);
    ctx.font='12px JetBrains Mono';ctx.fillStyle='rgba(255,255,255,0.4)';
    ctx.fillText(m.name,x,y+24);
  });
}

function findSite(markerId,sites){
  const nameMap={tw:'taiwan',us:'us-east',eu:'frankfurt',jp:'tokyo'};
  const search=(nameMap[markerId]||markerId).toLowerCase();
  return sites.find(s=>(s.name||'').toLowerCase().includes(search));
}

function hexToRgba(hex,a){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return`rgba(${r},${g},${b},${a})`;
}

// Map animation loop
function mapLoop(){
  mapAnim++;
  if(mapCtx)renderMap();
  requestAnimationFrame(mapLoop);
}
requestAnimationFrame(mapLoop);

// ============================================================
// PROVIDER GRID (CENTER BOTTOM)
// ============================================================
function renderProviderGrid(){
  const el=document.getElementById('providerGrid');
  if(!S.arsenal||!S.arsenal.keys){el.innerHTML='<div style="color:rgba(255,255,255,0.2);font-size:8px;grid-column:1/-1;text-align:center">Loading...</div>';return}
  const keys=S.arsenal.keys;
  document.getElementById('provCount').textContent=keys.length;
  el.innerHTML=keys.map(k=>{
    const bg=k.color==='green'?'rgba(0,255,136,0.6)':k.color==='red'?'rgba(255,34,68,0.6)':'rgba(255,170,0,0.6)';
    return`<div class="prov-cell" style="background:${bg}"><div class="prov-tip">${k.provider} [${k.status||'--'}]</div></div>`;
  }).join('');
}

// ============================================================
// MINI FORCE GRAPH (CENTER BOTTOM)
// ============================================================
let miniNodes=[],miniAnimFrame;
function renderMiniGraph(){
  const canvas=document.getElementById('miniGraph');
  const rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*2;canvas.height=rect.height*2;
  const ctx=canvas.getContext('2d'),W=canvas.width,H=canvas.height;
  const stats=S.wdStats||{};
  document.getElementById('miniGraphLabel').textContent=(stats.total_nodes||'--')+' nodes';

  // Generate fake node positions if we don't have graph data yet
  if(!miniNodes.length){
    const levelColors={1:'#00eeff',2:'#00ff88',3:'#ffaa00',4:'#aa44ff'};
    const counts={1:stats.by_level?stats.by_level[1]||3:3,2:stats.by_level?stats.by_level[2]||8:8,3:stats.by_level?stats.by_level[3]||12:12,4:stats.by_level?stats.by_level[4]||5:5};
    for(const[lv,cnt] of Object.entries(counts)){
      for(let i=0;i<cnt;i++){
        const angle=Math.random()*Math.PI*2;
        const dist=40+Number(lv)*50+Math.random()*60;
        miniNodes.push({x:W/2+Math.cos(angle)*dist,y:H/2+Math.sin(angle)*dist,
          level:Number(lv),color:levelColors[lv]||'#fff',r:lv==1?6:lv==2?4:3,
          vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.5});
      }
    }
  }

  function drawMini(){
    ctx.clearRect(0,0,W,H);
    // Drift nodes slowly
    miniNodes.forEach(n=>{
      n.x+=n.vx;n.y+=n.vy;
      if(n.x<20||n.x>W-20)n.vx*=-1;
      if(n.y<20||n.y>H-20)n.vy*=-1;
    });
    // Links (just connect nearby same/adjacent level nodes)
    for(let i=0;i<miniNodes.length;i++){
      for(let j=i+1;j<miniNodes.length;j++){
        const a=miniNodes[i],b=miniNodes[j];
        const dx=a.x-b.x,dy=a.y-b.y,dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<120&&Math.abs(a.level-b.level)<=1){
          ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);
          ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=0.5;ctx.stroke();
        }
      }
    }
    // Nodes
    miniNodes.forEach(n=>{
      ctx.beginPath();ctx.arc(n.x,n.y,n.r,0,Math.PI*2);
      ctx.fillStyle=n.color;ctx.globalAlpha=0.7;ctx.fill();ctx.globalAlpha=1;
    });
    miniAnimFrame=requestAnimationFrame(drawMini);
  }
  if(miniAnimFrame)cancelAnimationFrame(miniAnimFrame);
  drawMini();
}

// ============================================================
// SECURITY SHIELD (CENTER BOTTOM)
// ============================================================
function renderSecurityShield(){
  document.getElementById('shieldScore').textContent='99';
  const dotsEl=document.getElementById('defenseDots');
  let dots='';
  for(let i=0;i<10;i++)dots+=`<div class="d-dot active" title="Layer ${i+1}"></div>`;
  dotsEl.innerHTML=dots;
  // RLS from DB health
  rpc('get_db_health').then(h=>{
    if(!h)return;
    const en=h.rls_enabled||0,dis=h.rls_disabled||0,total=en+dis||1;
    const pct=Math.round(en/total*100);
    document.getElementById('rlsFill').style.width=pct+'%';
    document.getElementById('rlsLabel').textContent=en+'/'+total+' ('+pct+'%)';
  }).catch(()=>{});
}

// ============================================================
// ACTIVITY FEED (RIGHT COL)
// ============================================================
async function loadInitialFeed(){
  try{
    const{data}=await sb.from('ai_customer_logs').select('id,created_at,input_text,output_text,status,response').order('created_at',{ascending:false}).limit(20);
    S.feedData=data||[];renderActivityFeed(false);
  }catch(e){console.warn('feed:',e)}
}

function renderActivityFeed(isNew){
  const el=document.getElementById('activityFeed');
  document.getElementById('actCount').textContent=S.feedData.length;
  if(!S.feedData.length){el.innerHTML='<div style="color:rgba(255,255,255,0.15);text-align:center;padding:20px;font-size:9px">Waiting for activity...</div>';return}
  el.innerHTML=S.feedData.slice(0,20).map((l,i)=>{
    const t=shortTime(l.created_at);
    const p=l.response?.provider||'';
    const ms=l.response?.latencyMs?l.response.latencyMs+'ms':'';
    const sc=l.status==='success'?'var(--green)':l.status==='error'?'var(--red)':'var(--gold)';
    return`<div class="feed-item ${i===0&&isNew?'new':''}">
      <span style="color:var(--blue);font-weight:700;font-size:8px">${t}</span> <span style="color:${sc};font-size:8px">[${(l.status||'--').toUpperCase()}]</span>
      ${p?`<span style="font-size:7px;background:rgba(0,255,136,0.1);color:var(--green);padding:1px 4px;border-radius:2px;margin-left:2px">${p} ${ms}</span>`:''}
      <div style="color:rgba(255,255,255,0.4);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${(l.input_text||'').substring(0,50)||'(empty)'}</div>
    </div>`;
  }).join('');
}

// ============================================================
// ALERT FEED (RIGHT COL)
// ============================================================
function addAlert(type,text,detail){
  const cls=type==='error'?'alert-red':type==='warning'?'alert-gold':'alert-purple';
  S.alertData.unshift({type,text,detail,time:new Date(),cls});
  if(S.alertData.length>30)S.alertData.pop();
  renderAlertFeed();
  alertSound();
}

function renderAlertFeed(){
  const el=document.getElementById('alertFeed');
  document.getElementById('alertCount').textContent=S.alertData.length;
  if(!S.alertData.length){el.innerHTML='<div style="text-align:center;padding:10px;color:rgba(255,255,255,0.15);font-size:9px">Monitoring...</div>';return}
  el.innerHTML=S.alertData.slice(0,15).map(a=>
    `<div class="feed-item ${a.cls}">
      <span style="color:var(--${a.type==='error'?'red':a.type==='warning'?'gold':'purple'});font-weight:700;font-size:8px">${shortTime(a.time)}</span>
      <span style="font-size:8px;margin-left:4px">${a.text}</span>
      ${a.detail?`<div style="color:rgba(255,255,255,0.3);font-size:8px;margin-top:1px">${a.detail}</div>`:''}
    </div>`
  ).join('');
}

// ============================================================
// REALTIME
// ============================================================
function setupRealtime(){
  const dot=document.getElementById('dotRealtime');
  sb.channel('ceo-realtime')
    .on('broadcast',{event:'new_log'},(p)=>{
      S.feedData.unshift(p.payload);if(S.feedData.length>30)S.feedData.pop();
      renderActivityFeed(true);notifySound();
    })
    .on('broadcast',{event:'fallback_alert'},(p)=>{
      const d=p.payload?.details||p.payload||{};
      const failed=(d.failed_providers||[]).map(pp=>pp.provider).join(' > ');
      addAlert('warning','FALLBACK: '+failed+' → '+(d.landed_on||'?'),d.landed_model||'');
    })
    .on('broadcast',{event:'health_alert'},(p)=>{
      const d=p.payload||{};
      addAlert('error','HEALTH: '+(d.component||d.name||'system'),(d.message||d.status||''));
    })
    .on('broadcast',{event:'violation_alert'},(p)=>{
      const v=p.payload||{};
      addAlert('purple','VIOLATION: '+(v.from_node||'?')+' → AI',v.reason||'');
    })
    .subscribe((st)=>{
      if(st==='SUBSCRIBED'){dot.className='s-dot on'}
      else if(st==='CHANNEL_ERROR'||st==='TIMED_OUT'){
        dot.className='s-dot off';
        setTimeout(setupRealtime,5000);
      }
    });
}

// ============================================================
// DRILL-DOWN SYSTEM
// ============================================================
function openDrill(type){
  document.getElementById('drillOverlay').classList.add('open');
  const title=document.getElementById('drillTitle');
  const body=document.getElementById('drillBody');
  body.innerHTML='<div style="text-align:center;padding:40px"><div class="spin"></div><div style="margin-top:12px;font-size:10px;color:rgba(255,255,255,0.3)">Loading...</div></div>';

  if(type==='arsenal'){
    title.textContent='AI ARSENAL - FULL VIEW';
    loadArsenalDrill(body);
  } else if(type==='world'){
    title.textContent='WORLD DEFINITION - FULL GRAPH';
    loadWorldDrill(body);
  } else if(type==='security'){
    title.textContent='SECURITY - 10 LAYER DEFENSE';
    loadSecurityDrill(body);
  } else if(type==='perf'){
    title.textContent='PERFORMANCE - DB HEALTH';
    loadPerfDrill(body);
  } else if(type==='kpi'){
    title.textContent='KPI - DAILY REPORT';
    loadKpiDrill(body);
  } else if(type==='map'){
    title.textContent='GLOBAL STATUS - ALL SITES';
    loadMapDrill(body);
  }
}

function closeDrill(){document.getElementById('drillOverlay').classList.remove('open')}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeDrill();closeConfirm()}});

// --- ARSENAL DRILL ---
async function loadArsenalDrill(body){
  try{
    const[d,lat]=await Promise.all([ceoApi('arsenal'),wdApi('latency-monitor','&hours=24')]);
    const keys=d.keys||[];
    const green=keys.filter(k=>k.color==='green').length;
    const errors=keys.filter(k=>k.color==='red').length;

    let html=`<div class="drill-section"><div class="drill-section-title">SUMMARY</div>
      <div class="g3d">
        <div class="stat"><div class="stat-val" style="color:${d.health_pct>=95?'var(--green)':'var(--gold)'}">${d.health_pct}%</div><div class="stat-label">HEALTH</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--green)">${green}/${keys.length}</div><div class="stat-label">OPERATIONAL</div></div>
        <div class="stat"><div class="stat-val" style="color:${errors?'var(--red)':'var(--green)'}">${errors}</div><div class="stat-label">ERRORS</div></div>
      </div></div>`;

    // Provider list
    html+=`<div class="drill-section"><div class="drill-section-title">ALL PROVIDERS (${keys.length})</div>`;
    const typeLabels={'inference':'AI GATEWAY','llm':'LLM','search':'SEARCH & TOOLS','voice':'SPECIAL FORCES','video':'SPECIAL FORCES','image':'SPECIAL FORCES'};
    const grouped={};
    keys.forEach(k=>{const cat=typeLabels[k.type]||k.type;if(!grouped[cat])grouped[cat]=[];grouped[cat].push(k)});
    for(const[cat,items]of Object.entries(grouped)){
      html+=`<div style="font-size:9px;color:rgba(255,255,255,0.25);letter-spacing:2px;padding:8px 0 4px;border-bottom:1px solid var(--dim)">${cat}</div>`;
      items.forEach(k=>{
        const ok=k.color==='green';
        html+=`<div class="row"><div class="dot ${ok?'dot-g':k.status==='timeout'?'dot-y':'dot-r'}"></div>
          <span style="flex:1">${k.provider}</span>
          ${k.http_code?`<span style="font-size:8px;color:rgba(255,255,255,0.2)">${k.http_code}</span>`:''}
          <span style="font-family:Orbitron;font-size:9px;color:${ok?'var(--green)':k.status==='timeout'?'var(--gold)':'var(--red)'}">${(k.status||'--').toUpperCase()}</span></div>`;
      });
    }
    html+=`</div>`;

    // Latency chart
    const providers=Object.entries(lat.by_provider||{});
    if(providers.length){
      const maxMs=Math.max(...providers.map(([,s])=>s.avg_ms),1);
      html+=`<div class="drill-section"><div class="drill-section-title">LATENCY (${lat.period_hours||24}H - ${lat.total_requests||0} REQUESTS)</div>`;
      html+=providers.sort((a,b)=>a[1].avg_ms-b[1].avg_ms).map(([name,s])=>{
        const pct=Math.round(s.avg_ms/maxMs*100);const c=s.avg_ms<500?'var(--green)':s.avg_ms<2000?'var(--gold)':'var(--red)';
        return`<div class="bar-row"><span class="bar-label">${name}</span><div class="bar-wrap"><div class="bar-fill" style="width:${pct}%;background:${c}"></div></div><span class="bar-val" style="color:${c}">${s.avg_ms}ms</span></div>`;
      }).join('');
      html+=`</div>`;
    }
    body.innerHTML=html;
  }catch(e){body.innerHTML=`<div style="color:var(--red);padding:20px">Failed: ${e.message}</div>`}
}

// --- WORLD DEFINITION DRILL ---
async function loadWorldDrill(body){
  try{
    const[stats,graph]=await Promise.all([wdApi('stats'),wdApi('get-graph')]);
    S.graph=graph;
    const gs=graph.stats||{};
    let html=`<div class="drill-section"><div class="drill-section-title">STATISTICS</div>
      <div class="g4d">
        <div class="stat"><div class="stat-val" style="color:var(--cyan)">${stats.total_nodes||0}</div><div class="stat-label">TOTAL NODES</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--green)">${stats.paths?.allowed||0}</div><div class="stat-label">ALLOWED</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--red)">${stats.paths?.forbidden||0}</div><div class="stat-label">FORBIDDEN</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--gold)">${stats.violations||0}</div><div class="stat-label">VIOLATIONS</div></div>
      </div></div>`;

    // CaaS Hierarchy
    html+=`<div class="drill-section"><div class="drill-section-title">CaaS HIERARCHY (PATENT 115100981)</div>
      <div style="display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;margin:12px 0">
        ${[{l:1,label:'L1 PHYSICAL',color:'var(--cyan)',c:gs.l1||0},{l:2,label:'L2 BUSINESS',color:'var(--green)',c:gs.l2||0},{l:3,label:'L3 SAFETY',color:'var(--gold)',c:gs.l3||0},{l:4,label:'L4 COMMAND',color:'var(--purple)',c:gs.l4||0}].map((lv,i)=>
          `<div style="background:rgba(0,0,0,0.4);border:1px solid ${lv.color};border-radius:6px;padding:10px 16px;text-align:center">
            <div style="font-family:Orbitron;font-size:22px;font-weight:900;color:${lv.color}">${lv.c}</div>
            <div style="font-size:8px;letter-spacing:2px;color:${lv.color};margin-top:2px">${lv.label}</div>
          </div>${i<3?'<span style="color:rgba(0,255,136,0.4);font-size:16px">&#9656;</span>':''}`).join('')}
      </div></div>`;

    // Node tree
    const nodes=graph.nodes||[];
    const byLevel={1:[],2:[],3:[],4:[]};
    nodes.forEach(n=>{if(byLevel[n.level])byLevel[n.level].push(n)});
    html+=`<div class="drill-section"><div class="drill-section-title">NODE TREE</div>`;
    const lcls={1:'background:rgba(0,238,255,0.1);color:var(--cyan);border:1px solid rgba(0,238,255,0.2)',
                2:'background:rgba(0,255,136,0.1);color:var(--green);border:1px solid rgba(0,255,136,0.2)',
                3:'background:rgba(255,170,0,0.1);color:var(--gold);border:1px solid rgba(255,170,0,0.2)',
                4:'background:rgba(170,68,255,0.1);color:var(--purple);border:1px solid rgba(170,68,255,0.2)'};
    for(const[lv,ns]of Object.entries(byLevel)){
      if(!ns.length)continue;
      html+=`<div style="margin-bottom:8px"><div style="font-size:9px;color:rgba(255,255,255,0.3);margin-bottom:4px;letter-spacing:2px">LEVEL ${lv} (${ns.length})</div><div style="display:flex;flex-wrap:wrap;gap:3px">`;
      ns.forEach(n=>{html+=`<span style="display:inline-block;padding:3px 8px;border-radius:3px;font-size:9px;font-weight:700;${lcls[lv]}">${n.label||n.code}</span>`});
      html+=`</div></div>`;
    }
    html+=`</div>`;

    // Full graph canvas
    html+=`<div class="drill-section"><div class="drill-section-title">FORCE-DIRECTED GRAPH</div>
      <div style="position:relative;border:1px solid var(--dim);border-radius:4px;overflow:hidden">
        <canvas id="drillForceGraph" style="width:100%;height:500px;display:block"></canvas>
      </div></div>`;

    body.innerHTML=html;
    // Init force graph after DOM is ready
    setTimeout(()=>initDrillForceGraph(graph),100);
  }catch(e){body.innerHTML=`<div style="color:var(--red);padding:20px">Failed: ${e.message}</div>`}
}

function initDrillForceGraph(graph){
  const canvas=document.getElementById('drillForceGraph');
  if(!canvas)return;
  const rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*2;canvas.height=500*2;
  const ctx=canvas.getContext('2d'),W=canvas.width,H=canvas.height;
  const levelColors={1:'#00eeff',2:'#00ff88',3:'#ffaa00',4:'#aa44ff'};
  const nodeMap={};
  const nodes=(graph.nodes||[]).map(n=>{
    const angle=Math.random()*Math.PI*2;
    const dist=80+n.level*60+Math.random()*100;
    const node={id:n.id,label:n.label||n.code,level:n.level,
      x:W/2+Math.cos(angle)*dist,y:H/2+Math.sin(angle)*dist,
      vx:0,vy:0,color:levelColors[n.level]||'#fff',r:n.level===1?12:n.level===2?8:n.level===3?6:5};
    nodeMap[n.id]=node;return node;
  });
  const links=(graph.links||[]).map(l=>({source:nodeMap[l.source],target:nodeMap[l.target],type:l.type})).filter(l=>l.source&&l.target);
  let ticks=0;
  function simulate(){
    const alpha=0.15;
    for(let i=0;i<nodes.length;i++){for(let j=i+1;j<nodes.length;j++){
      const a=nodes[i],b=nodes[j];let dx=a.x-b.x,dy=a.y-b.y;let dist=Math.sqrt(dx*dx+dy*dy)||1;
      if(dist>400)continue;const f=800/(dist*dist)*alpha;
      a.vx+=dx/dist*f;a.vy+=dy/dist*f;b.vx-=dx/dist*f;b.vy-=dy/dist*f;
    }}
    for(const l of links){
      const dx=l.target.x-l.source.x,dy=l.target.y-l.source.y;const dist=Math.sqrt(dx*dx+dy*dy)||1;
      const f=(dist-(l.type==='hierarchy'?80:150))*0.005*alpha;
      l.source.vx+=dx/dist*f;l.source.vy+=dy/dist*f;l.target.vx-=dx/dist*f;l.target.vy-=dy/dist*f;
    }
    for(const n of nodes){
      n.vx+=(W/2-n.x)*0.002;n.vy+=(H/2-n.y)*0.002;
      n.vx*=0.88;n.vy*=0.88;n.x+=n.vx;n.y+=n.vy;
      n.x=Math.max(20,Math.min(W-20,n.x));n.y=Math.max(20,Math.min(H-20,n.y));
    }
  }
  function render(){
    ctx.clearRect(0,0,W,H);
    for(const l of links){
      ctx.beginPath();ctx.moveTo(l.source.x,l.source.y);ctx.lineTo(l.target.x,l.target.y);
      if(l.type==='hierarchy'){ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=0.5}
      else if(l.type==='allowed'){ctx.strokeStyle='rgba(0,255,136,0.25)';ctx.lineWidth=1.5}
      else{ctx.strokeStyle='rgba(255,34,68,0.3)';ctx.lineWidth=1.5;ctx.setLineDash([4,4])}
      ctx.stroke();ctx.setLineDash([]);
    }
    for(const n of nodes){
      ctx.beginPath();ctx.arc(n.x,n.y,n.r,0,Math.PI*2);
      ctx.fillStyle=n.color;ctx.fill();
      if(n.level<=2){ctx.font='11px JetBrains Mono';ctx.fillStyle='rgba(255,255,255,0.5)';ctx.textAlign='center';ctx.fillText(n.label,n.x,n.y+n.r+12)}
    }
  }
  let drillAnim;
  function frame(){if(ticks<300)simulate();render();ticks++;drillAnim=requestAnimationFrame(frame)}
  frame();
  // Cleanup when overlay closes
  const obs=new MutationObserver(()=>{
    if(!document.getElementById('drillOverlay').classList.contains('open')&&drillAnim){cancelAnimationFrame(drillAnim);obs.disconnect()}
  });
  obs.observe(document.getElementById('drillOverlay'),{attributes:true});
}

// --- SECURITY DRILL ---
async function loadSecurityDrill(body){
  const layers=[
    {n:'Cloudflare WAF',c:'var(--blue)'},
    {n:'TLS 1.3 + HSTS + PFS',c:'var(--green)'},
    {n:'JWT Validation (role + ref)',c:'var(--green)'},
    {n:'RLS + REVOKE (100% tables)',c:'var(--green)'},
    {n:'Rate Limiting (10/min)',c:'var(--gold)'},
    {n:'Input Sanitization (ILIKE)',c:'var(--green)'},
    {n:'AI Security Rules (6 rules)',c:'var(--cyan)'},
    {n:'Business Constraints (CaaS)',c:'var(--purple)'},
    {n:'CHECK Constraints (3)',c:'var(--green)'},
    {n:'IP Hash + Audit Immutability',c:'var(--gold)'},
  ];
  const vulns=[
    {id:'V-001',d:'ILIKE wildcard injection'},{id:'V-002',d:'Search keyword sanitization'},
    {id:'V-003',d:'Missing input validation'},{id:'V-004',d:'Prompt injection vectors'},
    {id:'V-005',d:'XSS in response output'},{id:'V-006',d:'Rate limit bypass'},
    {id:'V-007',d:'JWT validation incomplete'},{id:'V-008',d:'Country code validation'},
    {id:'V-009',d:'RLS not enabled (4 tables)'},{id:'V-010',d:'REVOKE not applied'},
    {id:'V-011',d:'Self-parent allowed'},{id:'V-012',d:'IP not anonymized'},
    {id:'V-013',d:'Audit log tamperable'},{id:'V-014',d:'Rate limit session mismatch'},
    {id:'V-015',d:'Self-referencing paths'},{id:'V-016',d:'Nullable created_at'},
  ];
  let html=`<div style="text-align:center;margin-bottom:20px">
    <div style="width:120px;height:120px;border-radius:50%;border:3px solid var(--green);display:inline-flex;align-items:center;justify-content:center;box-shadow:0 0 30px rgba(0,255,136,0.1),inset 0 0 30px rgba(0,255,136,0.05)">
      <span style="font-family:Orbitron;font-size:36px;font-weight:900;color:var(--green)">99</span>
    </div>
    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:8px;letter-spacing:2px">16 VULNERABILITIES PATCHED | 10-LAYER DEFENSE</div>
  </div>`;

  html+=`<div class="g2d"><div>`;
  html+=`<div class="drill-section"><div class="drill-section-title">DEFENSE LAYERS</div>`;
  layers.forEach((l,i)=>{html+=`<div class="row"><div class="dot dot-g"></div><span style="flex:1;color:${l.c}">${l.n}</span><span style="font-size:7px;color:var(--green);letter-spacing:1px">ACTIVE</span></div>`});
  html+=`</div>`;

  // RLS
  try{
    const h=await rpc('get_db_health');
    if(h){
      const en=h.rls_enabled||0,dis=h.rls_disabled||0;
      html+=`<div class="drill-section"><div class="drill-section-title">RLS COVERAGE</div>
        <div class="g2d"><div class="stat"><div class="stat-val" style="color:var(--green)">${en}</div><div class="stat-label">RLS ENABLED</div></div>
        <div class="stat"><div class="stat-val" style="color:${dis?'var(--red)':'var(--green)'}">${dis}</div><div class="stat-label">UNPROTECTED</div></div></div></div>`;
    }
  }catch(e){}

  // Crypto
  html+=`<div class="drill-section"><div class="drill-section-title">CRYPTO & TLS</div>
    <div class="row"><div class="dot dot-g"></div><span style="flex:1">TLS Version</span><span style="font-family:Orbitron;font-size:10px;color:var(--green)">1.3</span></div>
    <div class="row"><div class="dot dot-g"></div><span style="flex:1">HSTS</span><span style="font-family:Orbitron;font-size:10px;color:var(--green)">ON</span></div>
    <div class="row"><div class="dot dot-g"></div><span style="flex:1">Perfect Forward Secrecy</span><span style="font-family:Orbitron;font-size:10px;color:var(--green)">YES</span></div>
    <div class="row"><div class="dot dot-g"></div><span style="flex:1">JWT Algorithm</span><span style="font-family:Orbitron;font-size:10px;color:var(--green)">HS256</span></div>
    <div class="row"><div class="dot dot-g"></div><span style="flex:1">Deno Sandbox</span><span style="font-family:Orbitron;font-size:10px;color:var(--green)">ACTIVE</span></div></div>`;

  html+=`</div><div>`;
  html+=`<div class="drill-section"><div class="drill-section-title">VULNERABILITY TRACKER (16 PATCHED)</div>`;
  vulns.forEach(v=>{html+=`<div class="row"><span style="font-family:Orbitron;font-size:9px;color:var(--green);width:45px">${v.id}</span><span style="flex:1;color:rgba(255,255,255,0.5)">${v.d}</span><span style="font-size:7px;color:var(--green);letter-spacing:1px">PATCHED</span></div>`});
  html+=`</div></div></div>`;
  body.innerHTML=html;
}

// --- PERFORMANCE DRILL ---
async function loadPerfDrill(body){
  try{
    const[health,sizes,indexes]=await Promise.all([rpc('get_db_health'),rpc('get_table_sizes'),rpc('get_index_counts')]);
    if(!health){body.innerHTML='<div style="color:var(--red);padding:20px">RPC functions unavailable</div>';return}
    let html=`<div class="drill-section"><div class="drill-section-title">DATABASE HEALTH</div>
      <div class="g4d">
        <div class="stat"><div class="stat-val" style="color:${(health.cache_hit_rate||0)>=99?'var(--green)':'var(--gold)'}">${health.cache_hit_rate||0}%</div><div class="stat-label">CACHE HIT</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--blue)">${health.active_connections||0}</div><div class="stat-label">CONNECTIONS</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--cyan);font-size:20px">${health.db_size||'--'}</div><div class="stat-label">DB SIZE</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--gold)">${health.total_indexes||0}</div><div class="stat-label">INDEXES</div></div>
      </div></div>`;
    // Table sizes
    if(sizes&&sizes.length){
      const maxBytes=Math.max(...sizes.map(r=>r.bytes),1);
      html+=`<div class="drill-section"><div class="drill-section-title">TABLE SIZES</div>`;
      html+=sizes.map(r=>{
        const pct=Math.round(r.bytes/maxBytes*100);const c=r.bytes>50000000?'var(--red)':r.bytes>10000000?'var(--gold)':'var(--green)';
        return`<div class="bar-row"><span class="bar-label">${r.name}</span><div class="bar-wrap"><div class="bar-fill" style="width:${pct}%;background:${c}"></div></div><span class="bar-val" style="color:${c}">${r.size}</span></div>`;
      }).join('');
      html+=`</div>`;
    }
    // Indexes
    if(indexes&&indexes.length){
      const maxIdx=Math.max(...indexes.map(x=>x.cnt),1);
      html+=`<div class="drill-section"><div class="drill-section-title">INDEX INVENTORY</div>`;
      html+=indexes.map(r=>{
        const pct=Math.round(r.cnt/maxIdx*100);
        return`<div class="bar-row"><span class="bar-label">${r.name}</span><div class="bar-wrap"><div class="bar-fill" style="width:${pct}%;background:var(--blue)"></div></div><span class="bar-val" style="color:var(--blue)">${r.cnt}</span></div>`;
      }).join('');
      html+=`</div>`;
    }
    body.innerHTML=html;
  }catch(e){body.innerHTML=`<div style="color:var(--red);padding:20px">Failed: ${e.message}</div>`}
}

// --- KPI DRILL ---
async function loadKpiDrill(body){
  try{
    const dr=S.daily||await ceoApi('daily-report');
    const k=dr.kpi||{};
    const health=dr.system_health||[];
    let html=`<div class="drill-section"><div class="drill-section-title">TODAY'S KPI</div>
      <div class="g4d">
        <div class="stat"><div class="stat-val" style="color:var(--blue)">${k.total_conversations||0}</div><div class="stat-label">CONVERSATIONS</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--green)">${k.success||0}</div><div class="stat-label">SUCCESS</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--red)">${k.errors||0}</div><div class="stat-label">ERRORS</div></div>
        <div class="stat"><div class="stat-val" style="color:var(--gold)">${k.blocked||0}</div><div class="stat-label">BLOCKED</div></div>
      </div></div>`;
    html+=`<div class="drill-section"><div class="drill-section-title">ERROR RATE</div>
      <div class="stat" style="max-width:200px"><div class="stat-val" style="color:${(k.errors||0)>0?'var(--red)':'var(--green)'}; font-size:32px">${k.error_rate||'0%'}</div><div class="stat-label">ERROR RATE</div></div></div>`;
    if(health.length){
      html+=`<div class="drill-section"><div class="drill-section-title">SYSTEM HEALTH (${health.filter(h=>h.status==='healthy').length}/${health.length})</div>`;
      health.forEach(h=>{
        const ok=h.status==='healthy';
        html+=`<div class="row"><div class="dot ${ok?'dot-g':'dot-r'}"></div><span style="flex:1">${h.component||h.name}</span><span style="font-size:9px;color:${ok?'var(--green)':'var(--red)'}">${(h.status||'--').toUpperCase()}</span></div>`;
      });
      html+=`</div>`;
    }
    body.innerHTML=html;
  }catch(e){body.innerHTML=`<div style="color:var(--red);padding:20px">Failed: ${e.message}</div>`}
}

// --- MAP DRILL ---
function loadMapDrill(body){
  const gs=S.globalStatus;
  if(!gs){body.innerHTML='<div style="color:var(--red);padding:20px">No global status data</div>';return}
  const sites=gs.sites||[];
  const online=sites.filter(s=>s.status==='online').length;
  let html=`<div class="drill-section"><div class="drill-section-title">GLOBAL STATUS: ${gs.overall_status||'--'}</div>
    <div class="g2d">
      <div class="stat"><div class="stat-val" style="color:${online===sites.length?'var(--green)':'var(--red)'}">${online}/${sites.length}</div><div class="stat-label">SITES ONLINE</div></div>
      <div class="stat"><div class="stat-val" style="color:var(--cyan)">${sites.length}</div><div class="stat-label">TOTAL SITES</div></div>
    </div></div>`;
  html+=`<div class="drill-section"><div class="drill-section-title">ALL SITES</div>`;
  sites.forEach(s=>{
    const dotCls=s.color==='green'?'dot-g':s.color==='red'?'dot-r':'dot-y';
    html+=`<div class="row"><div class="dot ${dotCls}"></div><span style="flex:1;font-weight:700">${s.name}</span><span style="font-family:Orbitron;font-size:10px;color:${msColor(s.latency_ms)}">${s.latency_ms}ms</span></div>`;
  });
  html+=`</div>`;
  body.innerHTML=html;
}

// ============================================================
// CONFIRM & FIRE ACTIONS
// ============================================================
let pendingAction=null;
function confirmAction(action,title){
  pendingAction=action;
  document.getElementById('confirmTitle').textContent=title;
  document.getElementById('confirmMsg').textContent='Double confirm: execute '+action+'?';
  document.getElementById('confirmOverlay').classList.add('open');
  document.getElementById('confirmYes').onclick=()=>{closeConfirm();fireAction(pendingAction)};
}
function closeConfirm(){document.getElementById('confirmOverlay').classList.remove('open');pendingAction=null}

async function fireAction(action){
  document.getElementById('bbStatus').textContent='EXECUTING '+action.toUpperCase()+'...';
  try{
    const d=await ceoApi(action);
    document.getElementById('bbStatus').textContent='OK: '+(d.message||d.action||'done');
    notifySound();
  }catch(e){
    document.getElementById('bbStatus').textContent='FAIL: '+e.message;
    alertSound();
  }
}

// ============================================================
// INIT
// ============================================================
loadAll();
setupRealtime();
setTimeout(()=>renderMiniGraph(),500);

// Auto-refresh
setInterval(async()=>{
  try{
    const[gs,dr,hm]=await Promise.allSettled([ceoApi('global-status'),ceoApi('daily-report'),hmApi().catch(()=>null)]);
    if(gs.status==='fulfilled')S.globalStatus=gs.value;
    if(dr.status==='fulfilled')S.daily=dr.value;
    if(hm.status==='fulfilled')S.health=hm.value;
    refreshCount++;
    document.getElementById('bbStatus').textContent=`CYCLE #${refreshCount} | ${new Date().toLocaleTimeString('en',{timeZone:'Asia/Taipei',hour12:false})}`;
    updateStatusLights();renderHealthChecks();renderKPI();
  }catch(e){console.warn('refresh:',e)}
},30000);

// Arsenal refresh every 60s
setInterval(async()=>{
  try{
    S.arsenal=await ceoApi('arsenal');
    renderArsenalGauge();renderProviderGrid();updateStatusLights();
  }catch(e){}
},60000);

// WD stats refresh every 60s
setInterval(async()=>{
  try{S.wdStats=await wdApi('stats');renderWdGauge()}catch(e){}
},60000);
</script>
<script src="/seobaike-widget.js" defer></script>
</body>
</html>
