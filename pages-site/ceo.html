<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CEOæˆ°æƒ…å®¤">
<meta name="theme-color" content="#0a0a0a">
<link rel="manifest" href="/manifest.json">
<title>CEO æˆ°æƒ…å®¤ | SEOBAIKE</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0a;--card:#111;--green:#00ff88;--red:#ff3344;--yellow:#ffcc00;--blue:#00aaff;--text:#e0e0e0;--gold:#ffd700}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans TC',sans-serif;min-height:100vh;overflow-x:hidden;padding-bottom:80px}
.header{background:linear-gradient(135deg,#111 0%,#1a1a2e 100%);padding:16px;text-align:center;border-bottom:2px solid var(--green);position:sticky;top:0;z-index:100}
.header h1{font-family:'Orbitron',sans-serif;font-size:18px;color:var(--green);letter-spacing:2px}
.header .commander{color:var(--gold);font-size:14px;margin-top:4px}
.header .time{color:#666;font-size:11px;margin-top:2px}
.rt-badge{display:inline-block;font-size:9px;padding:2px 6px;border-radius:8px;margin-left:6px;vertical-align:middle;font-family:'Orbitron',sans-serif;letter-spacing:1px}
.rt-badge.connected{background:#002a11;color:var(--green);border:1px solid var(--green);animation:pulse 2s infinite}
.rt-badge.disconnected{background:#2a0011;color:var(--red);border:1px solid var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.section{margin:12px;background:var(--card);border-radius:12px;padding:16px;border:1px solid #222}
.section-title{font-family:'Orbitron',sans-serif;font-size:13px;color:var(--blue);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.section-title::before{content:'';width:4px;height:16px;background:var(--blue);border-radius:2px}
.site-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.site-card{background:#1a1a1a;border-radius:8px;padding:12px 8px;text-align:center;border:1px solid #333}
.site-card .light{width:20px;height:20px;border-radius:50%;margin:0 auto 6px;box-shadow:0 0 8px currentColor}
.site-card .name{font-size:11px;color:#aaa;word-break:break-all}
.site-card .ms{font-size:10px;color:#666;margin-top:2px}
.green{color:var(--green);background:var(--green)}
.red{color:var(--red);background:var(--red)}
.yellow{color:var(--yellow);background:var(--yellow)}
/* Arsenal */
.arsenal-list{display:flex;flex-direction:column;gap:6px}
.arsenal-item{display:flex;align-items:center;gap:10px;background:#1a1a1a;border-radius:8px;padding:10px 12px;transition:background .3s}
.arsenal-item.flash{background:#1a2a1a;border:1px solid var(--green)}
.arsenal-item .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.arsenal-item .provider{flex:1;font-size:13px}
.arsenal-item .status{font-size:11px;color:#888}
.arsenal-item .avail{font-size:11px;font-family:'Orbitron',sans-serif;margin-left:auto}
.arsenal-summary{background:linear-gradient(135deg,#1a2a1a,#111);border-radius:8px;padding:14px;text-align:center;margin-bottom:10px;border:1px solid #2a3a2a}
.arsenal-summary .big{font-family:'Orbitron',sans-serif;font-size:28px;color:var(--green)}
.arsenal-summary .label{font-size:11px;color:#888;margin-top:2px}
/* Fallback Alert */
.fallback-section{margin:12px;background:#1a1111;border-radius:12px;padding:16px;border:1px solid #442222;display:none}
.fallback-section.show{display:block}
.fallback-title{font-family:'Orbitron',sans-serif;font-size:13px;color:var(--red);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.fallback-title::before{content:'';width:4px;height:16px;background:var(--red);border-radius:2px}
/* Violation Monitor */
.violation-section{margin:12px;background:#1a0a1a;border-radius:12px;padding:16px;border:1px solid #442244;display:none}
.violation-section.show{display:block}
.violation-title{font-family:'Orbitron',sans-serif;font-size:13px;color:#ff44ff;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.violation-title::before{content:'';width:4px;height:16px;background:#ff44ff;border-radius:2px}
.violation-item{background:#2a1a2a;border-left:3px solid #ff44ff;padding:10px 12px;margin-bottom:6px;border-radius:0 8px 8px 0;font-size:12px;animation:violationFlash .5s}
.violation-item .path{font-family:'Orbitron',sans-serif;color:#ff88ff;font-size:11px}
.violation-item .reason{color:#ffaaff;margin-top:4px}
.violation-item .time{color:#666;font-size:10px;margin-top:2px}
.violation-count{font-family:'Orbitron',sans-serif;font-size:24px;color:#ff44ff;text-align:center;margin-bottom:8px}
@keyframes violationFlash{0%{background:#4a1a4a}100%{background:#2a1a2a}}
/* Latency Monitor */
.latency-section{margin:12px;background:#0a1a1a;border-radius:12px;padding:16px;border:1px solid #224444}
.latency-title{font-family:'Orbitron',sans-serif;font-size:13px;color:#00dddd;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.latency-title::before{content:'';width:4px;height:16px;background:#00dddd;border-radius:2px}
.latency-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.latency-card{background:#1a2a2a;border-radius:8px;padding:12px;text-align:center;border:1px solid #334444}
.latency-card .region{font-family:'Orbitron',sans-serif;font-size:11px;color:#00dddd;margin-bottom:6px}
.latency-card .avg{font-family:'Orbitron',sans-serif;font-size:22px}
.latency-card .p95{font-size:10px;color:#888;margin-top:4px}
.latency-card .count{font-size:10px;color:#666;margin-top:2px}
.provider-latency{margin-top:10px}
.plat-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #223;font-size:12px}
.plat-item:last-child{border-bottom:none}
.plat-name{width:80px;color:#00dddd;font-size:11px}
.plat-bar{flex:1;height:6px;background:#222;border-radius:3px;overflow:hidden}
.plat-bar-fill{height:100%;border-radius:3px;transition:width .5s}
.plat-val{width:60px;text-align:right;font-family:'Orbitron',sans-serif;font-size:11px}
.fallback-item{background:#1a1a1a;border-radius:8px;padding:10px 12px;margin-bottom:6px;font-size:12px;border-left:3px solid var(--red)}
.fallback-item .fb-time{color:var(--red);font-weight:700}
.fallback-item .fb-detail{color:#aaa;margin-top:4px}
/* KPI */
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.kpi-card{background:#1a1a1a;border-radius:8px;padding:14px;text-align:center}
.kpi-card .num{font-family:'Orbitron',sans-serif;font-size:24px;color:var(--green)}
.kpi-card .label{font-size:11px;color:#888;margin-top:4px}
.kpi-card.error .num{color:var(--red)}
/* Provider Stats */
.provider-stats{margin-top:10px}
.pstat-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #222;font-size:12px}
.pstat-item:last-child{border-bottom:none}
.pstat-name{width:70px;color:var(--blue)}
.pstat-bar{flex:1;height:6px;background:#222;border-radius:3px;overflow:hidden}
.pstat-bar-fill{height:100%;border-radius:3px;transition:width .5s}
.pstat-val{width:50px;text-align:right;font-family:'Orbitron',sans-serif;font-size:11px}
/* Buttons */
.btn-grid{display:flex;flex-direction:column;gap:10px}
.action-btn{border:none;border-radius:12px;padding:18px;font-size:15px;font-weight:700;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:transform .1s}
.action-btn:active{transform:scale(0.97)}
.btn-purge{background:linear-gradient(135deg,#ff3344,#cc0022)}
.btn-report{background:linear-gradient(135deg,#00aaff,#0066cc)}
.btn-defense{background:linear-gradient(135deg,#ffcc00,#cc9900);color:#000}
.action-btn .icon{font-size:22px}
.action-btn.loading{opacity:.6;pointer-events:none}
.action-result{background:#1a2a1a;border:1px solid var(--green);border-radius:8px;padding:10px;margin-top:8px;font-size:12px;color:var(--green);display:none}
.action-result.show{display:block}
.action-result.err{border-color:var(--red);color:var(--red);background:#2a1a1a}
/* Bottom nav */
.bottom-bar{position:fixed;bottom:0;left:0;right:0;background:#111;border-top:1px solid #333;display:flex;justify-content:space-around;padding:8px 0 env(safe-area-inset-bottom,8px);z-index:100}
.bottom-bar button{background:none;border:none;color:#666;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;padding:4px 12px}
.bottom-bar button.active{color:var(--green)}
.bottom-bar button .ico{font-size:20px}
.tab{display:none}.tab.active{display:block}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #333;border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay{text-align:center;padding:40px;color:#666}
.feed-item{background:#1a1a1a;border-radius:8px;padding:10px 12px;margin-bottom:6px;font-size:12px;transition:background .3s}
.feed-item.new{background:#112211;border:1px solid #334433}
.feed-item .time{color:var(--blue);font-weight:700}
.feed-item .q{color:#ccc;margin-top:4px}
.feed-item .a{color:#888;margin-top:2px;font-size:11px}
.feed-item .provider-tag{display:inline-block;font-size:9px;padding:1px 5px;border-radius:4px;background:#222;color:var(--green);margin-left:6px}
</style>
</head>
<body>

<div class="header">
  <h1>CEO DASHBOARD <span class="rt-badge disconnected" id="rtBadge">OFFLINE</span></h1>
  <div class="commander">æŒ‡æ®å®˜ï¼šè¨±ç«£ç¿”</div>
  <div class="time" id="headerTime">Loading...</div>
</div>

<!-- Tab: æˆ°æ³ -->
<div class="tab active" id="tab-status">
  <div class="section">
    <div class="section-title">A å…¨çƒæˆ°ç•¥åœ°åœ–</div>
    <div class="site-grid" id="siteGrid">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">B è»ç«åº«å­˜</div>
    <div class="arsenal-summary" id="arsenalSummary">
      <div class="big">--</div>
      <div class="label">Keys Active</div>
    </div>
    <div class="arsenal-list" id="arsenalList">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
  <!-- Fallback Alerts (hidden by default, shown when events exist) -->
  <div class="fallback-section" id="fallbackSection">
    <div class="fallback-title">FALLBACK ALERTS</div>
    <div id="fallbackList"></div>
  </div>
  <!-- Inference Violation Monitor (hidden by default) -->
  <div class="violation-section" id="violationSection">
    <div class="violation-title">INFERENCE VIOLATIONS</div>
    <div class="violation-count" id="violationCount">0</div>
    <div style="text-align:center;font-size:10px;color:#888;margin-bottom:10px">æ¨ç†è·¯å¾‘é•è¦å³æ™‚ç›£æ§</div>
    <div id="violationList"></div>
  </div>
  <!-- Global Latency Monitor -->
  <div class="latency-section">
    <div class="latency-title">GLOBAL LATENCY MONITOR</div>
    <div class="latency-grid" id="latencyGrid">
      <div style="grid-column:1/3;text-align:center;padding:10px;color:#666"><div class="spinner"></div></div>
    </div>
    <div class="provider-latency" id="providerLatency"></div>
  </div>
</div>

<!-- Tab: KPI -->
<div class="tab" id="tab-kpi">
  <div class="section">
    <div class="section-title">ä»Šæ—¥æ¥­ç¸¾</div>
    <div class="kpi-grid" id="kpiGrid">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">Provider å¯ç”¨åº¦ï¼ˆä»Šæ—¥ï¼‰</div>
    <div class="provider-stats" id="providerStats">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">å³æ™‚å®¢æˆ¶å‹•æ…‹ <span class="rt-badge connected" style="font-size:8px">LIVE</span></div>
    <div id="liveFeed">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- Tab: æ ¸æŒ‰éˆ• -->
<div class="tab" id="tab-actions">
  <div class="section">
    <div class="section-title">C æ ¸æŒ‰éˆ• ACTION CENTER</div>
    <div class="btn-grid">
      <button class="action-btn btn-purge" onclick="fireAction('action-purge',this)">
        <span class="icon">ğŸ”¥</span> å…¨ç¶²æ¸…æ´—
      </button>
      <div class="action-result" id="res-action-purge"></div>

      <button class="action-btn btn-report" onclick="fireAction('action-report',this)">
        <span class="icon">ğŸ“Š</span> ç”Ÿæˆæ—¥å ± â†’ æ¨é€æ‰‹æ©Ÿ
      </button>
      <div class="action-result" id="res-action-report"></div>

      <button class="action-btn btn-defense" onclick="fireAction('action-defense',this)">
        <span class="icon">ğŸ›¡ï¸</span> é˜²ç¦¦æ¨¡å¼
      </button>
      <div class="action-result" id="res-action-defense"></div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">æ“ä½œç´€éŒ„</div>
    <div id="actionLog">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-bar">
  <button class="active" onclick="switchTab('status',this)"><span class="ico">ğŸŒ</span>æˆ°æ³</button>
  <button onclick="switchTab('kpi',this)"><span class="ico">ğŸ“ˆ</span>æ¥­ç¸¾</button>
  <button onclick="switchTab('actions',this)"><span class="ico">ğŸ”´</span>æ ¸æŒ‰éˆ•</button>
</div>

<!-- Supabase JS for Realtime -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
const SB_URL='https://vmyrivxxibqydccurxug.supabase.co';
const FUNC_URL=SB_URL+'/functions/v1/ceo-dashboard';
const SK='%%SUPABASE_KEY%%';

// ===== Supabase Client (for Realtime) =====
const sb = window.supabase.createClient(SB_URL, SK);

// ===== Realtime State =====
let rtConnected = false;
let liveFeedData = [];
let fallbackAlerts = [];
let violationData = [];

function switchTab(name,btn){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.bottom-bar button').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  btn.classList.add('active');
  if(name==='kpi') loadKPI();
  if(name==='actions') loadActionLog();
}

function updateTime(){
  const now=new Date();
  const tw=new Date(now.getTime()+8*3600000);
  document.getElementById('headerTime').textContent=tw.toISOString().replace('T',' ').substring(0,19)+' (å°åŒ—)';
}
setInterval(updateTime,1000);updateTime();

async function api(action){
  const r=await fetch(FUNC_URL+'?action='+action,{headers:{'Authorization':'Bearer '+SK}});
  return r.json();
}

// ============================================================
// Realtime è¨‚é–±
// ============================================================
function setupRealtime() {
  const badge = document.getElementById('rtBadge');

  // ============================================================
  // ä½¿ç”¨ Broadcast Channelï¼ˆä¸ä¾è³´ WAL replicationï¼‰
  // ai-gateway ä¸»å‹•æ¨é€äº‹ä»¶åˆ° ceo-realtime channel
  // ============================================================
  const realtimeChannel = sb
    .channel('ceo-realtime')
    .on('broadcast', { event: 'new_log' }, (payload) => {
      const row = payload.payload;
      // åŠ åˆ° live feed é ‚éƒ¨
      liveFeedData.unshift(row);
      if (liveFeedData.length > 20) liveFeedData.pop();
      renderLiveFeed(row.session_id || 'new');
      // æ›´æ–° KPI è¨ˆæ•¸å™¨
      updateKPICounter(row.status);
    })
    .on('broadcast', { event: 'fallback_alert' }, (payload) => {
      const row = payload.payload;
      fallbackAlerts.unshift(row);
      if (fallbackAlerts.length > 10) fallbackAlerts.pop();
      renderFallbackAlerts();
    })
    .on('broadcast', { event: 'violation_alert' }, (payload) => {
      const row = payload.payload;
      violationData.unshift(row);
      if (violationData.length > 20) violationData.pop();
      renderViolations();
    })
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        rtConnected = true;
        badge.className = 'rt-badge connected';
        badge.textContent = 'LIVE';
      } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
        rtConnected = false;
        badge.className = 'rt-badge disconnected';
        badge.textContent = 'OFFLINE';
        // 5ç§’å¾Œé‡è©¦
        setTimeout(setupRealtime, 5000);
      }
    });
}

// ============================================================
// A å…¨çƒç‹€æ…‹
// ============================================================
async function loadGlobal(){
  try{
    const d=await api('global-status');
    const g=document.getElementById('siteGrid');
    g.innerHTML=d.sites.map(s=>`
      <div class="site-card">
        <div class="light ${s.color}" style="background:${s.color==='green'?'var(--green)':s.color==='red'?'var(--red)':'var(--yellow)'}"></div>
        <div class="name">${s.name}</div>
        <div class="ms">${s.latency_ms}ms</div>
      </div>
    `).join('');
  }catch(e){document.getElementById('siteGrid').innerHTML='<div style="color:red">è¼‰å…¥å¤±æ•—</div>'}
}

// ============================================================
// B è»ç«åº«
// ============================================================
async function loadArsenal(){
  try{
    const d=await api('arsenal');
    document.getElementById('arsenalSummary').innerHTML=`
      <div class="big" style="color:${d.health_pct>50?'var(--green)':d.health_pct>20?'var(--yellow)':'var(--red)'}">${d.health_pct}%</div>
      <div class="label">${d.summary}</div>
    `;
    const list=document.getElementById('arsenalList');
    list.innerHTML=d.keys.map(k=>`
      <div class="arsenal-item" id="arsenal-${k.provider.replace(/[^a-zA-Z]/g,'')}">
        <div class="dot" style="background:${k.color==='green'?'var(--green)':k.color==='red'?'var(--red)':'var(--yellow)'}"></div>
        <div class="provider">${k.provider}</div>
        <div class="status">${k.status==='active'?'ğŸŸ¢':''}${k.status==='missing'?'âŒ æœªè¨­å®š':k.status}</div>
      </div>
    `).join('');
  }catch(e){document.getElementById('arsenalList').innerHTML='<div style="color:red">è¼‰å…¥å¤±æ•—</div>'}
}

// ============================================================
// Fallback Alerts (Realtime)
// ============================================================
async function loadFallbackAlerts() {
  try {
    const { data } = await sb
      .from('system_health_checks')
      .select('*')
      .eq('check_type', 'ai_fallback')
      .order('checked_at', { ascending: false })
      .limit(10);
    fallbackAlerts = data || [];
    renderFallbackAlerts();
  } catch(e) { console.error('loadFallbackAlerts:', e); }
}

function renderFallbackAlerts() {
  const section = document.getElementById('fallbackSection');
  const list = document.getElementById('fallbackList');
  if (!fallbackAlerts.length) {
    section.classList.remove('show');
    return;
  }
  section.classList.add('show');
  list.innerHTML = fallbackAlerts.map(a => {
    const d = a.details || {};
    const failed = (d.failed_providers || []).map(p => p.provider).join(' â†’ ');
    const t = a.checked_at ? new Date(a.checked_at).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '--';
    return `
      <div class="fallback-item">
        <span class="fb-time">${t}</span>
        <span style="margin-left:8px;color:var(--yellow)">${failed}</span>
        <span style="color:var(--green)"> â†’ ${d.landed_on || '?'}</span>
        <span style="color:#666;margin-left:8px">${d.latencyMs || 0}ms</span>
        <div class="fb-detail">model: ${d.landed_model || '?'}</div>
      </div>`;
  }).join('');
}

// ============================================================
// Violation Monitor æ¸²æŸ“
// ============================================================
function renderViolations() {
  const section = document.getElementById('violationSection');
  const list = document.getElementById('violationList');
  const countEl = document.getElementById('violationCount');
  if (!violationData.length) {
    section.classList.remove('show');
    return;
  }
  section.classList.add('show');
  countEl.textContent = violationData.length;
  list.innerHTML = violationData.map(v => {
    const t = v.timestamp ? new Date(v.timestamp).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '--';
    return `
      <div class="violation-item">
        <div class="path">${(v.from_node||'?').substring(0,8)}... â†’ AI inference</div>
        <div class="reason">${v.reason || 'unknown violation'}</div>
        <div class="time">${t}</div>
      </div>`;
  }).join('');
}

// Load existing violations on startup
async function loadViolations() {
  try {
    const r = await fetch(SB_URL+'/functions/v1/world-definition?action=violations&limit=10', {headers:{'Authorization':'Bearer '+SK}});
    const d = await r.json();
    if (d.violations && d.violations.length) {
      violationData = d.violations.map(v => ({from_node:v.from_node, reason:v.reason, timestamp:v.created_at}));
      renderViolations();
    }
  } catch(e) { console.warn('Failed to load violations:', e); }
}

// ============================================================
// KPI + Provider å¯ç”¨åº¦
// ============================================================
let kpiCounters = { total: 0, success: 0, errors: 0, blocked: 0 };

function updateKPICounter(status) {
  kpiCounters.total++;
  if (status === 'success') kpiCounters.success++;
  else if (status === 'error') kpiCounters.errors++;
  else if (status === 'blocked') kpiCounters.blocked++;
  // å¦‚æœ KPI tab å¯è¦‹ï¼Œå³æ™‚æ›´æ–°æ•¸å­—
  const grid = document.getElementById('kpiGrid');
  if (grid && grid.dataset.loaded === '1') renderKPI();
}

function renderKPI() {
  const k = kpiCounters;
  const rate = k.total > 0 ? ((k.errors / k.total) * 100).toFixed(1) + '%' : '0%';
  document.getElementById('kpiGrid').innerHTML = `
    <div class="kpi-card"><div class="num">${k.total}</div><div class="label">ä»Šæ—¥å°è©±æ•¸</div></div>
    <div class="kpi-card"><div class="num">${k.success}</div><div class="label">æˆåŠŸ</div></div>
    <div class="kpi-card error"><div class="num">${k.errors}</div><div class="label">éŒ¯èª¤</div></div>
    <div class="kpi-card"><div class="num">${rate}</div><div class="label">æ•…éšœç‡</div></div>
  `;
  document.getElementById('kpiGrid').dataset.loaded = '1';
}

async function loadKPI(){
  try{
    const d=await api('daily-report');
    kpiCounters = {
      total: d.kpi.total_conversations,
      success: d.kpi.success,
      errors: d.kpi.errors,
      blocked: d.kpi.blocked,
    };
    renderKPI();

    // Provider å¯ç”¨åº¦ â€” å¾ ai_customer_logs.response çµ±è¨ˆ
    await loadProviderStats();

    // åˆå§‹è¼‰å…¥ live feed
    await loadInitialFeed();
  }catch(e){document.getElementById('kpiGrid').innerHTML='<div style="color:red">è¼‰å…¥å¤±æ•—</div>'}
}

async function loadProviderStats() {
  try {
    const today = new Date().toISOString().split('T')[0];
    const { data } = await sb
      .from('ai_customer_logs')
      .select('status, response')
      .gte('created_at', today);

    if (!data || !data.length) {
      document.getElementById('providerStats').innerHTML = '<div style="color:#666;text-align:center;padding:10px">ä»Šæ—¥æš«ç„¡æ•¸æ“š</div>';
      return;
    }

    // çµ±è¨ˆæ¯å€‹ provider çš„æˆåŠŸ/å¤±æ•—æ¬¡æ•¸
    const stats = {};
    data.forEach(row => {
      const provider = row.response?.provider || 'unknown';
      if (!stats[provider]) stats[provider] = { ok: 0, fail: 0 };
      if (row.status === 'success') stats[provider].ok++;
      else if (row.status === 'error') stats[provider].fail++;
    });

    const el = document.getElementById('providerStats');
    el.innerHTML = Object.entries(stats)
      .sort((a, b) => (b[1].ok + b[1].fail) - (a[1].ok + a[1].fail))
      .map(([name, s]) => {
        const total = s.ok + s.fail;
        const pct = total > 0 ? Math.round((s.ok / total) * 100) : 0;
        const color = pct >= 95 ? 'var(--green)' : pct >= 80 ? 'var(--yellow)' : 'var(--red)';
        return `
          <div class="pstat-item">
            <span class="pstat-name">${name}</span>
            <div class="pstat-bar"><div class="pstat-bar-fill" style="width:${pct}%;background:${color}"></div></div>
            <span class="pstat-val" style="color:${color}">${pct}%</span>
          </div>`;
      }).join('');
  } catch(e) {
    document.getElementById('providerStats').innerHTML = '<div style="color:red">è¼‰å…¥å¤±æ•—</div>';
  }
}

// ============================================================
// Live Feed (åˆå§‹è¼‰å…¥ + Realtime æ›´æ–°)
// ============================================================
async function loadInitialFeed() {
  try {
    const { data } = await sb
      .from('ai_customer_logs')
      .select('id, created_at, input_text, output_text, status, response')
      .order('created_at', { ascending: false })
      .limit(15);
    liveFeedData = data || [];
    renderLiveFeed(null);
  } catch(e) { console.error('loadInitialFeed:', e); }
}

function renderLiveFeed(newId) {
  const el = document.getElementById('liveFeed');
  if (!liveFeedData.length) {
    el.innerHTML = '<div style="color:#666;text-align:center;padding:20px">ä»Šå¤©æš«ç„¡å®¢æˆ¶å°è©±</div>';
    return;
  }
  el.innerHTML = liveFeedData.map(l => {
    const isNew = l.id === newId;
    const t = l.created_at ? new Date(l.created_at).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '--';
    const provider = l.response?.provider || '';
    const latency = l.response?.latencyMs ? `${l.response.latencyMs}ms` : '';
    const statusColor = l.status==='success'?'var(--green)':l.status==='error'?'var(--red)':'var(--yellow)';
    return `
      <div class="feed-item ${isNew?'new':''}">
        <span class="time">${t}</span>
        <span style="margin-left:8px;color:${statusColor}">[${l.status||'--'}]</span>
        ${provider ? `<span class="provider-tag">${provider} ${latency}</span>` : ''}
        <div class="q">ğŸ“© ${(l.input_text||'').substring(0,50)||'(ç„¡)'}</div>
        <div class="a">ğŸ’¬ ${(l.output_text||'').substring(0,50)||'(ç„¡)'}</div>
      </div>`;
  }).join('');

  // æ–°è¨Šæ¯é–ƒçˆæ•ˆæœ
  if (newId) {
    setTimeout(() => {
      document.querySelectorAll('.feed-item.new').forEach(el => el.classList.remove('new'));
    }, 2000);
  }
}

// ============================================================
// æ ¸æŒ‰éˆ•
// ============================================================
async function fireAction(action,btn){
  btn.classList.add('loading');
  btn.innerHTML='<div class="spinner"></div> åŸ·è¡Œä¸­...';
  const resEl=document.getElementById('res-'+action);
  try{
    const d=await api(action);
    resEl.className='action-result show';
    resEl.textContent='âœ… '+JSON.stringify(d.message||d.action||'å®Œæˆ');
  }catch(e){
    resEl.className='action-result show err';
    resEl.textContent='âŒ å¤±æ•—: '+e.message;
  }
  btn.classList.remove('loading');
  btn.innerHTML=action==='action-purge'?'<span class="icon">ğŸ”¥</span> å…¨ç¶²æ¸…æ´—':
    action==='action-report'?'<span class="icon">ğŸ“Š</span> ç”Ÿæˆæ—¥å ± â†’ æ¨é€æ‰‹æ©Ÿ':
    '<span class="icon">ğŸ›¡ï¸</span> é˜²ç¦¦æ¨¡å¼';
}

// ============================================================
// Action Log
// ============================================================
async function loadActionLog(){
  try{
    const r=await fetch(SB_URL+'/rest/v1/configs?service=eq.ceo-dashboard&order=created_at.desc&limit=10',{
      headers:{'apikey':SK,'Authorization':'Bearer '+SK}
    });
    const logs=await r.json();
    document.getElementById('actionLog').innerHTML=logs.length?logs.map(l=>`
      <div class="feed-item">
        <span class="time">${new Date(l.created_at).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'})}</span>
        <span style="margin-left:8px;color:var(--gold)">${l.key}</span>
        <div class="q" style="color:var(--green)">${l.value}</div>
      </div>
    `).join(''):'<div style="color:#666;text-align:center;padding:20px">å°šç„¡æ“ä½œç´€éŒ„</div>';
  }catch(e){document.getElementById('actionLog').innerHTML='<div style="color:red">è¼‰å…¥å¤±æ•—</div>'}
}

// ============================================================
// Global Latency Monitor
// ============================================================
async function loadLatencyMonitor() {
  try {
    const r = await fetch(SB_URL+'/functions/v1/world-definition?action=latency-monitor&hours=24', {headers:{'Authorization':'Bearer '+SK}});
    const d = await r.json();
    const grid = document.getElementById('latencyGrid');
    const regions = Object.entries(d.by_region || {});
    if (!regions.length) {
      grid.innerHTML = '<div style="grid-column:1/3;text-align:center;padding:10px;color:#666">æš«ç„¡å»¶é²æ•¸æ“šï¼ˆéœ€æœ‰ AI å°è©±æµé‡ï¼‰</div>';
    } else {
      grid.innerHTML = regions.map(([region, s]) => {
        const color = s.avg_ms < 2000 ? 'var(--green)' : s.avg_ms < 4000 ? 'var(--yellow)' : 'var(--red)';
        return `
          <div class="latency-card">
            <div class="region">${region.toUpperCase()}</div>
            <div class="avg" style="color:${color}">${s.avg_ms}ms</div>
            <div class="p95">P95: ${s.p95_ms}ms</div>
            <div class="count">${s.count} requests</div>
          </div>`;
      }).join('');
    }
    // Provider latency breakdown
    const providers = Object.entries(d.by_provider || {});
    const plEl = document.getElementById('providerLatency');
    if (providers.length) {
      const maxMs = Math.max(...providers.map(([,s]) => s.avg_ms), 1);
      plEl.innerHTML = '<div style="font-size:11px;color:#00dddd;margin-bottom:6px;font-family:Orbitron">Provider Avg Latency</div>' +
        providers.sort((a,b) => a[1].avg_ms - b[1].avg_ms).map(([name, s]) => {
          const pct = Math.round((s.avg_ms / maxMs) * 100);
          const color = s.avg_ms < 2000 ? 'var(--green)' : s.avg_ms < 4000 ? 'var(--yellow)' : 'var(--red)';
          return `
            <div class="plat-item">
              <span class="plat-name">${name}</span>
              <div class="plat-bar"><div class="plat-bar-fill" style="width:${pct}%;background:${color}"></div></div>
              <span class="plat-val" style="color:${color}">${s.avg_ms}ms</span>
            </div>`;
        }).join('');
    }
  } catch(e) { console.warn('Failed to load latency:', e); }
}

// ============================================================
// åˆå§‹è¼‰å…¥ + å•Ÿå‹• Realtime
// ============================================================
loadGlobal();
loadArsenal();
loadFallbackAlerts();
loadViolations();
loadLatencyMonitor();
setupRealtime();

// 30ç§’è‡ªå‹•åˆ·æ–°å…¨çƒç‹€æ…‹å’Œè»ç«åº«ï¼ˆéœæ…‹æ•¸æ“šå‚™æ´ï¼‰
setInterval(()=>{loadGlobal();loadArsenal()},30000);
// 60ç§’è‡ªå‹•åˆ·æ–°å»¶é²ç›£æ§
setInterval(loadLatencyMonitor,60000);
</script>
</body>
</html>
