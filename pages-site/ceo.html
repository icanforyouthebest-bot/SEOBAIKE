<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CEOæˆ°æƒ…å®¤">
<meta name="theme-color" content="#0a0a0a">
<link rel="manifest" href="/manifest.json">
<title>CEO æˆ°æƒ…å®¤ | SEOBAIKE</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0a;--card:#111;--green:#00ff88;--red:#ff3344;--yellow:#ffcc00;--blue:#00aaff;--text:#e0e0e0;--gold:#ffd700}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans TC',sans-serif;min-height:100vh;overflow-x:hidden;padding-bottom:80px}
.header{background:linear-gradient(135deg,#111 0%,#1a1a2e 100%);padding:16px;text-align:center;border-bottom:2px solid var(--green);position:sticky;top:0;z-index:100}
.header h1{font-family:'Orbitron',sans-serif;font-size:18px;color:var(--green);letter-spacing:2px}
.header .commander{color:var(--gold);font-size:14px;margin-top:4px}
.header .time{color:#666;font-size:11px;margin-top:2px}
.section{margin:12px;background:var(--card);border-radius:12px;padding:16px;border:1px solid #222}
.section-title{font-family:'Orbitron',sans-serif;font-size:13px;color:var(--blue);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.section-title::before{content:'';width:4px;height:16px;background:var(--blue);border-radius:2px}
/* Status Cards */
.site-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.site-card{background:#1a1a1a;border-radius:8px;padding:12px 8px;text-align:center;border:1px solid #333}
.site-card .light{width:20px;height:20px;border-radius:50%;margin:0 auto 6px;box-shadow:0 0 8px currentColor}
.site-card .name{font-size:11px;color:#aaa;word-break:break-all}
.site-card .ms{font-size:10px;color:#666;margin-top:2px}
.green{color:var(--green);background:var(--green)}
.red{color:var(--red);background:var(--red)}
.yellow{color:var(--yellow);background:var(--yellow)}
/* Arsenal */
.arsenal-list{display:flex;flex-direction:column;gap:6px}
.arsenal-item{display:flex;align-items:center;gap:10px;background:#1a1a1a;border-radius:8px;padding:10px 12px}
.arsenal-item .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.arsenal-item .provider{flex:1;font-size:13px}
.arsenal-item .status{font-size:11px;color:#888}
.arsenal-summary{background:linear-gradient(135deg,#1a2a1a,#111);border-radius:8px;padding:14px;text-align:center;margin-bottom:10px;border:1px solid #2a3a2a}
.arsenal-summary .big{font-family:'Orbitron',sans-serif;font-size:28px;color:var(--green)}
.arsenal-summary .label{font-size:11px;color:#888;margin-top:2px}
/* KPI */
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.kpi-card{background:#1a1a1a;border-radius:8px;padding:14px;text-align:center}
.kpi-card .num{font-family:'Orbitron',sans-serif;font-size:24px;color:var(--green)}
.kpi-card .label{font-size:11px;color:#888;margin-top:4px}
.kpi-card.error .num{color:var(--red)}
/* Buttons */
.btn-grid{display:flex;flex-direction:column;gap:10px}
.action-btn{border:none;border-radius:12px;padding:18px;font-size:15px;font-weight:700;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:transform .1s}
.action-btn:active{transform:scale(0.97)}
.btn-purge{background:linear-gradient(135deg,#ff3344,#cc0022)}
.btn-report{background:linear-gradient(135deg,#00aaff,#0066cc)}
.btn-defense{background:linear-gradient(135deg,#ffcc00,#cc9900);color:#000}
.action-btn .icon{font-size:22px}
.action-btn.loading{opacity:.6;pointer-events:none}
/* Action result */
.action-result{background:#1a2a1a;border:1px solid var(--green);border-radius:8px;padding:10px;margin-top:8px;font-size:12px;color:var(--green);display:none}
.action-result.show{display:block}
.action-result.err{border-color:var(--red);color:var(--red);background:#2a1a1a}
/* Bottom nav */
.bottom-bar{position:fixed;bottom:0;left:0;right:0;background:#111;border-top:1px solid #333;display:flex;justify-content:space-around;padding:8px 0 env(safe-area-inset-bottom,8px);z-index:100}
.bottom-bar button{background:none;border:none;color:#666;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;padding:4px 12px}
.bottom-bar button.active{color:var(--green)}
.bottom-bar button .ico{font-size:20px}
/* Tab content */
.tab{display:none}.tab.active{display:block}
/* Loading */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #333;border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay{text-align:center;padding:40px;color:#666}
/* Live feed */
.feed-item{background:#1a1a1a;border-radius:8px;padding:10px 12px;margin-bottom:6px;font-size:12px}
.feed-item .time{color:var(--blue);font-weight:700}
.feed-item .q{color:#ccc;margin-top:4px}
.feed-item .a{color:#888;margin-top:2px;font-size:11px}
</style>
</head>
<body>

<div class="header">
  <h1>CEO DASHBOARD</h1>
  <div class="commander">æŒ‡æ®å®˜ï¼šè¨±ç«£ç¿”</div>
  <div class="time" id="headerTime">Loading...</div>
</div>

<!-- Tab: æˆ°æ³ -->
<div class="tab active" id="tab-status">
  <div class="section">
    <div class="section-title">A å…¨çƒæˆ°ç•¥åœ°åœ–</div>
    <div class="site-grid" id="siteGrid">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">B è»ç«åº«å­˜</div>
    <div class="arsenal-summary" id="arsenalSummary">
      <div class="big">--</div>
      <div class="label">Keys Active</div>
    </div>
    <div class="arsenal-list" id="arsenalList">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- Tab: KPI -->
<div class="tab" id="tab-kpi">
  <div class="section">
    <div class="section-title">ä»Šæ—¥æ¥­ç¸¾</div>
    <div class="kpi-grid" id="kpiGrid">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">å³æ™‚å®¢æˆ¶å‹•æ…‹</div>
    <div id="liveFeed">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- Tab: æ ¸æŒ‰éˆ• -->
<div class="tab" id="tab-actions">
  <div class="section">
    <div class="section-title">C æ ¸æŒ‰éˆ• ACTION CENTER</div>
    <div class="btn-grid">
      <button class="action-btn btn-purge" onclick="fireAction('action-purge',this)">
        <span class="icon">ğŸ”¥</span> å…¨ç¶²æ¸…æ´—
      </button>
      <div class="action-result" id="res-action-purge"></div>

      <button class="action-btn btn-report" onclick="fireAction('action-report',this)">
        <span class="icon">ğŸ“Š</span> ç”Ÿæˆæ—¥å ± â†’ æ¨é€æ‰‹æ©Ÿ
      </button>
      <div class="action-result" id="res-action-report"></div>

      <button class="action-btn btn-defense" onclick="fireAction('action-defense',this)">
        <span class="icon">ğŸ›¡ï¸</span> é˜²ç¦¦æ¨¡å¼
      </button>
      <div class="action-result" id="res-action-defense"></div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">æ“ä½œç´€éŒ„</div>
    <div id="actionLog">
      <div class="loading-overlay"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-bar">
  <button class="active" onclick="switchTab('status',this)"><span class="ico">ğŸŒ</span>æˆ°æ³</button>
  <button onclick="switchTab('kpi',this)"><span class="ico">ğŸ“ˆ</span>æ¥­ç¸¾</button>
  <button onclick="switchTab('actions',this)"><span class="ico">ğŸ”´</span>æ ¸æŒ‰éˆ•</button>
</div>

<script>
const SB_URL='https://vmyrivxxibqydccurxug.supabase.co';
const FUNC_URL=SB_URL+'/functions/v1/ceo-dashboard';
const SK='%%SUPABASE_KEY%%';

function switchTab(name,btn){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.bottom-bar button').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  btn.classList.add('active');
  if(name==='kpi') loadKPI();
  if(name==='actions') loadActionLog();
}

function updateTime(){
  const now=new Date();
  const tw=new Date(now.getTime()+8*3600000);
  document.getElementById('headerTime').textContent=tw.toISOString().replace('T',' ').substring(0,19)+' (å°åŒ—)';
}
setInterval(updateTime,1000);updateTime();

async function api(action){
  const r=await fetch(FUNC_URL+'?action='+action,{headers:{'Authorization':'Bearer '+SK}});
  return r.json();
}

// ===== A å…¨çƒç‹€æ…‹ =====
async function loadGlobal(){
  try{
    const d=await api('global-status');
    const g=document.getElementById('siteGrid');
    g.innerHTML=d.sites.map(s=>`
      <div class="site-card">
        <div class="light ${s.color}" style="background:${s.color==='green'?'var(--green)':s.color==='red'?'var(--red)':'var(--yellow)'}"></div>
        <div class="name">${s.name}</div>
        <div class="ms">${s.latency_ms}ms</div>
      </div>
    `).join('');
  }catch(e){document.getElementById('siteGrid').innerHTML='<div style="color:red">è¼‰å…¥å¤±æ•—</div>'}
}

// ===== B è»ç«åº« =====
async function loadArsenal(){
  try{
    const d=await api('arsenal');
    document.getElementById('arsenalSummary').innerHTML=`
      <div class="big" style="color:${d.health_pct>50?'var(--green)':d.health_pct>20?'var(--yellow)':'var(--red)'}">${d.health_pct}%</div>
      <div class="label">${d.summary}</div>
    `;
    const list=document.getElementById('arsenalList');
    list.innerHTML=d.keys.map(k=>`
      <div class="arsenal-item">
        <div class="dot" style="background:${k.color==='green'?'var(--green)':k.color==='red'?'var(--red)':'var(--yellow)'}"></div>
        <div class="provider">${k.provider}</div>
        <div class="status">${k.status==='active'?'ğŸŸ¢':''}${k.status==='missing'?'âŒ æœªè¨­å®š':k.status}</div>
      </div>
    `).join('');
  }catch(e){document.getElementById('arsenalList').innerHTML='<div style="color:red">è¼‰å…¥å¤±æ•—</div>'}
}

// ===== KPI =====
async function loadKPI(){
  try{
    const d=await api('daily-report');
    document.getElementById('kpiGrid').innerHTML=`
      <div class="kpi-card"><div class="num">${d.kpi.total_conversations}</div><div class="label">ä»Šæ—¥å°è©±æ•¸</div></div>
      <div class="kpi-card"><div class="num">${d.kpi.success}</div><div class="label">æˆåŠŸ</div></div>
      <div class="kpi-card error"><div class="num">${d.kpi.errors}</div><div class="label">éŒ¯èª¤</div></div>
      <div class="kpi-card"><div class="num">${d.kpi.error_rate}</div><div class="label">æ•…éšœç‡</div></div>
    `;
    // Live feed
    const r2=await fetch(SB_URL+'/rest/v1/ai_customer_logs?select=created_at,input_text,output_text,status&order=created_at.desc&limit=10',{
      headers:{'apikey':SK,'Authorization':'Bearer '+SK}
    });
    const logs=await r2.json();
    document.getElementById('liveFeed').innerHTML=logs.length?logs.map(l=>`
      <div class="feed-item">
        <span class="time">${l.created_at?new Date(l.created_at).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'}):'--'}</span>
        <span style="margin-left:8px;color:${l.status==='success'?'var(--green)':l.status==='error'?'var(--red)':'var(--yellow)'}">[${l.status||'--'}]</span>
        <div class="q">ğŸ“© ${(l.input_text||'').substring(0,40)||'(ç„¡)'}</div>
        <div class="a">ğŸ’¬ ${(l.output_text||'').substring(0,40)||'(ç„¡)'}</div>
      </div>
    `).join(''):'<div style="color:#666;text-align:center;padding:20px">ä»Šå¤©æš«ç„¡å®¢æˆ¶å°è©±</div>';
  }catch(e){document.getElementById('kpiGrid').innerHTML='<div style="color:red">è¼‰å…¥å¤±æ•—</div>'}
}

// ===== æ ¸æŒ‰éˆ• =====
async function fireAction(action,btn){
  btn.classList.add('loading');
  btn.innerHTML='<div class="spinner"></div> åŸ·è¡Œä¸­...';
  const resEl=document.getElementById('res-'+action);
  try{
    const d=await api(action);
    resEl.className='action-result show';
    resEl.textContent='âœ… '+JSON.stringify(d.message||d.action||'å®Œæˆ');
  }catch(e){
    resEl.className='action-result show err';
    resEl.textContent='âŒ å¤±æ•—: '+e.message;
  }
  btn.classList.remove('loading');
  btn.innerHTML=action==='action-purge'?'<span class="icon">ğŸ”¥</span> å…¨ç¶²æ¸…æ´—':
    action==='action-report'?'<span class="icon">ğŸ“Š</span> ç”Ÿæˆæ—¥å ± â†’ æ¨é€æ‰‹æ©Ÿ':
    '<span class="icon">ğŸ›¡ï¸</span> é˜²ç¦¦æ¨¡å¼';
}

// ===== Action Log =====
async function loadActionLog(){
  try{
    const r=await fetch(SB_URL+'/rest/v1/configs?service=eq.ceo-dashboard&order=created_at.desc&limit=10',{
      headers:{'apikey':SK,'Authorization':'Bearer '+SK}
    });
    const logs=await r.json();
    document.getElementById('actionLog').innerHTML=logs.length?logs.map(l=>`
      <div class="feed-item">
        <span class="time">${new Date(l.created_at).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'})}</span>
        <span style="margin-left:8px;color:var(--gold)">${l.key}</span>
        <div class="q" style="color:var(--green)">${l.value}</div>
      </div>
    `).join(''):'<div style="color:#666;text-align:center;padding:20px">å°šç„¡æ“ä½œç´€éŒ„</div>';
  }catch(e){document.getElementById('actionLog').innerHTML='<div style="color:red">è¼‰å…¥å¤±æ•—</div>'}
}

// ===== åˆå§‹è¼‰å…¥ =====
loadGlobal();
loadArsenal();
// 30ç§’è‡ªå‹•åˆ·æ–°
setInterval(()=>{loadGlobal();loadArsenal()},30000);
</script>
</body>
</html>
