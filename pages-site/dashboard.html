<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEOBAIKE — 即時儀錶板</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; background: #0a0a1a; color: #eee; min-height: 100vh; }
.header { background: linear-gradient(135deg, #76b900 0%, #cc785c 50%, #1a1a2e 100%); padding: 16px 30px; display: flex; align-items: center; gap: 14px; }
.header h1 { font-size: 24px; color: #fff; }
.badge { padding: 5px 12px; border-radius: 14px; font-size: 12px; font-weight: bold; }
.live-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #0f0; animation: pulse 1s infinite; margin-right: 6px; }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.2; } }
@keyframes slideIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
.grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 20px 30px; }
.card { background: linear-gradient(135deg, #16213e, #1a1a2e); border: 1px solid #333; border-radius: 16px; padding: 20px; text-align: center; transition: all 0.3s; }
.card:hover { border-color: #76b900; transform: translateY(-2px); }
.card .num { font-size: 42px; font-weight: bold; color: #76b900; transition: all 0.5s; }
.card .num.changed { animation: slideIn 0.5s; color: #fff; }
.card .lbl { font-size: 13px; color: #888; margin-top: 6px; }
.engines { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0 30px 16px; }
.engine { background: #16213e; border: 1px solid #333; border-radius: 16px; padding: 20px; }
.engine h3 { font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.engine .status { display: inline-block; width: 12px; height: 12px; border-radius: 50%; }
.engine .ok { background: #76b900; }
.engine .fail { background: #ff4444; }
.engine .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.engine .stat { text-align: center; }
.engine .stat .val { font-size: 28px; font-weight: bold; }
.engine .stat .key { font-size: 11px; color: #888; }
.bar-container { margin-top: 10px; background: #0a0a1a; border-radius: 8px; height: 8px; overflow: hidden; }
.bar { height: 100%; border-radius: 8px; transition: width 0.5s; }
.bar.green { background: linear-gradient(90deg, #76b900, #8ed100); }
.bar.orange { background: linear-gradient(90deg, #e8850c, #ffa040); }
.log-section { padding: 0 30px 20px; }
.log-section h3 { font-size: 14px; color: #76b900; margin-bottom: 8px; }
.log { background: #0d1117; border: 1px solid #222; border-radius: 12px; padding: 12px 16px; max-height: 200px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.8; }
.log .entry { animation: slideIn 0.3s; }
.log .ok { color: #76b900; }
.log .err { color: #ff6b6b; }
.log .ts { color: #555; }
.routes { padding: 0 30px 20px; }
.routes h3 { font-size: 14px; color: #cc785c; margin-bottom: 8px; }
.route-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px; }
.route { background: #16213e; border: 1px solid #222; border-radius: 10px; padding: 10px 14px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
.route .name { color: #e8850c; font-weight: bold; }
.route .path { color: #888; }
.footer { text-align: center; padding: 16px; color: #333; font-size: 11px; }

/* === Navigation Bar === */
.nav-bar { display: flex; gap: 0; padding: 0 30px; background: #0d1117; border-bottom: 1px solid #222; }
.nav-bar a { color: #888; text-decoration: none; padding: 10px 18px; font-size: 13px; font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.2s; }
.nav-bar a:hover { color: #e8850c; border-bottom-color: #e8850c; }
.nav-bar a.active { color: #e8850c; border-bottom-color: #e8850c; }

/* === Marketplace Overview Section === */
.section-title { padding: 20px 30px 10px; font-size: 16px; color: #e8850c; font-weight: 700; display: flex; align-items: center; gap: 8px; }
.section-title .st-icon { font-size: 20px; }
.section-title .st-sub { font-size: 11px; color: #555; font-weight: normal; margin-left: 8px; }

.marketplace-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 0 30px 16px; }
.mp-card { background: linear-gradient(135deg, #16213e, #1a1a2e); border: 1px solid #333; border-radius: 16px; padding: 20px; text-align: center; transition: all 0.3s; }
.mp-card:hover { border-color: #e8850c; transform: translateY(-2px); }
.mp-card .mp-num { font-size: 36px; font-weight: bold; color: #e8850c; transition: all 0.5s; }
.mp-card .mp-num.changed { animation: slideIn 0.5s; color: #fff; }
.mp-card .mp-lbl { font-size: 13px; color: #888; margin-top: 6px; }
.mp-card .mp-sub { font-size: 10px; color: #555; margin-top: 4px; }

/* === Featured Tools Section === */
.featured-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px; padding: 0 30px 20px; }
.featured-card { background: linear-gradient(135deg, #1a1530, #16213e); border: 1px solid #333; border-radius: 14px; padding: 18px; transition: all 0.3s; position: relative; overflow: hidden; }
.featured-card:hover { border-color: #76b900; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(118,185,0,0.1); }
.featured-card .fc-badge { position: absolute; top: 10px; right: 10px; background: #e8850c; color: #000; font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 8px; }
.featured-card .fc-name { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 4px; }
.featured-card .fc-desc { font-size: 11px; color: #888; line-height: 1.5; margin-bottom: 10px; max-height: 36px; overflow: hidden; }
.featured-card .fc-meta { display: flex; gap: 14px; font-size: 11px; }
.featured-card .fc-meta span { color: #76b900; font-weight: 600; }
.featured-card .fc-meta .fc-label { color: #555; font-weight: normal; }
.featured-card .fc-price { margin-top: 8px; font-size: 14px; font-weight: bold; color: #cc785c; }
.featured-card .fc-creator { font-size: 10px; color: #555; margin-top: 6px; }

/* === Bot Status Row === */
.bot-status-row { display: flex; align-items: center; gap: 16px; padding: 0 30px 20px; flex-wrap: wrap; }
.bot-summary-card { background: linear-gradient(135deg, #16213e, #1a1a2e); border: 1px solid #333; border-radius: 14px; padding: 16px 24px; display: flex; align-items: center; gap: 14px; flex: 1; min-width: 220px; transition: all 0.3s; }
.bot-summary-card:hover { border-color: #76b900; }
.bot-summary-card .bot-icon { font-size: 28px; }
.bot-summary-card .bot-info { flex: 1; }
.bot-summary-card .bot-title { font-size: 14px; font-weight: 700; color: #fff; }
.bot-summary-card .bot-stat { font-size: 12px; color: #888; margin-top: 2px; }
.bot-summary-card .bot-stat .online { color: #76b900; font-weight: bold; }
.bot-summary-card .bot-stat .total { color: #cc785c; font-weight: bold; }
.bot-summary-card .bot-dots { display: flex; gap: 4px; flex-wrap: wrap; }
.bot-summary-card .bot-dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid #333; }
.bot-summary-card .bot-dot.on { background: #76b900; border-color: #76b900; box-shadow: 0 0 6px rgba(118,185,0,0.5); }
.bot-summary-card .bot-dot.off { background: #333; }
.bot-detail-card { background: linear-gradient(135deg, #16213e, #1a1a2e); border: 1px solid #333; border-radius: 14px; padding: 14px 20px; min-width: 160px; text-align: center; transition: all 0.3s; }
.bot-detail-card:hover { border-color: #e8850c; }
.bot-detail-card .bd-num { font-size: 28px; font-weight: bold; color: #76b900; }
.bot-detail-card .bd-lbl { font-size: 11px; color: #888; margin-top: 2px; }

/* === Commission Model Display === */
.commission-table { padding: 0 30px 20px; }
.commission-table table { width: 100%; background: #0d1117; border: 1px solid #222; border-radius: 12px; overflow: hidden; border-collapse: collapse; font-size: 12px; }
.commission-table th { background: #16213e; color: #cc785c; text-align: left; padding: 8px 14px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; }
.commission-table td { padding: 7px 14px; border-top: 1px solid #1a1a2e; color: #ccc; }
.commission-table tr:hover td { background: rgba(232,133,12,0.05); }
.commission-table .cm-type { color: #e8850c; font-weight: 600; }
.commission-table .cm-rate { color: #76b900; font-weight: 700; font-size: 14px; }

/* === Real-Time Data Panels === */
.data-panels { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 0 30px 16px; }
.data-panel { background: linear-gradient(135deg, #16213e, #1a1a2e); border: 1px solid #333; border-radius: 16px; padding: 20px; position: relative; overflow: hidden; }
.data-panel:hover { border-color: #e8850c; }
.data-panel h3 { font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: #e8850c; }
.data-panel h3 .icon { font-size: 18px; }
.data-panel .big-num { font-size: 36px; font-weight: bold; color: #76b900; line-height: 1.2; }
.data-panel .sub-stats { display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap; }
.data-panel .sub-stat { text-align: center; flex: 1; min-width: 60px; }
.data-panel .sub-stat .sv { font-size: 20px; font-weight: bold; color: #cc785c; }
.data-panel .sub-stat .sk { font-size: 10px; color: #888; margin-top: 2px; }
.data-panel .status-badge { display: inline-block; padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: bold; margin-top: 8px; }
.data-panel .status-ok { background: rgba(118,185,0,0.15); color: #76b900; border: 1px solid #76b900; }
.data-panel .status-down { background: rgba(255,68,68,0.15); color: #ff4444; border: 1px solid #ff4444; }
.data-panel .status-loading { background: rgba(232,133,12,0.15); color: #e8850c; border: 1px solid #e8850c; }
.data-panel .recent-list { list-style: none; margin-top: 10px; max-height: 120px; overflow-y: auto; }
.data-panel .recent-list li { font-size: 11px; padding: 3px 0; border-bottom: 1px solid #1a1a2e; display: flex; justify-content: space-between; gap: 6px; }
.data-panel .recent-list li .rp { color: #76b900; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
.data-panel .recent-list li .rt { color: #555; white-space: nowrap; font-size: 10px; }
.refresh-indicator { position: absolute; top: 8px; right: 12px; font-size: 10px; color: #444; }
.refresh-indicator.active { color: #e8850c; }
@keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
.spinner { display: inline-block; animation: spin 1s linear infinite; }

/* Live Activity Feed */
.activity-feed { padding: 0 30px 20px; }
.activity-feed h3 { font-size: 14px; color: #76b900; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.activity-feed h3 .auto-label { font-size: 11px; color: #555; font-weight: normal; }
.feed-table { width: 100%; background: #0d1117; border: 1px solid #222; border-radius: 12px; overflow: hidden; }
.feed-table table { width: 100%; border-collapse: collapse; font-size: 12px; }
.feed-table th { background: #16213e; color: #e8850c; text-align: left; padding: 8px 12px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; }
.feed-table td { padding: 6px 12px; border-top: 1px solid #1a1a2e; color: #ccc; }
.feed-table tr:hover td { background: rgba(118,185,0,0.05); }
.feed-table .fp { color: #76b900; font-weight: 600; }
.feed-table .fts { color: #888; font-size: 11px; }
.feed-table .fua { color: #555; font-size: 10px; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.feed-table .fc { color: #cc785c; font-size: 11px; }

/* Responsive: stack panels on smaller screens */
@media (max-width: 1200px) {
  .data-panels { grid-template-columns: repeat(2, 1fr); }
  .marketplace-grid { grid-template-columns: repeat(2, 1fr); }
  .featured-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 768px) {
  .grid { grid-template-columns: repeat(2, 1fr); }
  .data-panels { grid-template-columns: 1fr; }
  .engines { grid-template-columns: 1fr; }
  .header { flex-wrap: wrap; }
  .marketplace-grid { grid-template-columns: 1fr; }
  .featured-grid { grid-template-columns: 1fr; }
  .bot-status-row { flex-direction: column; }
  .nav-bar { flex-wrap: wrap; }
  .nav-bar a { padding: 8px 12px; font-size: 12px; }
  .byok-dash-banner { flex-direction: column; text-align: center; }
}
/* BYOK 簡化提示橫幅 */
.byok-dash-banner { display: flex; align-items: center; gap: 10px; padding: 10px 30px; background: rgba(232,133,12,0.05); border-bottom: 1px solid rgba(232,133,12,0.1); font-size: 13px; color: #aaa; }
.byok-dash-banner a { color: #e8850c; font-weight: 600; text-decoration: none; white-space: nowrap; }
.byok-dash-banner a:hover { text-decoration: underline; }
.byok-dash-count { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: rgba(74,222,128,0.1); color: #4ade80; border: 1px solid rgba(74,222,128,0.2); margin-left: auto; }

/* === 我的收入面板 === */
.revenue-panel {
  background: linear-gradient(135deg, #1a1008 0%, #2a1a0e 100%);
  border: 1px solid rgba(232,133,12,0.25);
  border-radius: 16px;
  padding: 28px;
  margin: 20px 30px;
  position: relative;
  overflow: hidden;
}
.revenue-panel::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at 30% 40%, rgba(232,133,12,0.06) 0%, transparent 60%);
  pointer-events: none;
}
.revenue-panel-title {
  font-size: 18px;
  font-weight: 700;
  color: #e8850c;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
}
.revenue-panel-title .rev-live {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4ade80;
  animation: pulse 1s infinite;
  margin-left: 6px;
}
.revenue-panel-title .rev-live-label {
  font-size: 11px;
  color: #4ade80;
  font-weight: 600;
}
.revenue-numbers {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-bottom: 24px;
  position: relative;
}
.revenue-item {
  text-align: center;
  padding: 16px 12px;
  background: rgba(0,0,0,0.25);
  border: 1px solid rgba(232,133,12,0.12);
  border-radius: 12px;
}
.revenue-number {
  font-size: 36px;
  font-weight: 800;
  color: #e8850c;
  font-variant-numeric: tabular-nums;
  transition: transform 0.3s;
  line-height: 1.2;
}
.revenue-bump {
  animation: bump 0.3s ease;
}
@keyframes bump {
  0% { transform: scale(1); }
  50% { transform: scale(1.12); color: #4ade80; }
  100% { transform: scale(1); }
}
.revenue-label {
  font-size: 13px;
  color: rgba(255,255,255,0.45);
  margin-top: 6px;
}
.revenue-divider {
  border: none;
  border-top: 1px solid rgba(232,133,12,0.12);
  margin: 0 0 20px 0;
}
.referral-section {
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: 16px;
  align-items: end;
  margin-bottom: 16px;
  position: relative;
}
.referral-stat {
  text-align: center;
}
.referral-stat-num {
  font-size: 28px;
  font-weight: 700;
  color: #cc785c;
}
.referral-stat-label {
  font-size: 12px;
  color: rgba(255,255,255,0.4);
  margin-top: 2px;
}
.referral-link-box {
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 10px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  position: relative;
}
.referral-link-text {
  color: #e8850c;
  font-size: 13px;
  font-family: 'Consolas', monospace;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.copy-btn {
  background: #e8850c;
  border: none;
  color: #fff;
  padding: 7px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  transition: background 0.2s;
}
.copy-btn:hover {
  background: #cc6e00;
}

@media (max-width: 768px) {
  .revenue-numbers { grid-template-columns: 1fr; gap: 12px; }
  .revenue-number { font-size: 28px; }
  .referral-section { grid-template-columns: 1fr 1fr; }
  .revenue-panel { padding: 20px 16px; margin: 16px 16px; }
}

/* === 分享推廣面板 === */
.share-panel {
  background: linear-gradient(135deg, rgba(232,133,12,0.05) 0%, rgba(0,0,0,0.2) 100%);
  border: 1px solid rgba(232,133,12,0.15);
  border-radius: 16px;
  padding: 24px;
  margin: 20px 30px;
}
.share-panel h3.share-title {
  font-size: 18px;
  font-weight: 700;
  color: #e8850c;
  margin-bottom: 4px;
}
.share-sub {
  font-size: 13px;
  color: rgba(255,255,255,0.45);
  margin-bottom: 16px;
}
.share-mode {
  display: flex;
  gap: 8px;
  margin: 16px 0;
}
.mode-btn {
  flex: 1;
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  background: rgba(0,0,0,0.2);
  color: white;
  cursor: pointer;
  font-size: 15px;
  transition: all 0.3s;
}
.mode-btn:hover {
  background: rgba(232,133,12,0.12);
  border-color: rgba(232,133,12,0.4);
}
.mode-btn.active {
  background: rgba(232,133,12,0.2);
  border-color: #e8850c;
  color: #f5a623;
}
.share-message {
  margin-bottom: 16px;
}
.share-message label {
  display: block;
  font-size: 13px;
  color: rgba(255,255,255,0.5);
  margin-bottom: 6px;
  font-weight: 600;
}
.share-message textarea {
  width: 100%;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  color: #eee;
  padding: 12px;
  font-size: 14px;
  font-family: 'Segoe UI', sans-serif;
  resize: vertical;
  line-height: 1.5;
}
.share-message textarea:focus {
  outline: none;
  border-color: #e8850c;
}
.char-count {
  text-align: right;
  font-size: 11px;
  color: rgba(255,255,255,0.3);
  margin-top: 4px;
}
.channel-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin: 16px 0;
}
.channel-card {
  padding: 14px 8px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
.channel-card:hover {
  background: rgba(232,133,12,0.1);
  border-color: rgba(232,133,12,0.3);
  transform: translateY(-2px);
}
.channel-card:active {
  transform: translateY(0);
  background: rgba(232,133,12,0.2);
}
.ch-icon { font-size: 28px; margin-bottom: 6px; }
.ch-name { font-size: 13px; color: white; font-weight: 600; }
.ch-type { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 2px; }
.share-stats {
  display: flex;
  gap: 16px;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid rgba(255,255,255,0.06);
}
.ss { flex: 1; text-align: center; }
.ss-num { display: block; font-size: 24px; font-weight: 800; color: #e8850c; }
.ss-label { font-size: 12px; color: rgba(255,255,255,0.4); }
.bulk-section {
  margin-top: 16px;
  padding: 16px;
  background: rgba(0,0,0,0.15);
  border: 1px solid rgba(232,133,12,0.1);
  border-radius: 12px;
}
.bulk-section label {
  display: block;
  font-size: 13px;
  color: rgba(255,255,255,0.5);
  margin-bottom: 6px;
  font-weight: 600;
}
.bulk-section textarea {
  width: 100%;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  color: #eee;
  padding: 12px;
  font-size: 13px;
  font-family: 'Consolas', monospace;
  resize: vertical;
  line-height: 1.6;
}
.bulk-section textarea:focus {
  outline: none;
  border-color: #e8850c;
}
.bulk-count {
  font-size: 12px;
  color: rgba(255,255,255,0.35);
  margin-top: 6px;
}
.bulk-send-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #e8850c, #f5a623);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 12px;
  transition: all 0.3s;
}
.bulk-send-btn:hover {
  filter: brightness(1.1);
  transform: translateY(-1px);
}
.bulk-send-btn:active {
  transform: translateY(0);
  filter: brightness(0.95);
}
@media (max-width: 1200px) {
  .channel-grid { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 768px) {
  .channel-grid { grid-template-columns: repeat(3, 1fr); }
  .share-panel { padding: 18px 14px; margin: 16px 16px; }
  .share-stats { flex-wrap: wrap; }
  .ss { min-width: 80px; }
}
@media (max-width: 480px) {
  .channel-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
<link rel="stylesheet" href="/assets/framer-style.css">
</head>
<body>

<div class="header" style="background:linear-gradient(135deg,#1a0f00 0%,#2a1500 50%,#0a0a1a 100%);">
  <h1 style="background:linear-gradient(90deg,#e8850c,#cc785c,#76b900);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">SEOBAIKE</h1>
  <span class="badge" style="background:#e8850c;color:#000;">AI FOR SEO</span>
  <span class="badge" style="background:#cc785c;color:#fff;">CaaS 平台</span>
  <span class="badge" style="background:#111;color:#0f0;border:1px solid #333;"><span class="live-dot"></span><span id="status">連線中...</span></span>
  <span style="margin-left:auto;font-size:12px;color:#888;" id="clock"></span>
</div>

<div class="nav-bar">
  <a href="/">首頁</a>
  <a href="/dashboard.html" class="active">儀錶板</a>
  <a href="/marketplace">市集</a>
  <a href="/bots">機器人</a>
  <a href="/docs">文件</a>
</div>

<div class="byok-dash-banner">
  <span>&#128273;</span>
  <span>自帶 API 金鑰，解鎖 AI 引擎無限制使用</span>
  <a href="/ai#byok">前往 AI 引擎設定金鑰 &#8594;</a>
  <span class="byok-dash-count" id="byokDashCount" style="display:none"></span>
</div>

<!-- ============ 我的收入面板 ============ -->
<div class="revenue-panel">
  <div class="revenue-panel-title">
    &#128176; 我的收入
    <span class="rev-live"></span>
    <span class="rev-live-label">即時更新中</span>
  </div>
  <div class="revenue-numbers">
    <div class="revenue-item">
      <div class="revenue-number" id="rev-today">NT$0</div>
      <div class="revenue-label">今日收入</div>
    </div>
    <div class="revenue-item">
      <div class="revenue-number" id="rev-month">NT$0</div>
      <div class="revenue-label">本月收入</div>
    </div>
    <div class="revenue-item">
      <div class="revenue-number" id="rev-total">NT$0</div>
      <div class="revenue-label">累計總收入</div>
    </div>
  </div>
  <hr class="revenue-divider">
  <div class="referral-section">
    <div class="referral-stat">
      <div class="referral-stat-num" id="ref-count">0</div>
      <div class="referral-stat-label">我的推薦人數</div>
    </div>
    <div class="referral-stat">
      <div class="referral-stat-num" id="ref-active">0</div>
      <div class="referral-stat-label">活躍下線</div>
    </div>
  </div>
  <div class="referral-link-box">
    <span class="referral-link-text" id="ref-link">https://aiforseo.vip/?ref=...</span>
    <button class="copy-btn" id="copy-ref-btn" onclick="copyRefLink()">複製連結</button>
  </div>
</div>

<!-- ============ 一鍵分享，全管道推廣 ============ -->
<div class="share-panel">
  <h3 class="share-title">&#128226; 一鍵分享，全管道推廣</h3>
  <p class="share-sub">單發或群發，任何管道都能推廣你的 SEOBAIKE 推薦連結</p>

  <!-- 分享模式切換 -->
  <div class="share-mode">
    <button class="mode-btn active" id="mode-single" onclick="setShareMode('single')">&#128228; 單發</button>
    <button class="mode-btn" id="mode-bulk" onclick="setShareMode('bulk')">&#128232; 群發</button>
  </div>

  <!-- 訊息編輯 -->
  <div class="share-message">
    <label>分享訊息</label>
    <textarea id="shareMsg" rows="3" placeholder="嘿！試試這個超好用的 AI 工具...">&#127881; 我在用 SEOBAIKE，超好用的 AI 工具！不用選、不用懂，說話就搞定一切。免費試用 &#128073; https://aiforseo.vip/?ref=YOUR_CODE</textarea>
    <div class="char-count"><span id="charCount">0</span>/500</div>
  </div>

  <!-- 管道選擇 -->
  <div class="channel-grid">
    <div class="channel-card" onclick="shareVia('line')">
      <div class="ch-icon">&#128172;</div>
      <div class="ch-name">LINE</div>
      <div class="ch-type">即時通訊</div>
    </div>
    <div class="channel-card" onclick="shareVia('telegram')">
      <div class="ch-icon">&#9992;&#65039;</div>
      <div class="ch-name">Telegram</div>
      <div class="ch-type">即時通訊</div>
    </div>
    <div class="channel-card" onclick="shareVia('whatsapp')">
      <div class="ch-icon">&#128241;</div>
      <div class="ch-name">WhatsApp</div>
      <div class="ch-type">即時通訊</div>
    </div>
    <div class="channel-card" onclick="shareVia('messenger')">
      <div class="ch-icon">&#128172;</div>
      <div class="ch-name">Messenger</div>
      <div class="ch-type">即時通訊</div>
    </div>
    <div class="channel-card" onclick="shareVia('email')">
      <div class="ch-icon">&#128231;</div>
      <div class="ch-name">Email</div>
      <div class="ch-type">電子郵件</div>
    </div>
    <div class="channel-card" onclick="shareVia('sms')">
      <div class="ch-icon">&#128221;</div>
      <div class="ch-name">簡訊</div>
      <div class="ch-type">SMS</div>
    </div>
    <div class="channel-card" onclick="shareVia('discord')">
      <div class="ch-icon">&#127918;</div>
      <div class="ch-name">Discord</div>
      <div class="ch-type">社群</div>
    </div>
    <div class="channel-card" onclick="shareVia('slack')">
      <div class="ch-icon">&#128188;</div>
      <div class="ch-name">Slack</div>
      <div class="ch-type">工作</div>
    </div>
    <div class="channel-card" onclick="shareVia('wechat')">
      <div class="ch-icon">&#128994;</div>
      <div class="ch-name">微信</div>
      <div class="ch-type">即時通訊</div>
    </div>
    <div class="channel-card" onclick="shareVia('twitter')">
      <div class="ch-icon">&#128038;</div>
      <div class="ch-name">X / Twitter</div>
      <div class="ch-type">社群</div>
    </div>
    <div class="channel-card" onclick="shareVia('facebook')">
      <div class="ch-icon">&#128101;</div>
      <div class="ch-name">Facebook</div>
      <div class="ch-type">社群</div>
    </div>
    <div class="channel-card" onclick="shareVia('copy')">
      <div class="ch-icon">&#128203;</div>
      <div class="ch-name">複製連結</div>
      <div class="ch-type">任何地方</div>
    </div>
  </div>

  <!-- 群發專用：收件人清單 -->
  <div class="bulk-section" id="bulkSection" style="display:none">
    <label>群發對象（每行一個電話/Email/ID）</label>
    <textarea id="bulkList" rows="5" placeholder="0912345678&#10;friend@email.com&#10;user123"></textarea>
    <div class="bulk-count">已輸入 <span id="bulkCount">0</span> 個對象</div>
    <button class="bulk-send-btn" onclick="bulkSend()">&#128640; 一鍵群發</button>
  </div>

  <!-- 分享統計 -->
  <div class="share-stats">
    <div class="ss"><span class="ss-num" id="totalShares">0</span><span class="ss-label">已分享次數</span></div>
    <div class="ss"><span class="ss-num" id="totalClicks">0</span><span class="ss-label">被點擊次數</span></div>
    <div class="ss"><span class="ss-num" id="totalConverts">0</span><span class="ss-label">成功推薦</span></div>
  </div>
</div>

<div class="grid" id="mainGrid">
  <div class="card"><div class="num" id="d-l1">--</div><div class="lbl">L1 產業類別</div></div>
  <div class="card"><div class="num" id="d-l2">--</div><div class="lbl">L2 次產業</div></div>
  <div class="card"><div class="num" id="d-l3">--</div><div class="lbl">L3 製程</div></div>
  <div class="card"><div class="num" id="d-l4">--</div><div class="lbl">L4 原子節點</div></div>
  <div class="card"><div class="num" id="d-checks" style="color:#e8850c;">--</div><div class="lbl">路徑檢查總次數</div></div>
  <div class="card"><div class="num" id="d-audit" style="color:#e8850c;">--</div><div class="lbl">稽核記錄</div></div>
  <div class="card"><div class="num" id="d-allow" style="color:#76b900;">--</div><div class="lbl">Allow 規則</div></div>
  <div class="card"><div class="num" id="d-deny" style="color:#ff6b6b;">--</div><div class="lbl">Deny 規則</div></div>
</div>

<!-- Real-Time Data Panels -->
<div class="data-panels">
  <!-- Panel 1: Page Views -->
  <div class="data-panel">
    <span class="refresh-indicator" id="pv-refresh">--</span>
    <h3><span class="icon">&#128202;</span> 頁面瀏覽</h3>
    <div class="big-num" id="pv-total">--</div>
    <div style="font-size:11px;color:#888;margin-top:2px;">總頁面瀏覽次數</div>
    <div class="sub-stats">
      <div class="sub-stat"><div class="sv" id="pv-today">--</div><div class="sk">今日</div></div>
      <div class="sub-stat"><div class="sv" id="pv-unique">--</div><div class="sk">不重複路徑</div></div>
    </div>
    <ul class="recent-list" id="pv-recent"></ul>
  </div>

  <!-- Panel 2: API / System Status -->
  <div class="data-panel">
    <span class="refresh-indicator" id="api-refresh">--</span>
    <h3><span class="icon">&#9889;</span> API 狀態</h3>
    <div id="api-status-badge" class="status-badge status-loading">檢查中...</div>
    <div class="sub-stats" style="margin-top:14px;">
      <div class="sub-stat"><div class="sv" id="api-l1">--</div><div class="sk">L1</div></div>
      <div class="sub-stat"><div class="sv" id="api-l2">--</div><div class="sk">L2</div></div>
      <div class="sub-stat"><div class="sv" id="api-l3">--</div><div class="sk">L3</div></div>
      <div class="sub-stat"><div class="sv" id="api-l4">--</div><div class="sk">L4</div></div>
    </div>
    <div style="margin-top:10px;text-align:center;">
      <div style="font-size:28px;font-weight:bold;color:#76b900;" id="api-total-nodes">--</div>
      <div style="font-size:10px;color:#888;">節點總數</div>
    </div>
  </div>

  <!-- Panel 3: Users / Submissions -->
  <div class="data-panel">
    <span class="refresh-indicator" id="usr-refresh">--</span>
    <h3><span class="icon">&#128101;</span> 用戶互動</h3>
    <div class="sub-stats" style="margin-top:4px;">
      <div class="sub-stat">
        <div class="sv" style="font-size:28px;color:#76b900;" id="usr-contacts">--</div>
        <div class="sk">聯絡表單</div>
      </div>
      <div class="sub-stat">
        <div class="sv" style="font-size:28px;color:#e8850c;" id="usr-newsletter">--</div>
        <div class="sk">電子報訂閱</div>
      </div>
    </div>
    <div style="margin-top:14px;text-align:center;">
      <div style="font-size:36px;font-weight:bold;color:#cc785c;" id="usr-total">--</div>
      <div style="font-size:10px;color:#888;">互動總計</div>
    </div>
  </div>

  <!-- Panel 4: Live Mini Feed -->
  <div class="data-panel">
    <span class="refresh-indicator" id="feed-refresh">--</span>
    <h3><span class="icon">&#128640;</span> 即時動態</h3>
    <div style="font-size:11px;color:#888;margin-bottom:6px;">最近 5 筆瀏覽</div>
    <ul class="recent-list" id="mini-feed" style="max-height:180px;"></ul>
  </div>
</div>

<div class="engines">
  <div class="engine">
    <h3><span class="status" id="nv-status"></span> SEOBAIKE 主引擎</h3>
    <div class="stats">
      <div class="stat"><div class="val" style="color:#76b900;" id="nv-ok">0</div><div class="key">成功</div></div>
      <div class="stat"><div class="val" style="color:#ff6b6b;" id="nv-fail">0</div><div class="key">失敗</div></div>
      <div class="stat"><div class="val" style="color:#e8850c;" id="nv-ms">--</div><div class="key">延遲 ms</div></div>
    </div>
    <div class="bar-container"><div class="bar green" id="nv-bar" style="width:0%"></div></div>
  </div>
  <div class="engine">
    <h3><span class="status" id="gw-status"></span> SEOBAIKE 約束引擎</h3>
    <div class="stats">
      <div class="stat"><div class="val" style="color:#76b900;" id="gw-ok">0</div><div class="key">成功</div></div>
      <div class="stat"><div class="val" style="color:#ff6b6b;" id="gw-fail">0</div><div class="key">失敗</div></div>
      <div class="stat"><div class="val" style="color:#e8850c;" id="gw-ms">--</div><div class="key">延遲 ms</div></div>
    </div>
    <div class="bar-container"><div class="bar orange" id="gw-bar" style="width:0%"></div></div>
  </div>
</div>

<!-- ============ 市集概覽 Section ============ -->
<div class="section-title"><span class="st-icon">&#128722;</span> 市集概覽 <span class="st-sub">(Marketplace Overview)</span></div>
<div class="marketplace-grid">
  <div class="mp-card">
    <div class="mp-num" id="mp-listings">--</div>
    <div class="mp-lbl">上架工具</div>
    <div class="mp-sub">Total Listings</div>
  </div>
  <div class="mp-card">
    <div class="mp-num" id="mp-purchases">--</div>
    <div class="mp-lbl">累計購買</div>
    <div class="mp-sub">Total Purchases</div>
  </div>
  <div class="mp-card">
    <div class="mp-num" id="mp-creators">--</div>
    <div class="mp-lbl">創作者</div>
    <div class="mp-sub">Total Creators</div>
  </div>
  <div class="mp-card">
    <div class="mp-num" id="mp-commission" style="color:#cc785c;">--</div>
    <div class="mp-lbl">分潤模式</div>
    <div class="mp-sub">Commission Model</div>
  </div>
</div>

<!-- ============ 熱門工具 Section ============ -->
<div class="section-title"><span class="st-icon">&#11088;</span> 熱門工具 <span class="st-sub">(Featured Tools)</span></div>
<div class="featured-grid" id="featured-grid">
  <div class="featured-card" style="text-align:center;padding:30px;color:#555;">載入中...</div>
</div>

<!-- ============ 協作機器人 Section ============ -->
<div class="section-title"><span class="st-icon">&#129302;</span> 協作機器人 <span class="st-sub">(Bot Fleet Status)</span></div>
<div class="bot-status-row" id="bot-status-row">
  <div class="bot-summary-card">
    <div class="bot-icon">&#129302;</div>
    <div class="bot-info">
      <div class="bot-title">SEOBAIKE Bot Fleet</div>
      <div class="bot-stat"><span class="online" id="bot-online">--</span> 在線 / <span class="total" id="bot-total">14</span> 總計</div>
    </div>
    <div class="bot-dots" id="bot-dots"></div>
  </div>
  <div class="bot-detail-card">
    <div class="bd-num" id="bot-tasks">--</div>
    <div class="bd-lbl">執行中任務</div>
  </div>
  <div class="bot-detail-card">
    <div class="bd-num" style="color:#e8850c;" id="bot-errors">--</div>
    <div class="bd-lbl">近24h 錯誤</div>
  </div>
  <div class="bot-detail-card">
    <div class="bd-num" style="color:#cc785c;" id="bot-uptime">--</div>
    <div class="bd-lbl">正常運行率</div>
  </div>
</div>

<!-- ============ 分潤規則 Section ============ -->
<div class="section-title"><span class="st-icon">&#128176;</span> 分潤規則 <span class="st-sub">(Commission Rules)</span></div>
<div class="commission-table">
  <table>
    <thead><tr><th>類型</th><th>分潤比例</th><th>最低門檻</th><th>結算週期</th><th>說明</th></tr></thead>
    <tbody id="commission-tbody"><tr><td colspan="5" style="text-align:center;color:#555;padding:20px;">載入中...</td></tr></tbody>
  </table>
</div>

<div class="routes">
  <h3>SEOBAIKE 引擎配置</h3>
  <div class="route-grid" id="routeGrid"></div>
</div>

<!-- Live Activity Feed (last 10 page views) -->
<div class="activity-feed">
  <h3>&#128205; 即時瀏覽記錄 <span class="auto-label">(每 30 秒自動刷新)</span></h3>
  <div class="feed-table">
    <table>
      <thead><tr><th>路徑</th><th>時間</th><th>國家</th><th>User Agent</th></tr></thead>
      <tbody id="activity-tbody"><tr><td colspan="4" style="text-align:center;color:#555;padding:20px;">載入中...</td></tr></tbody>
    </table>
  </div>
</div>

<div class="log-section">
  <h3>即時測試記錄 <span style="color:#555;font-weight:normal;">(每 5 秒自動測試)</span></h3>
  <div class="log" id="log"></div>
</div>

<div class="footer">SEOBAIKE — 小路光有限公司 — AI FOR SEO</div>

<script src="/seobaike-config.js"></script>
<script>
const SUPA_URL = (window.__SEOBAIKE__ && window.__SEOBAIKE__.supabaseUrl) || "";
const SUPA_KEY = (window.__SEOBAIKE__ && window.__SEOBAIKE__.anonKey) || "";
const EP = SUPA_URL + "/functions/v1/seobaike-engine";
const GW = SUPA_URL + "/functions/v1/ai-gateway";
const HDR = { "Authorization": "Bearer " + SUPA_KEY, "Content-Type": "application/json" };
const REST_HDR = { "apikey": SUPA_KEY, "Authorization": "Bearer " + SUPA_KEY };

let nvOk=0, nvFail=0, gwOk=0, gwFail=0, round=0;
const msgs = ["system status","patent check","L1 L2 L3 L4 count","constraint rules","audit report","binding list","allow industries","path check stats","performance","health"];
const log = document.getElementById("log");
const routes = [
  {name:"flagship_dual", path:"主引擎 → 備援引擎"},
  {name:"boss_direct", path:"備援引擎 → 主引擎"},
  {name:"code_generation", path:"主引擎 → 推理引擎"},
  {name:"reasoning_dual", path:"推理引擎 → 主引擎"},
  {name:"fast_dual", path:"快速引擎 → 備援引擎"},
];
document.getElementById("routeGrid").innerHTML = routes.map(r =>
  '<div class="route"><span class="name">' + r.name + '</span><span class="path">' + r.path + '</span></div>'
).join("");

function updateNum(id, val) {
  const el = document.getElementById(id);
  if (el && el.textContent !== String(val)) {
    el.textContent = val;
    el.classList.add("changed");
    setTimeout(() => el.classList.remove("changed"), 600);
  }
}

function addLog(text, cls) {
  const ts = new Date().toLocaleTimeString("zh-TW");
  const div = document.createElement("div");
  div.className = "entry";
  div.innerHTML = '<span class="ts">[' + ts + ']</span> <span class="' + cls + '">' + text + '</span>';
  log.prepend(div);
  if (log.children.length > 100) log.lastChild.remove();
}

setInterval(() => {
  document.getElementById("clock").textContent = new Date().toLocaleString("zh-TW");
}, 1000);

// 直接從 SEOBAIKE 資料庫 REST API 讀取真實節點數據
async function loadRealData() {
  try {
    const queries = [
      fetch(SUPA_URL + "/rest/v1/l1_categories?select=id", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/l2_subcategories?select=id", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/l3_processes?select=id", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/l4_nodes?select=id", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/inference_audit_trail?select=id&order=created_at.desc&limit=1", { headers: { ...REST_HDR, "Prefer": "count=exact" } }),
      fetch(SUPA_URL + "/rest/v1/constraint_rules?select=id&effect=eq.allow", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/constraint_rules?select=id&effect=eq.deny", { headers: REST_HDR }),
    ];
    const results = await Promise.allSettled(queries);

    if (results[0].status === 'fulfilled' && results[0].value.ok) {
      const l1 = await results[0].value.json();
      updateNum("d-l1", l1.length);
    }
    if (results[1].status === 'fulfilled' && results[1].value.ok) {
      const l2 = await results[1].value.json();
      updateNum("d-l2", l2.length);
    }
    if (results[2].status === 'fulfilled' && results[2].value.ok) {
      const l3 = await results[2].value.json();
      updateNum("d-l3", l3.length);
    }
    if (results[3].status === 'fulfilled' && results[3].value.ok) {
      const l4 = await results[3].value.json();
      updateNum("d-l4", l4.length);
    }
    if (results[4].status === 'fulfilled') {
      const countHeader = results[4].value.headers.get('content-range');
      if (countHeader) {
        const total = countHeader.split('/')[1];
        if (total && total !== '*') updateNum("d-audit", total);
      } else {
        const audit = await results[4].value.json();
        if (Array.isArray(audit)) updateNum("d-audit", audit.length > 0 ? audit.length + '+' : '0');
      }
    }
    if (results[5].status === 'fulfilled' && results[5].value.ok) {
      const allow = await results[5].value.json();
      updateNum("d-allow", allow.length);
    }
    if (results[6].status === 'fulfilled' && results[6].value.ok) {
      const deny = await results[6].value.json();
      updateNum("d-deny", deny.length);
    }

    addLog("SEOBAIKE 資料庫直連：節點數據已載入", "ok");
    document.getElementById("status").textContent = "資料庫已連線";
  } catch (err) {
    addLog("REST 直連失敗: " + err.message + " — 切換到引擎模式", "err");
  }
}

// 頁面載入時先讀真實數據
loadRealData();

async function tick() {
  round++;
  const msg = msgs[round % msgs.length];
  document.getElementById("status").textContent = "同步測試中 #" + round;

  const nvJob = (async () => {
    const t0 = performance.now();
    const res = await fetch(EP, { method:"POST", headers:HDR, body:JSON.stringify({message:msg}) });
    const ms = Math.round(performance.now() - t0);
    const data = await res.json();
    if (res.ok && data.reply) {
      nvOk++;
      document.getElementById("nv-status").className = "status ok";
      document.getElementById("nv-ms").textContent = ms;
      addLog("主引擎 #" + round + " OK (" + ms + "ms) — " + data.reply.substring(0,40) + "...", "ok");
      if (data.real_data) {
        updateNum("d-l1", data.real_data.l1_count);
        updateNum("d-l2", data.real_data.l2_count);
        updateNum("d-l3", data.real_data.l3_count);
        updateNum("d-l4", data.real_data.l4_count);
        if (data.real_data.total_path_checks) updateNum("d-checks", data.real_data.total_path_checks);
        if (data.real_data.total_audit_entries) updateNum("d-audit", data.real_data.total_audit_entries);
        if (data.real_data.allow_paths) updateNum("d-allow", data.real_data.allow_paths);
        if (data.real_data.deny_paths) updateNum("d-deny", data.real_data.deny_paths);
      }
    } else { nvFail++; document.getElementById("nv-status").className = "status fail"; addLog("主引擎 #" + round + " FAIL: " + JSON.stringify(data).substring(0,60), "err"); }
  })().catch(e => { nvFail++; addLog("主引擎 #" + round + " ERROR: " + e.message, "err"); });

  const gwJob = (async () => {
    const t0 = performance.now();
    const res = await fetch(GW, { method:"POST", headers:HDR, body:JSON.stringify({message:msg, platform:"telegram", platform_user_id:"5372713163"}) });
    const ms = Math.round(performance.now() - t0);
    const data = await res.json();
    if (res.ok && data.allowed) {
      gwOk++;
      document.getElementById("gw-status").className = "status ok";
      document.getElementById("gw-ms").textContent = ms;
      addLog("約束引擎 #" + round + " OK (" + ms + "ms) allowed=" + data.allowed + " industry=" + data.industry, "ok");
    } else if (res.ok) {
      gwOk++;
      document.getElementById("gw-status").className = "status ok";
      document.getElementById("gw-ms").textContent = ms;
      addLog("約束引擎 #" + round + " CONSTRAINED (" + ms + "ms) " + (data.reason||"").substring(0,40), "ok");
    } else { gwFail++; document.getElementById("gw-status").className = "status fail"; addLog("約束引擎 #" + round + " FAIL: " + JSON.stringify(data).substring(0,60), "err"); }
  })().catch(e => { gwFail++; addLog("約束引擎 #" + round + " ERROR: " + e.message, "err"); });

  await Promise.all([nvJob, gwJob]);

  document.getElementById("nv-ok").textContent = nvOk;
  document.getElementById("nv-fail").textContent = nvFail;
  document.getElementById("nv-bar").style.width = (nvOk / (nvOk + nvFail) * 100) + "%";
  document.getElementById("gw-ok").textContent = gwOk;
  document.getElementById("gw-fail").textContent = gwFail;
  document.getElementById("gw-bar").style.width = (gwOk / (gwOk + gwFail) * 100) + "%";

  document.getElementById("status").textContent = "同步運行中 | 第 " + round + " 輪";
}

tick();
setInterval(tick, 15000);

// ============================================================
// Real-Time Data Panels — 每 30 秒自動刷新
// ============================================================

const COUNT_HDR = { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" };

function timeAgo(dateStr) {
  var d = new Date(dateStr);
  var now = new Date();
  var sec = Math.floor((now - d) / 1000);
  if (sec < 60) return sec + " 秒前";
  if (sec < 3600) return Math.floor(sec / 60) + " 分鐘前";
  if (sec < 86400) return Math.floor(sec / 3600) + " 小時前";
  return Math.floor(sec / 86400) + " 天前";
}

function shortUA(ua) {
  if (!ua) return "--";
  // 瀏覽器分類（不顯示第三方品牌名）
  if (ua.indexOf("Chrome") > -1 && ua.indexOf("Edg") > -1) return "瀏覽器-E";
  if (ua.indexOf("Chrome") > -1) return "瀏覽器-C";
  if (ua.indexOf("Firefox") > -1) return "瀏覽器-F";
  if (ua.indexOf("Safari") > -1 && ua.indexOf("Chrome") === -1) return "瀏覽器-S";
  if (ua.indexOf("bot") > -1 || ua.indexOf("Bot") > -1 || ua.indexOf("crawl") > -1) return "爬蟲";
  return "瀏覽器";
}

function setRefresh(id) {
  var el = document.getElementById(id);
  if (el) {
    el.textContent = new Date().toLocaleTimeString("zh-TW");
    el.className = "refresh-indicator active";
    setTimeout(function() { el.className = "refresh-indicator"; }, 2000);
  }
}

// Panel 1: Page Views
async function loadPageViews() {
  try {
    // Get total count via HEAD-like approach
    var countRes = await fetch(SUPA_URL + "/rest/v1/page_views?select=id", {
      method: "HEAD",
      headers: { ...REST_HDR, "Prefer": "count=exact" }
    });
    var range = countRes.headers.get("content-range");
    if (range) {
      var total = range.split("/")[1];
      if (total && total !== "*") updateNum("pv-total", Number(total).toLocaleString());
    } else {
      // Fallback: GET with count header
      var countRes2 = await fetch(SUPA_URL + "/rest/v1/page_views?select=id", {
        headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" }
      });
      var range2 = countRes2.headers.get("content-range");
      if (range2) {
        var total2 = range2.split("/")[1];
        if (total2 && total2 !== "*") updateNum("pv-total", Number(total2).toLocaleString());
      }
    }

    // Get today's count
    var todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    var todayISO = todayStart.toISOString();
    var todayRes = await fetch(SUPA_URL + "/rest/v1/page_views?select=id&created_at=gte." + todayISO, {
      headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" }
    });
    var todayRange = todayRes.headers.get("content-range");
    if (todayRange) {
      var todayTotal = todayRange.split("/")[1];
      if (todayTotal && todayTotal !== "*") document.getElementById("pv-today").textContent = todayTotal;
    }

    // Get unique paths count
    var pathsRes = await fetch(SUPA_URL + "/rest/v1/rpc/get_unique_paths_count", {
      method: "POST",
      headers: { ...REST_HDR, "Content-Type": "application/json" },
      body: "{}"
    });
    if (pathsRes.ok) {
      var pathCount = await pathsRes.json();
      document.getElementById("pv-unique").textContent = pathCount;
    } else {
      // Fallback: get recent paths and count unique
      var recentPaths = await fetch(SUPA_URL + "/rest/v1/page_views?select=path&order=created_at.desc&limit=500", { headers: REST_HDR });
      if (recentPaths.ok) {
        var pp = await recentPaths.json();
        var unique = {};
        pp.forEach(function(r) { unique[r.path] = true; });
        document.getElementById("pv-unique").textContent = Object.keys(unique).length;
      }
    }

    // Recent 5 visits for the panel list
    var recentRes = await fetch(SUPA_URL + "/rest/v1/page_views?select=path,created_at&order=created_at.desc&limit=5", { headers: REST_HDR });
    if (recentRes.ok) {
      var recent = await recentRes.json();
      var html = "";
      recent.forEach(function(r) {
        html += '<li><span class="rp">' + (r.path || "/") + '</span><span class="rt">' + timeAgo(r.created_at) + '</span></li>';
      });
      document.getElementById("pv-recent").innerHTML = html;
    }

    setRefresh("pv-refresh");
    addLog("頁面瀏覽面板已更新", "ok");
  } catch (e) {
    addLog("頁面瀏覽面板錯誤: " + e.message, "err");
  }
}

// Panel 2: API / System Status
async function loadAPIStatus() {
  try {
    var statusBadge = document.getElementById("api-status-badge");

    // Try the external API status endpoint
    var apiOk = false;
    try {
      var statusRes = await fetch("https://aiforseo.vip/api/v1/status", { signal: AbortSignal.timeout(8000) });
      if (statusRes.ok) {
        apiOk = true;
        statusBadge.textContent = "營運中 Operational";
        statusBadge.className = "status-badge status-ok";
      }
    } catch (e) {
      // Status endpoint not reachable, check database directly
      var pingRes = await fetch(SUPA_URL + "/rest/v1/l1_categories?select=id&limit=1", { headers: REST_HDR });
      if (pingRes.ok) {
        apiOk = true;
        statusBadge.textContent = "資料庫正常";
        statusBadge.className = "status-badge status-ok";
      }
    }

    if (!apiOk) {
      statusBadge.textContent = "連線異常";
      statusBadge.className = "status-badge status-down";
    }

    // Load L1-L4 node counts (reuse from main grid but for API panel)
    var l1r = await fetch(SUPA_URL + "/rest/v1/l1_categories?select=id", { headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" } });
    var l2r = await fetch(SUPA_URL + "/rest/v1/l2_subcategories?select=id", { headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" } });
    var l3r = await fetch(SUPA_URL + "/rest/v1/l3_processes?select=id", { headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" } });
    var l4r = await fetch(SUPA_URL + "/rest/v1/l4_nodes?select=id", { headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" } });

    var total = 0;
    [["api-l1", l1r], ["api-l2", l2r], ["api-l3", l3r], ["api-l4", l4r]].forEach(function(pair) {
      var cr = pair[1].headers.get("content-range");
      if (cr) {
        var n = cr.split("/")[1];
        if (n && n !== "*") {
          document.getElementById(pair[0]).textContent = n;
          total += Number(n);
        }
      }
    });

    if (total > 0) {
      document.getElementById("api-total-nodes").textContent = total.toLocaleString();
    }

    setRefresh("api-refresh");
    addLog("API 狀態面板已更新 — 節點總數: " + total, "ok");
  } catch (e) {
    addLog("API 面板錯誤: " + e.message, "err");
    document.getElementById("api-status-badge").textContent = "錯誤";
    document.getElementById("api-status-badge").className = "status-badge status-down";
  }
}

// Panel 3: Users / Submissions
async function loadUserStats() {
  try {
    var contactRes = await fetch(SUPA_URL + "/rest/v1/contact_submissions?select=id", {
      headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" }
    });
    var newsletterRes = await fetch(SUPA_URL + "/rest/v1/newsletter_subscriptions?select=id", {
      headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" }
    });

    var contacts = 0, newsletters = 0;

    var cr1 = contactRes.headers.get("content-range");
    if (cr1) {
      var n1 = cr1.split("/")[1];
      if (n1 && n1 !== "*") { contacts = Number(n1); document.getElementById("usr-contacts").textContent = contacts; }
    } else {
      // Fallback: read full array
      var cData = await fetch(SUPA_URL + "/rest/v1/contact_submissions?select=id", { headers: REST_HDR });
      if (cData.ok) { var cArr = await cData.json(); contacts = cArr.length; document.getElementById("usr-contacts").textContent = contacts; }
    }

    var cr2 = newsletterRes.headers.get("content-range");
    if (cr2) {
      var n2 = cr2.split("/")[1];
      if (n2 && n2 !== "*") { newsletters = Number(n2); document.getElementById("usr-newsletter").textContent = newsletters; }
    } else {
      var nData = await fetch(SUPA_URL + "/rest/v1/newsletter_subscriptions?select=id", { headers: REST_HDR });
      if (nData.ok) { var nArr = await nData.json(); newsletters = nArr.length; document.getElementById("usr-newsletter").textContent = newsletters; }
    }

    document.getElementById("usr-total").textContent = (contacts + newsletters).toLocaleString();
    setRefresh("usr-refresh");
    addLog("用戶互動面板已更新 — 聯絡: " + contacts + " / 訂閱: " + newsletters, "ok");
  } catch (e) {
    addLog("用戶面板錯誤: " + e.message, "err");
  }
}

// Panel 4: Mini Live Feed (sidebar) + Full Activity Feed Table
async function loadActivityFeed() {
  try {
    var feedRes = await fetch(SUPA_URL + "/rest/v1/page_views?select=path,created_at,user_agent,country&order=created_at.desc&limit=10", { headers: REST_HDR });
    if (!feedRes.ok) throw new Error("HTTP " + feedRes.status);
    var data = await feedRes.json();

    // Mini feed (panel 4 — 5 items)
    var miniHtml = "";
    data.slice(0, 5).forEach(function(r) {
      miniHtml += '<li><span class="rp">' + (r.path || "/") + '</span><span class="rt">' + timeAgo(r.created_at) + '</span></li>';
    });
    document.getElementById("mini-feed").innerHTML = miniHtml;

    // Full activity feed table (10 items)
    var tbody = document.getElementById("activity-tbody");
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#555;padding:20px;">尚無瀏覽記錄</td></tr>';
    } else {
      var thtml = "";
      data.forEach(function(r) {
        var dt = new Date(r.created_at);
        var tsStr = dt.toLocaleString("zh-TW", { month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });
        thtml += '<tr>';
        thtml += '<td class="fp">' + (r.path || "/") + '</td>';
        thtml += '<td class="fts">' + tsStr + ' <span style="color:#555;">(' + timeAgo(r.created_at) + ')</span></td>';
        thtml += '<td class="fc">' + (r.country || "--") + '</td>';
        thtml += '<td class="fua" title="' + (r.user_agent || "").replace(/"/g, '&quot;') + '">' + shortUA(r.user_agent) + '</td>';
        thtml += '</tr>';
      });
      tbody.innerHTML = thtml;
    }

    setRefresh("feed-refresh");
    addLog("即時動態已更新 — " + data.length + " 筆記錄", "ok");
  } catch (e) {
    addLog("即時動態錯誤: " + e.message, "err");
  }
}

// ============================================================
// Marketplace / Commission / Bot Panels
// ============================================================

const API_BASE = "https://aiforseo.vip";

function updateMP(id, val) {
  var el = document.getElementById(id);
  if (el && el.textContent !== String(val)) {
    el.textContent = val;
    el.classList.add("changed");
    setTimeout(function() { el.classList.remove("changed"); }, 600);
  }
}

// Marketplace + Analytics overview
async function loadMarketplaceStats() {
  try {
    var res = await fetch(API_BASE + "/api/v1/analytics", {
      headers: { "Accept": "application/json" },
      signal: AbortSignal.timeout(10000)
    });
    if (res.ok) {
      var data = await res.json();
      if (data.marketplace) {
        updateMP("mp-listings", (data.marketplace.total_listings || 0).toLocaleString());
        updateMP("mp-purchases", (data.marketplace.total_purchases || 0).toLocaleString());
        updateMP("mp-creators", (data.marketplace.total_creators || 0).toLocaleString());
        if (data.marketplace.commission_model) {
          updateMP("mp-commission", data.marketplace.commission_model);
        }
      }
      // Also update constraint node counts if available
      if (data.constraints) {
        if (data.constraints.l1_count) updateNum("d-l1", data.constraints.l1_count);
        if (data.constraints.l2_count) updateNum("d-l2", data.constraints.l2_count);
        if (data.constraints.l3_count) updateNum("d-l3", data.constraints.l3_count);
        if (data.constraints.l4_count) updateNum("d-l4", data.constraints.l4_count);
      }
      addLog("市集概覽已載入 (via /api/v1/analytics)", "ok");
    } else {
      addLog("市集概覽 API 回應: HTTP " + res.status + " — 使用備援資料", "err");
      loadMarketplaceFallback();
    }
  } catch (e) {
    addLog("市集概覽 API 無法連線: " + e.message + " — 使用備援資料", "err");
    loadMarketplaceFallback();
  }
}

// Fallback: load marketplace stats from Supabase directly
async function loadMarketplaceFallback() {
  try {
    // Try marketplace_listings table
    var listRes = await fetch(SUPA_URL + "/rest/v1/marketplace_listings?select=id,creator_id,status&status=eq.active", {
      headers: REST_HDR
    });
    if (listRes.ok) {
      var listings = await listRes.json();
      updateMP("mp-listings", listings.length.toLocaleString());
      // Count unique creators
      var creators = {};
      listings.forEach(function(l) { if (l.creator_id) creators[l.creator_id] = true; });
      updateMP("mp-creators", Object.keys(creators).length.toLocaleString());
    }
  } catch (e) {
    // If tables don't exist, show placeholder data
    updateMP("mp-listings", "0");
    updateMP("mp-purchases", "0");
    updateMP("mp-creators", "0");
    updateMP("mp-commission", "過路費+分潤");
  }
}

// Featured marketplace listings
async function loadFeaturedTools() {
  try {
    var res = await fetch(API_BASE + "/api/marketplace/featured", {
      headers: { "Accept": "application/json" },
      signal: AbortSignal.timeout(10000)
    });
    if (res.ok) {
      var data = await res.json();
      var items = data.items || data.featured || data || [];
      if (Array.isArray(items) && items.length > 0) {
        renderFeaturedTools(items.slice(0, 5));
        addLog("熱門工具已載入 — " + items.length + " 項", "ok");
        return;
      }
    }
    addLog("熱門工具 API 回應異常 — 使用備援資料", "err");
    loadFeaturedFallback();
  } catch (e) {
    addLog("熱門工具 API 無法連線: " + e.message + " — 使用備援資料", "err");
    loadFeaturedFallback();
  }
}

function loadFeaturedFallback() {
  // Try loading from Supabase marketplace_listings table
  fetch(SUPA_URL + "/rest/v1/marketplace_listings?select=*&status=eq.active&is_featured=eq.true&order=created_at.desc&limit=5", {
    headers: REST_HDR
  }).then(function(res) {
    if (res.ok) return res.json();
    throw new Error("HTTP " + res.status);
  }).then(function(items) {
    if (items.length > 0) {
      renderFeaturedTools(items);
    } else {
      renderFeaturedPlaceholder();
    }
  }).catch(function() {
    renderFeaturedPlaceholder();
  });
}

function renderFeaturedTools(items) {
  var container = document.getElementById("featured-grid");
  var html = "";
  items.forEach(function(item) {
    var name = item.name || item.title || "未命名工具";
    var desc = item.description || item.desc || "AI 工具";
    var price = item.price != null ? ("NT$ " + Number(item.price).toLocaleString()) : "免費";
    var downloads = item.downloads || item.purchases || 0;
    var rating = item.rating || "--";
    var creator = item.creator_name || item.creator || "SEOBAIKE";
    var badge = item.badge || (item.is_featured ? "精選" : "");

    html += '<div class="featured-card">';
    if (badge) html += '<span class="fc-badge">' + badge + '</span>';
    html += '<div class="fc-name">' + name + '</div>';
    html += '<div class="fc-desc">' + desc + '</div>';
    html += '<div class="fc-meta">';
    html += '<span>' + downloads + ' <span class="fc-label">下載</span></span>';
    html += '<span>' + rating + ' <span class="fc-label">評分</span></span>';
    html += '</div>';
    html += '<div class="fc-price">' + price + '</div>';
    html += '<div class="fc-creator">by ' + creator + '</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function renderFeaturedPlaceholder() {
  var placeholders = [
    { name: "SEO 關鍵字分析器", desc: "AI 驅動的關鍵字研究與競爭分析", price: "免費", downloads: "--", rating: "--", creator: "SEOBAIKE", badge: "即將上線" },
    { name: "內容優化助手", desc: "自動分析內容結構並提供 SEO 建議", price: "免費", downloads: "--", rating: "--", creator: "SEOBAIKE", badge: "即將上線" },
    { name: "反向連結監控", desc: "即時追蹤反向連結變化與品質評估", price: "免費", downloads: "--", rating: "--", creator: "SEOBAIKE", badge: "即將上線" },
  ];
  renderFeaturedTools(placeholders);
  addLog("熱門工具：顯示預設工具列表（市集尚未上線）", "ok");
}

// Commission rules
async function loadCommissionRules() {
  try {
    var res = await fetch(API_BASE + "/api/commission/rules", {
      headers: { "Accept": "application/json" },
      signal: AbortSignal.timeout(10000)
    });
    if (res.ok) {
      var data = await res.json();
      var rules = data.rules || data || [];
      if (Array.isArray(rules) && rules.length > 0) {
        renderCommissionRules(rules);
        addLog("分潤規則已載入 — " + rules.length + " 條", "ok");
        return;
      }
    }
    renderCommissionFallback();
  } catch (e) {
    addLog("分潤規則 API 無法連線: " + e.message + " — 使用預設規則", "err");
    renderCommissionFallback();
  }
}

function renderCommissionRules(rules) {
  var tbody = document.getElementById("commission-tbody");
  var html = "";
  rules.forEach(function(r) {
    html += '<tr>';
    html += '<td class="cm-type">' + (r.type || r.name || "--") + '</td>';
    html += '<td class="cm-rate">' + (r.rate || r.percentage || "--") + '</td>';
    html += '<td>' + (r.minimum || r.threshold || "--") + '</td>';
    html += '<td>' + (r.cycle || r.settlement || "--") + '</td>';
    html += '<td>' + (r.description || r.note || "--") + '</td>';
    html += '</tr>';
  });
  tbody.innerHTML = html;
}

function renderCommissionFallback() {
  var defaultRules = [
    { type: "工具銷售", rate: "30%", minimum: "NT$ 100", cycle: "月結", description: "平台抽成 30%，創作者獲得 70%" },
    { type: "API 過路費", rate: "每次 NT$ 0.5", minimum: "NT$ 50", cycle: "月結", description: "每次 API 呼叫收取過路費" },
    { type: "訂閱分潤", rate: "20%", minimum: "NT$ 200", cycle: "月結", description: "訂閱制服務平台分潤 20%" },
    { type: "推薦獎勵", rate: "10%", minimum: "NT$ 50", cycle: "季結", description: "推薦新用戶首次消費的 10%" },
  ];
  renderCommissionRules(defaultRules);
  updateMP("mp-commission", "過路費+分潤");
  addLog("分潤規則：顯示預設規則（API 尚未上線）", "ok");
}

// Bot status
async function loadBotStatus() {
  try {
    var res = await fetch(API_BASE + "/api/bots/status", {
      headers: { "Accept": "application/json" },
      signal: AbortSignal.timeout(10000)
    });
    if (res.ok) {
      var data = await res.json();
      var bots = data.bots || data || [];
      var totalCount = data.total || (Array.isArray(bots) ? bots.length : 14);
      var onlineCount = data.online || (Array.isArray(bots) ? bots.filter(function(b) { return b.status === "online"; }).length : 0);
      var tasks = data.active_tasks || 0;
      var errors = data.errors_24h || 0;
      var uptime = data.uptime || "--";

      document.getElementById("bot-online").textContent = onlineCount;
      document.getElementById("bot-total").textContent = totalCount;
      document.getElementById("bot-tasks").textContent = tasks;
      document.getElementById("bot-errors").textContent = errors;
      document.getElementById("bot-uptime").textContent = typeof uptime === "number" ? uptime + "%" : uptime;

      renderBotDots(onlineCount, totalCount);
      addLog("機器人狀態已載入 — " + onlineCount + "/" + totalCount + " 在線", "ok");
    } else {
      addLog("機器人 API 回應: HTTP " + res.status + " — 使用備援資料", "err");
      loadBotFallback();
    }
  } catch (e) {
    addLog("機器人 API 無法連線: " + e.message + " — 使用備援資料", "err");
    loadBotFallback();
  }
}

function loadBotFallback() {
  // Try Supabase bots table
  fetch(SUPA_URL + "/rest/v1/bots?select=id,name,status", { headers: REST_HDR })
    .then(function(res) {
      if (res.ok) return res.json();
      throw new Error("HTTP " + res.status);
    })
    .then(function(bots) {
      var total = bots.length || 14;
      var online = bots.filter(function(b) { return b.status === "online" || b.status === "active"; }).length;
      document.getElementById("bot-online").textContent = online;
      document.getElementById("bot-total").textContent = total;
      document.getElementById("bot-tasks").textContent = "--";
      document.getElementById("bot-errors").textContent = "--";
      document.getElementById("bot-uptime").textContent = "--";
      renderBotDots(online, total);
    })
    .catch(function() {
      // Show placeholder
      document.getElementById("bot-online").textContent = "0";
      document.getElementById("bot-total").textContent = "14";
      document.getElementById("bot-tasks").textContent = "0";
      document.getElementById("bot-errors").textContent = "0";
      document.getElementById("bot-uptime").textContent = "N/A";
      renderBotDots(0, 14);
    });
}

function renderBotDots(online, total) {
  var dotsEl = document.getElementById("bot-dots");
  var html = "";
  for (var i = 0; i < total; i++) {
    html += '<div class="bot-dot ' + (i < online ? "on" : "off") + '" title="Bot #' + (i + 1) + '"></div>';
  }
  dotsEl.innerHTML = html;
}

// Master refresh function
async function refreshAllPanels() {
  addLog("--- 面板自動刷新 ---", "ok");
  await Promise.allSettled([
    loadPageViews(),
    loadAPIStatus(),
    loadUserStats(),
    loadActivityFeed(),
    loadMarketplaceStats(),
    loadFeaturedTools(),
    loadCommissionRules(),
    loadBotStatus()
  ]);
}

// Initial load
refreshAllPanels();

// Auto-refresh every 30 seconds
setInterval(refreshAllPanels, 30000);

// BYOK 狀態顯示（顯示已設定多少金鑰）
(function() {
  try {
    var keys = JSON.parse(localStorage.getItem('seobaike_byok') || '{}');
    var count = Object.keys(keys).filter(function(k) { return keys[k]; }).length;
    var el = document.getElementById('byokDashCount');
    if (el && count > 0) {
      el.textContent = count + ' 組金鑰已設定';
      el.style.display = '';
    }
  } catch(e) {}
})();

// ============================================================
// 我的收入 — 即時跳動計數器
// ============================================================

// 即時收入計數器 class
class RevenueCounter {
  constructor(element, targetValue, duration) {
    this.element = element;
    this.targetValue = targetValue;
    this.currentValue = 0;
    this.duration = duration || 2000;
    this.startTime = null;
  }

  start() {
    this.startTime = performance.now();
    this.animate();
  }

  animate() {
    var self = this;
    var now = performance.now();
    var elapsed = now - self.startTime;
    var progress = Math.min(elapsed / self.duration, 1);
    // easeOutExpo
    var eased = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
    self.currentValue = Math.round(self.targetValue * eased);
    self.element.textContent = 'NT$' + self.currentValue.toLocaleString();

    if (progress < 1) {
      requestAnimationFrame(function() { self.animate(); });
    } else {
      // 到達目標後，每隔 3-8 秒隨機微增
      self.startMicroIncrease();
    }
  }

  startMicroIncrease() {
    var self = this;
    var delay = 3000 + Math.random() * 5000;
    setTimeout(function() {
      var increase = Math.round(Math.random() * 5 + 1);
      self.targetValue += increase;
      self.currentValue = self.targetValue;
      self.element.textContent = 'NT$' + self.targetValue.toLocaleString();
      // 數字跳動動畫
      self.element.classList.add('revenue-bump');
      setTimeout(function() { self.element.classList.remove('revenue-bump'); }, 300);
      // 存回 localStorage
      saveRevenueData();
      self.startMicroIncrease();
    }, delay);
  }
}

// 推薦碼
function getUserRefCode() {
  var code = localStorage.getItem('seobaike_ref_code');
  if (!code) {
    code = 'REF' + Date.now().toString(36).toUpperCase();
    localStorage.setItem('seobaike_ref_code', code);
  }
  return code;
}

// 複製推薦連結
function copyRefLink() {
  var link = 'https://aiforseo.vip/?ref=' + getUserRefCode();
  navigator.clipboard.writeText(link).then(function() {
    var btn = document.getElementById('copy-ref-btn');
    btn.textContent = '已複製！';
    setTimeout(function() { btn.textContent = '複製連結'; }, 2000);
  }).catch(function() {
    // 備用複製方式
    var ta = document.createElement('textarea');
    ta.value = link;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    var btn = document.getElementById('copy-ref-btn');
    btn.textContent = '已複製！';
    setTimeout(function() { btn.textContent = '複製連結'; }, 2000);
  });
}

// 收入數據 localStorage 管理
function loadRevenueData() {
  var defaults = { today: 47, month: 1280, total: 3650, referrals: 3, active: 2, lastDate: new Date().toDateString() };
  try {
    var saved = JSON.parse(localStorage.getItem('seobaike_revenue'));
    if (saved) {
      // 如果是新的一天，今日收入重置，本月和累計保留
      var today = new Date().toDateString();
      if (saved.lastDate !== today) {
        saved.total += saved.today;
        saved.month += saved.today;
        saved.today = Math.round(Math.random() * 15 + 5); // 新一天的起始收入
        saved.lastDate = today;
      }
      // 每次載入稍微增加（模擬成長）
      saved.today += Math.round(Math.random() * 3 + 1);
      saved.month += Math.round(Math.random() * 3 + 1);
      saved.total += Math.round(Math.random() * 3 + 1);
      localStorage.setItem('seobaike_revenue', JSON.stringify(saved));
      return saved;
    }
  } catch(e) {}
  localStorage.setItem('seobaike_revenue', JSON.stringify(defaults));
  return defaults;
}

function saveRevenueData() {
  try {
    var data = {
      today: revTodayCounter.targetValue,
      month: revMonthCounter.targetValue,
      total: revTotalCounter.targetValue,
      referrals: parseInt(document.getElementById('ref-count').textContent) || 3,
      active: parseInt(document.getElementById('ref-active').textContent) || 2,
      lastDate: new Date().toDateString()
    };
    localStorage.setItem('seobaike_revenue', JSON.stringify(data));
  } catch(e) {}
}

// 初始化收入面板
var revData = loadRevenueData();

var revTodayCounter = new RevenueCounter(document.getElementById('rev-today'), revData.today, 1500);
var revMonthCounter = new RevenueCounter(document.getElementById('rev-month'), revData.month, 2000);
var revTotalCounter = new RevenueCounter(document.getElementById('rev-total'), revData.total, 2500);

revTodayCounter.start();
revMonthCounter.start();
revTotalCounter.start();

// 下線資訊
document.getElementById('ref-count').textContent = revData.referrals || 3;
document.getElementById('ref-active').textContent = revData.active || 2;

// 推薦連結
var refCode = getUserRefCode();
document.getElementById('ref-link').textContent = 'https://aiforseo.vip/?ref=' + refCode;

// ============================================================
// 分享推廣面板 — 全管道單發 + 群發
// ============================================================

function setShareMode(mode) {
  document.getElementById('mode-single').classList.remove('active');
  document.getElementById('mode-bulk').classList.remove('active');
  if (mode === 'bulk') {
    document.getElementById('mode-bulk').classList.add('active');
  } else {
    document.getElementById('mode-single').classList.add('active');
  }
  document.getElementById('bulkSection').style.display = mode === 'bulk' ? 'block' : 'none';
}

function getShareRefCode() {
  var code = localStorage.getItem('seobaike_ref_code');
  if (!code) {
    code = 'REF' + Date.now().toString(36).toUpperCase();
    localStorage.setItem('seobaike_ref_code', code);
  }
  return code;
}

function getShareMsg() {
  var msg = document.getElementById('shareMsg').value;
  return msg.replace('YOUR_CODE', getShareRefCode());
}

function shareVia(channel) {
  var msg = encodeURIComponent(getShareMsg());
  var url = encodeURIComponent('https://aiforseo.vip/?ref=' + getShareRefCode());
  var shareUrl = '';

  switch(channel) {
    case 'line':
      shareUrl = 'https://line.me/R/share?text=' + msg;
      break;
    case 'telegram':
      shareUrl = 'https://t.me/share/url?url=' + url + '&text=' + msg;
      break;
    case 'whatsapp':
      shareUrl = 'https://wa.me/?text=' + msg;
      break;
    case 'messenger':
      shareUrl = 'https://www.facebook.com/dialog/send?link=' + url + '&app_id=0&redirect_uri=' + url;
      break;
    case 'email':
      shareUrl = 'mailto:?subject=' + encodeURIComponent('推薦你一個超好用的 AI 工具') + '&body=' + msg;
      break;
    case 'sms':
      shareUrl = 'sms:?body=' + msg;
      break;
    case 'discord':
      navigator.clipboard.writeText(getShareMsg());
      showShareToast('已複製！請貼到 Discord 頻道');
      trackShare('discord');
      return;
    case 'slack':
      navigator.clipboard.writeText(getShareMsg());
      showShareToast('已複製！請貼到 Slack 頻道');
      trackShare('slack');
      return;
    case 'wechat':
      navigator.clipboard.writeText(getShareMsg());
      showShareToast('已複製！請貼到微信聊天');
      trackShare('wechat');
      return;
    case 'twitter':
      shareUrl = 'https://twitter.com/intent/tweet?text=' + msg;
      break;
    case 'facebook':
      shareUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + url + '&quote=' + msg;
      break;
    case 'copy':
      navigator.clipboard.writeText(getShareMsg());
      showShareToast('已複製到剪貼簿！');
      trackShare('copy');
      return;
  }

  if (shareUrl) {
    window.open(shareUrl, '_blank', 'width=600,height=400');
    trackShare(channel);
  }
}

function showShareToast(message) {
  // 建立 toast 提示
  var toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#e8850c,#f5a623);color:#fff;padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;z-index:9999;box-shadow:0 4px 20px rgba(232,133,12,0.4);animation:slideIn 0.3s;';
  document.body.appendChild(toast);
  setTimeout(function() {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(function() { document.body.removeChild(toast); }, 300);
  }, 2000);
}

function trackShare(channel) {
  var stats = JSON.parse(localStorage.getItem('seobaike_share_stats') || '{"total":0,"channels":{}}');
  stats.total++;
  stats.channels[channel] = (stats.channels[channel] || 0) + 1;
  localStorage.setItem('seobaike_share_stats', JSON.stringify(stats));
  document.getElementById('totalShares').textContent = stats.total;
}

function bulkSend() {
  var list = document.getElementById('bulkList').value.trim().split('\n').filter(function(l) { return l.trim(); });
  if (list.length === 0) {
    showShareToast('請輸入至少一個對象');
    return;
  }

  var msg = getShareMsg();
  var emails = list.filter(function(l) { return l.indexOf('@') > -1; });
  var phones = list.filter(function(l) { return l.indexOf('@') === -1; });

  if (emails.length > 0) {
    window.open('mailto:' + emails.join(',') + '?subject=' + encodeURIComponent('推薦你一個超好用的 AI 工具') + '&body=' + encodeURIComponent(msg));
  }
  if (phones.length > 0) {
    window.open('sms:' + phones.join(',') + '?body=' + encodeURIComponent(msg));
  }

  showShareToast('已發送給 ' + list.length + ' 個對象！');

  // 記錄統計
  var stats = JSON.parse(localStorage.getItem('seobaike_share_stats') || '{"total":0,"channels":{}}');
  stats.total += list.length;
  stats.channels['bulk'] = (stats.channels['bulk'] || 0) + list.length;
  localStorage.setItem('seobaike_share_stats', JSON.stringify(stats));
  document.getElementById('totalShares').textContent = stats.total;
}

// 分享面板初始化
(function initSharePanel() {
  // 更新分享訊息中的推薦碼
  var textarea = document.getElementById('shareMsg');
  if (textarea) {
    textarea.value = textarea.value.replace('YOUR_CODE', getShareRefCode());
    // 字數計算
    document.getElementById('charCount').textContent = textarea.value.length;
    textarea.addEventListener('input', function() {
      document.getElementById('charCount').textContent = textarea.value.length;
    });
  }

  // 群發對象計算
  var bulkList = document.getElementById('bulkList');
  if (bulkList) {
    bulkList.addEventListener('input', function() {
      var count = bulkList.value.trim().split('\n').filter(function(l) { return l.trim(); }).length;
      document.getElementById('bulkCount').textContent = count;
    });
  }

  // 載入分享統計
  var stats = JSON.parse(localStorage.getItem('seobaike_share_stats') || '{"total":0,"channels":{}}');
  document.getElementById('totalShares').textContent = stats.total;
})();
</script>
<script>
(function(){
  try {
    var cfg = window.__SEOBAIKE__ || {};
    var sUrl = cfg.supabaseUrl || 'https://vmyrivxxibqydccurxug.supabase.co';
    var sKey = cfg.anonKey || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteXJpdnh4aWJxeWRjY3VyeHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNDAwMjksImV4cCI6MjA4NTYxNjAyOX0.iBV-23LGdm_uKffAExgqSV34-NWoAyv8_-M_cJQZ8Gg';
    fetch(sUrl + '/rest/v1/page_views', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'apikey':sKey, 'Authorization':'Bearer '+sKey, 'Prefer':'return=minimal' },
      body: JSON.stringify({ path: location.pathname, referrer: document.referrer || null, user_agent: navigator.userAgent })
    }).catch(function(){});
  } catch(e){}
})();
</script>
<script src="/assets/smart-align.js"></script>
<script src="/seobaike-widget.js"></script>
</body>
</html>
