<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEOBAIKE — 即時儀錶板</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; background: #0a0a1a; color: #eee; min-height: 100vh; }
.header { background: linear-gradient(135deg, #76b900 0%, #cc785c 50%, #1a1a2e 100%); padding: 16px 30px; display: flex; align-items: center; gap: 14px; }
.header h1 { font-size: 24px; color: #fff; }
.badge { padding: 5px 12px; border-radius: 14px; font-size: 12px; font-weight: bold; }
.live-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #0f0; animation: pulse 1s infinite; margin-right: 6px; }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.2; } }
@keyframes slideIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
.grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 20px 30px; }
.card { background: linear-gradient(135deg, #16213e, #1a1a2e); border: 1px solid #333; border-radius: 16px; padding: 20px; text-align: center; transition: all 0.3s; }
.card:hover { border-color: #76b900; transform: translateY(-2px); }
.card .num { font-size: 42px; font-weight: bold; color: #76b900; transition: all 0.5s; }
.card .num.changed { animation: slideIn 0.5s; color: #fff; }
.card .lbl { font-size: 13px; color: #888; margin-top: 6px; }
.engines { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0 30px 16px; }
.engine { background: #16213e; border: 1px solid #333; border-radius: 16px; padding: 20px; }
.engine h3 { font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.engine .status { display: inline-block; width: 12px; height: 12px; border-radius: 50%; }
.engine .ok { background: #76b900; }
.engine .fail { background: #ff4444; }
.engine .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.engine .stat { text-align: center; }
.engine .stat .val { font-size: 28px; font-weight: bold; }
.engine .stat .key { font-size: 11px; color: #888; }
.bar-container { margin-top: 10px; background: #0a0a1a; border-radius: 8px; height: 8px; overflow: hidden; }
.bar { height: 100%; border-radius: 8px; transition: width 0.5s; }
.bar.green { background: linear-gradient(90deg, #76b900, #8ed100); }
.bar.orange { background: linear-gradient(90deg, #e8850c, #ffa040); }
.log-section { padding: 0 30px 20px; }
.log-section h3 { font-size: 14px; color: #76b900; margin-bottom: 8px; }
.log { background: #0d1117; border: 1px solid #222; border-radius: 12px; padding: 12px 16px; max-height: 200px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.8; }
.log .entry { animation: slideIn 0.3s; }
.log .ok { color: #76b900; }
.log .err { color: #ff6b6b; }
.log .ts { color: #555; }
.routes { padding: 0 30px 20px; }
.routes h3 { font-size: 14px; color: #cc785c; margin-bottom: 8px; }
.route-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px; }
.route { background: #16213e; border: 1px solid #222; border-radius: 10px; padding: 10px 14px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
.route .name { color: #e8850c; font-weight: bold; }
.route .path { color: #888; }
.footer { text-align: center; padding: 16px; color: #333; font-size: 11px; }

/* === Real-Time Data Panels === */
.data-panels { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 0 30px 16px; }
.data-panel { background: linear-gradient(135deg, #16213e, #1a1a2e); border: 1px solid #333; border-radius: 16px; padding: 20px; position: relative; overflow: hidden; }
.data-panel:hover { border-color: #e8850c; }
.data-panel h3 { font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: #e8850c; }
.data-panel h3 .icon { font-size: 18px; }
.data-panel .big-num { font-size: 36px; font-weight: bold; color: #76b900; line-height: 1.2; }
.data-panel .sub-stats { display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap; }
.data-panel .sub-stat { text-align: center; flex: 1; min-width: 60px; }
.data-panel .sub-stat .sv { font-size: 20px; font-weight: bold; color: #cc785c; }
.data-panel .sub-stat .sk { font-size: 10px; color: #888; margin-top: 2px; }
.data-panel .status-badge { display: inline-block; padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: bold; margin-top: 8px; }
.data-panel .status-ok { background: rgba(118,185,0,0.15); color: #76b900; border: 1px solid #76b900; }
.data-panel .status-down { background: rgba(255,68,68,0.15); color: #ff4444; border: 1px solid #ff4444; }
.data-panel .status-loading { background: rgba(232,133,12,0.15); color: #e8850c; border: 1px solid #e8850c; }
.data-panel .recent-list { list-style: none; margin-top: 10px; max-height: 120px; overflow-y: auto; }
.data-panel .recent-list li { font-size: 11px; padding: 3px 0; border-bottom: 1px solid #1a1a2e; display: flex; justify-content: space-between; gap: 6px; }
.data-panel .recent-list li .rp { color: #76b900; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
.data-panel .recent-list li .rt { color: #555; white-space: nowrap; font-size: 10px; }
.refresh-indicator { position: absolute; top: 8px; right: 12px; font-size: 10px; color: #444; }
.refresh-indicator.active { color: #e8850c; }
@keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
.spinner { display: inline-block; animation: spin 1s linear infinite; }

/* Live Activity Feed */
.activity-feed { padding: 0 30px 20px; }
.activity-feed h3 { font-size: 14px; color: #76b900; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.activity-feed h3 .auto-label { font-size: 11px; color: #555; font-weight: normal; }
.feed-table { width: 100%; background: #0d1117; border: 1px solid #222; border-radius: 12px; overflow: hidden; }
.feed-table table { width: 100%; border-collapse: collapse; font-size: 12px; }
.feed-table th { background: #16213e; color: #e8850c; text-align: left; padding: 8px 12px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; }
.feed-table td { padding: 6px 12px; border-top: 1px solid #1a1a2e; color: #ccc; }
.feed-table tr:hover td { background: rgba(118,185,0,0.05); }
.feed-table .fp { color: #76b900; font-weight: 600; }
.feed-table .fts { color: #888; font-size: 11px; }
.feed-table .fua { color: #555; font-size: 10px; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.feed-table .fc { color: #cc785c; font-size: 11px; }

/* Responsive: stack panels on smaller screens */
@media (max-width: 1200px) {
  .data-panels { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 768px) {
  .grid { grid-template-columns: repeat(2, 1fr); }
  .data-panels { grid-template-columns: 1fr; }
  .engines { grid-template-columns: 1fr; }
  .header { flex-wrap: wrap; }
}
</style>
</head>
<body>

<div class="header" style="background:linear-gradient(135deg,#1a0f00 0%,#2a1500 50%,#0a0a1a 100%);">
  <h1 style="background:linear-gradient(90deg,#e8850c,#cc785c,#76b900);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">SEOBAIKE</h1>
  <span class="badge" style="background:#e8850c;color:#000;">AI FOR SEO</span>
  <span class="badge" style="background:#cc785c;color:#fff;">專利 115100981</span>
  <span class="badge" style="background:#111;color:#0f0;border:1px solid #333;"><span class="live-dot"></span><span id="status">連線中...</span></span>
  <span style="margin-left:auto;font-size:12px;color:#888;" id="clock"></span>
</div>

<div class="grid" id="mainGrid">
  <div class="card"><div class="num" id="d-l1">--</div><div class="lbl">L1 產業類別</div></div>
  <div class="card"><div class="num" id="d-l2">--</div><div class="lbl">L2 次產業</div></div>
  <div class="card"><div class="num" id="d-l3">--</div><div class="lbl">L3 製程</div></div>
  <div class="card"><div class="num" id="d-l4">--</div><div class="lbl">L4 原子節點</div></div>
  <div class="card"><div class="num" id="d-checks" style="color:#e8850c;">--</div><div class="lbl">路徑檢查總次數</div></div>
  <div class="card"><div class="num" id="d-audit" style="color:#e8850c;">--</div><div class="lbl">稽核記錄</div></div>
  <div class="card"><div class="num" id="d-allow" style="color:#76b900;">--</div><div class="lbl">Allow 規則</div></div>
  <div class="card"><div class="num" id="d-deny" style="color:#ff6b6b;">--</div><div class="lbl">Deny 規則</div></div>
</div>

<!-- Real-Time Data Panels -->
<div class="data-panels">
  <!-- Panel 1: Page Views -->
  <div class="data-panel">
    <span class="refresh-indicator" id="pv-refresh">--</span>
    <h3><span class="icon">&#128202;</span> 頁面瀏覽</h3>
    <div class="big-num" id="pv-total">--</div>
    <div style="font-size:11px;color:#888;margin-top:2px;">總頁面瀏覽次數</div>
    <div class="sub-stats">
      <div class="sub-stat"><div class="sv" id="pv-today">--</div><div class="sk">今日</div></div>
      <div class="sub-stat"><div class="sv" id="pv-unique">--</div><div class="sk">不重複路徑</div></div>
    </div>
    <ul class="recent-list" id="pv-recent"></ul>
  </div>

  <!-- Panel 2: API / System Status -->
  <div class="data-panel">
    <span class="refresh-indicator" id="api-refresh">--</span>
    <h3><span class="icon">&#9889;</span> API 狀態</h3>
    <div id="api-status-badge" class="status-badge status-loading">檢查中...</div>
    <div class="sub-stats" style="margin-top:14px;">
      <div class="sub-stat"><div class="sv" id="api-l1">--</div><div class="sk">L1</div></div>
      <div class="sub-stat"><div class="sv" id="api-l2">--</div><div class="sk">L2</div></div>
      <div class="sub-stat"><div class="sv" id="api-l3">--</div><div class="sk">L3</div></div>
      <div class="sub-stat"><div class="sv" id="api-l4">--</div><div class="sk">L4</div></div>
    </div>
    <div style="margin-top:10px;text-align:center;">
      <div style="font-size:28px;font-weight:bold;color:#76b900;" id="api-total-nodes">--</div>
      <div style="font-size:10px;color:#888;">節點總數</div>
    </div>
  </div>

  <!-- Panel 3: Users / Submissions -->
  <div class="data-panel">
    <span class="refresh-indicator" id="usr-refresh">--</span>
    <h3><span class="icon">&#128101;</span> 用戶互動</h3>
    <div class="sub-stats" style="margin-top:4px;">
      <div class="sub-stat">
        <div class="sv" style="font-size:28px;color:#76b900;" id="usr-contacts">--</div>
        <div class="sk">聯絡表單</div>
      </div>
      <div class="sub-stat">
        <div class="sv" style="font-size:28px;color:#e8850c;" id="usr-newsletter">--</div>
        <div class="sk">電子報訂閱</div>
      </div>
    </div>
    <div style="margin-top:14px;text-align:center;">
      <div style="font-size:36px;font-weight:bold;color:#cc785c;" id="usr-total">--</div>
      <div style="font-size:10px;color:#888;">互動總計</div>
    </div>
  </div>

  <!-- Panel 4: Live Mini Feed -->
  <div class="data-panel">
    <span class="refresh-indicator" id="feed-refresh">--</span>
    <h3><span class="icon">&#128640;</span> 即時動態</h3>
    <div style="font-size:11px;color:#888;margin-bottom:6px;">最近 5 筆瀏覽</div>
    <ul class="recent-list" id="mini-feed" style="max-height:180px;"></ul>
  </div>
</div>

<div class="engines">
  <div class="engine">
    <h3><span class="status" id="nv-status"></span> SEOBAIKE 主引擎</h3>
    <div class="stats">
      <div class="stat"><div class="val" style="color:#76b900;" id="nv-ok">0</div><div class="key">成功</div></div>
      <div class="stat"><div class="val" style="color:#ff6b6b;" id="nv-fail">0</div><div class="key">失敗</div></div>
      <div class="stat"><div class="val" style="color:#e8850c;" id="nv-ms">--</div><div class="key">延遲 ms</div></div>
    </div>
    <div class="bar-container"><div class="bar green" id="nv-bar" style="width:0%"></div></div>
  </div>
  <div class="engine">
    <h3><span class="status" id="gw-status"></span> SEOBAIKE 約束引擎</h3>
    <div class="stats">
      <div class="stat"><div class="val" style="color:#76b900;" id="gw-ok">0</div><div class="key">成功</div></div>
      <div class="stat"><div class="val" style="color:#ff6b6b;" id="gw-fail">0</div><div class="key">失敗</div></div>
      <div class="stat"><div class="val" style="color:#e8850c;" id="gw-ms">--</div><div class="key">延遲 ms</div></div>
    </div>
    <div class="bar-container"><div class="bar orange" id="gw-bar" style="width:0%"></div></div>
  </div>
</div>

<div class="routes">
  <h3>SEOBAIKE 路由配置</h3>
  <div class="route-grid" id="routeGrid"></div>
</div>

<!-- Live Activity Feed (last 10 page views) -->
<div class="activity-feed">
  <h3>&#128205; 即時瀏覽記錄 <span class="auto-label">(每 30 秒自動刷新)</span></h3>
  <div class="feed-table">
    <table>
      <thead><tr><th>路徑</th><th>時間</th><th>國家</th><th>User Agent</th></tr></thead>
      <tbody id="activity-tbody"><tr><td colspan="4" style="text-align:center;color:#555;padding:20px;">載入中...</td></tr></tbody>
    </table>
  </div>
</div>

<div class="log-section">
  <h3>即時測試記錄 <span style="color:#555;font-weight:normal;">(每 5 秒自動測試)</span></h3>
  <div class="log" id="log"></div>
</div>

<div class="footer">SEOBAIKE — 專利 115100981 — 小路光有限公司 — AI FOR SEO</div>

<script src="/seobaike-config.js"></script>
<script>
const SUPA_URL = (window.__SEOBAIKE__ && window.__SEOBAIKE__.supabaseUrl) || "";
const SUPA_KEY = (window.__SEOBAIKE__ && window.__SEOBAIKE__.anonKey) || "";
const EP = SUPA_URL + "/functions/v1/nvidia-boss";
const GW = SUPA_URL + "/functions/v1/ai-gateway";
const HDR = { "Authorization": "Bearer " + SUPA_KEY, "Content-Type": "application/json" };
const REST_HDR = { "apikey": SUPA_KEY, "Authorization": "Bearer " + SUPA_KEY };

let nvOk=0, nvFail=0, gwOk=0, gwFail=0, round=0;
const msgs = ["system status","patent check","L1 L2 L3 L4 count","constraint rules","audit report","binding list","allow industries","path check stats","performance","health"];
const log = document.getElementById("log");
const routes = [
  {name:"flagship_dual", path:"主引擎 → 備援引擎"},
  {name:"boss_direct", path:"備援引擎 → 主引擎"},
  {name:"code_generation", path:"主引擎 → 推理引擎"},
  {name:"reasoning_dual", path:"推理引擎 → 主引擎"},
  {name:"fast_dual", path:"快速引擎 → 備援引擎"},
];
document.getElementById("routeGrid").innerHTML = routes.map(r =>
  '<div class="route"><span class="name">' + r.name + '</span><span class="path">' + r.path + '</span></div>'
).join("");

function updateNum(id, val) {
  const el = document.getElementById(id);
  if (el && el.textContent !== String(val)) {
    el.textContent = val;
    el.classList.add("changed");
    setTimeout(() => el.classList.remove("changed"), 600);
  }
}

function addLog(text, cls) {
  const ts = new Date().toLocaleTimeString("zh-TW");
  const div = document.createElement("div");
  div.className = "entry";
  div.innerHTML = '<span class="ts">[' + ts + ']</span> <span class="' + cls + '">' + text + '</span>';
  log.prepend(div);
  if (log.children.length > 100) log.lastChild.remove();
}

setInterval(() => {
  document.getElementById("clock").textContent = new Date().toLocaleString("zh-TW");
}, 1000);

// 直接從 Supabase REST API 讀取真實節點數據
async function loadRealData() {
  try {
    const queries = [
      fetch(SUPA_URL + "/rest/v1/l1_categories?select=id", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/l2_subcategories?select=id", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/l3_processes?select=id", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/l4_nodes?select=id", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/inference_audit_trail?select=id&order=created_at.desc&limit=1", { headers: { ...REST_HDR, "Prefer": "count=exact" } }),
      fetch(SUPA_URL + "/rest/v1/constraint_rules?select=id&effect=eq.allow", { headers: REST_HDR }),
      fetch(SUPA_URL + "/rest/v1/constraint_rules?select=id&effect=eq.deny", { headers: REST_HDR }),
    ];
    const results = await Promise.allSettled(queries);

    if (results[0].status === 'fulfilled' && results[0].value.ok) {
      const l1 = await results[0].value.json();
      updateNum("d-l1", l1.length);
    }
    if (results[1].status === 'fulfilled' && results[1].value.ok) {
      const l2 = await results[1].value.json();
      updateNum("d-l2", l2.length);
    }
    if (results[2].status === 'fulfilled' && results[2].value.ok) {
      const l3 = await results[2].value.json();
      updateNum("d-l3", l3.length);
    }
    if (results[3].status === 'fulfilled' && results[3].value.ok) {
      const l4 = await results[3].value.json();
      updateNum("d-l4", l4.length);
    }
    if (results[4].status === 'fulfilled') {
      const countHeader = results[4].value.headers.get('content-range');
      if (countHeader) {
        const total = countHeader.split('/')[1];
        if (total && total !== '*') updateNum("d-audit", total);
      } else {
        const audit = await results[4].value.json();
        if (Array.isArray(audit)) updateNum("d-audit", audit.length > 0 ? audit.length + '+' : '0');
      }
    }
    if (results[5].status === 'fulfilled' && results[5].value.ok) {
      const allow = await results[5].value.json();
      updateNum("d-allow", allow.length);
    }
    if (results[6].status === 'fulfilled' && results[6].value.ok) {
      const deny = await results[6].value.json();
      updateNum("d-deny", deny.length);
    }

    addLog("Supabase REST 直連：節點數據已載入", "ok");
    document.getElementById("status").textContent = "資料庫已連線";
  } catch (err) {
    addLog("REST 直連失敗: " + err.message + " — 切換到引擎模式", "err");
  }
}

// 頁面載入時先讀真實數據
loadRealData();

async function tick() {
  round++;
  const msg = msgs[round % msgs.length];
  document.getElementById("status").textContent = "同步測試中 #" + round;

  const nvJob = (async () => {
    const t0 = performance.now();
    const res = await fetch(EP, { method:"POST", headers:HDR, body:JSON.stringify({message:msg}) });
    const ms = Math.round(performance.now() - t0);
    const data = await res.json();
    if (res.ok && data.reply) {
      nvOk++;
      document.getElementById("nv-status").className = "status ok";
      document.getElementById("nv-ms").textContent = ms;
      addLog("主引擎 #" + round + " OK (" + ms + "ms) — " + data.reply.substring(0,40) + "...", "ok");
      if (data.real_data) {
        updateNum("d-l1", data.real_data.l1_count);
        updateNum("d-l2", data.real_data.l2_count);
        updateNum("d-l3", data.real_data.l3_count);
        updateNum("d-l4", data.real_data.l4_count);
        if (data.real_data.total_path_checks) updateNum("d-checks", data.real_data.total_path_checks);
        if (data.real_data.total_audit_entries) updateNum("d-audit", data.real_data.total_audit_entries);
        if (data.real_data.allow_paths) updateNum("d-allow", data.real_data.allow_paths);
        if (data.real_data.deny_paths) updateNum("d-deny", data.real_data.deny_paths);
      }
    } else { nvFail++; document.getElementById("nv-status").className = "status fail"; addLog("主引擎 #" + round + " FAIL: " + JSON.stringify(data).substring(0,60), "err"); }
  })().catch(e => { nvFail++; addLog("主引擎 #" + round + " ERROR: " + e.message, "err"); });

  const gwJob = (async () => {
    const t0 = performance.now();
    const res = await fetch(GW, { method:"POST", headers:HDR, body:JSON.stringify({message:msg, platform:"telegram", platform_user_id:"5372713163"}) });
    const ms = Math.round(performance.now() - t0);
    const data = await res.json();
    if (res.ok && data.allowed) {
      gwOk++;
      document.getElementById("gw-status").className = "status ok";
      document.getElementById("gw-ms").textContent = ms;
      addLog("約束引擎 #" + round + " OK (" + ms + "ms) allowed=" + data.allowed + " industry=" + data.industry, "ok");
    } else if (res.ok) {
      gwOk++;
      document.getElementById("gw-status").className = "status ok";
      document.getElementById("gw-ms").textContent = ms;
      addLog("約束引擎 #" + round + " CONSTRAINED (" + ms + "ms) " + (data.reason||"").substring(0,40), "ok");
    } else { gwFail++; document.getElementById("gw-status").className = "status fail"; addLog("約束引擎 #" + round + " FAIL: " + JSON.stringify(data).substring(0,60), "err"); }
  })().catch(e => { gwFail++; addLog("約束引擎 #" + round + " ERROR: " + e.message, "err"); });

  await Promise.all([nvJob, gwJob]);

  document.getElementById("nv-ok").textContent = nvOk;
  document.getElementById("nv-fail").textContent = nvFail;
  document.getElementById("nv-bar").style.width = (nvOk / (nvOk + nvFail) * 100) + "%";
  document.getElementById("gw-ok").textContent = gwOk;
  document.getElementById("gw-fail").textContent = gwFail;
  document.getElementById("gw-bar").style.width = (gwOk / (gwOk + gwFail) * 100) + "%";

  document.getElementById("status").textContent = "同步運行中 | 第 " + round + " 輪";
}

tick();
setInterval(tick, 15000);

// ============================================================
// Real-Time Data Panels — 每 30 秒自動刷新
// ============================================================

const COUNT_HDR = { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" };

function timeAgo(dateStr) {
  var d = new Date(dateStr);
  var now = new Date();
  var sec = Math.floor((now - d) / 1000);
  if (sec < 60) return sec + " 秒前";
  if (sec < 3600) return Math.floor(sec / 60) + " 分鐘前";
  if (sec < 86400) return Math.floor(sec / 3600) + " 小時前";
  return Math.floor(sec / 86400) + " 天前";
}

function shortUA(ua) {
  if (!ua) return "--";
  // Extract browser name roughly
  if (ua.indexOf("Chrome") > -1 && ua.indexOf("Edg") > -1) return "Edge";
  if (ua.indexOf("Chrome") > -1) return "Chrome";
  if (ua.indexOf("Firefox") > -1) return "Firefox";
  if (ua.indexOf("Safari") > -1 && ua.indexOf("Chrome") === -1) return "Safari";
  if (ua.indexOf("bot") > -1 || ua.indexOf("Bot") > -1 || ua.indexOf("crawl") > -1) return "Bot";
  return ua.substring(0, 30) + "...";
}

function setRefresh(id) {
  var el = document.getElementById(id);
  if (el) {
    el.textContent = new Date().toLocaleTimeString("zh-TW");
    el.className = "refresh-indicator active";
    setTimeout(function() { el.className = "refresh-indicator"; }, 2000);
  }
}

// Panel 1: Page Views
async function loadPageViews() {
  try {
    // Get total count via HEAD-like approach
    var countRes = await fetch(SUPA_URL + "/rest/v1/page_views?select=id", {
      method: "HEAD",
      headers: { ...REST_HDR, "Prefer": "count=exact" }
    });
    var range = countRes.headers.get("content-range");
    if (range) {
      var total = range.split("/")[1];
      if (total && total !== "*") updateNum("pv-total", Number(total).toLocaleString());
    } else {
      // Fallback: GET with count header
      var countRes2 = await fetch(SUPA_URL + "/rest/v1/page_views?select=id", {
        headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" }
      });
      var range2 = countRes2.headers.get("content-range");
      if (range2) {
        var total2 = range2.split("/")[1];
        if (total2 && total2 !== "*") updateNum("pv-total", Number(total2).toLocaleString());
      }
    }

    // Get today's count
    var todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    var todayISO = todayStart.toISOString();
    var todayRes = await fetch(SUPA_URL + "/rest/v1/page_views?select=id&created_at=gte." + todayISO, {
      headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" }
    });
    var todayRange = todayRes.headers.get("content-range");
    if (todayRange) {
      var todayTotal = todayRange.split("/")[1];
      if (todayTotal && todayTotal !== "*") document.getElementById("pv-today").textContent = todayTotal;
    }

    // Get unique paths count
    var pathsRes = await fetch(SUPA_URL + "/rest/v1/rpc/get_unique_paths_count", {
      method: "POST",
      headers: { ...REST_HDR, "Content-Type": "application/json" },
      body: "{}"
    });
    if (pathsRes.ok) {
      var pathCount = await pathsRes.json();
      document.getElementById("pv-unique").textContent = pathCount;
    } else {
      // Fallback: get recent paths and count unique
      var recentPaths = await fetch(SUPA_URL + "/rest/v1/page_views?select=path&order=created_at.desc&limit=500", { headers: REST_HDR });
      if (recentPaths.ok) {
        var pp = await recentPaths.json();
        var unique = {};
        pp.forEach(function(r) { unique[r.path] = true; });
        document.getElementById("pv-unique").textContent = Object.keys(unique).length;
      }
    }

    // Recent 5 visits for the panel list
    var recentRes = await fetch(SUPA_URL + "/rest/v1/page_views?select=path,created_at&order=created_at.desc&limit=5", { headers: REST_HDR });
    if (recentRes.ok) {
      var recent = await recentRes.json();
      var html = "";
      recent.forEach(function(r) {
        html += '<li><span class="rp">' + (r.path || "/") + '</span><span class="rt">' + timeAgo(r.created_at) + '</span></li>';
      });
      document.getElementById("pv-recent").innerHTML = html;
    }

    setRefresh("pv-refresh");
    addLog("頁面瀏覽面板已更新", "ok");
  } catch (e) {
    addLog("頁面瀏覽面板錯誤: " + e.message, "err");
  }
}

// Panel 2: API / System Status
async function loadAPIStatus() {
  try {
    var statusBadge = document.getElementById("api-status-badge");

    // Try the external API status endpoint
    var apiOk = false;
    try {
      var statusRes = await fetch("https://aiforseo.vip/api/v1/status", { signal: AbortSignal.timeout(8000) });
      if (statusRes.ok) {
        apiOk = true;
        statusBadge.textContent = "營運中 Operational";
        statusBadge.className = "status-badge status-ok";
      }
    } catch (e) {
      // Status endpoint not reachable, check Supabase directly
      var pingRes = await fetch(SUPA_URL + "/rest/v1/l1_categories?select=id&limit=1", { headers: REST_HDR });
      if (pingRes.ok) {
        apiOk = true;
        statusBadge.textContent = "資料庫正常";
        statusBadge.className = "status-badge status-ok";
      }
    }

    if (!apiOk) {
      statusBadge.textContent = "連線異常";
      statusBadge.className = "status-badge status-down";
    }

    // Load L1-L4 node counts (reuse from main grid but for API panel)
    var l1r = await fetch(SUPA_URL + "/rest/v1/l1_categories?select=id", { headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" } });
    var l2r = await fetch(SUPA_URL + "/rest/v1/l2_subcategories?select=id", { headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" } });
    var l3r = await fetch(SUPA_URL + "/rest/v1/l3_processes?select=id", { headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" } });
    var l4r = await fetch(SUPA_URL + "/rest/v1/l4_nodes?select=id", { headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" } });

    var total = 0;
    [["api-l1", l1r], ["api-l2", l2r], ["api-l3", l3r], ["api-l4", l4r]].forEach(function(pair) {
      var cr = pair[1].headers.get("content-range");
      if (cr) {
        var n = cr.split("/")[1];
        if (n && n !== "*") {
          document.getElementById(pair[0]).textContent = n;
          total += Number(n);
        }
      }
    });

    if (total > 0) {
      document.getElementById("api-total-nodes").textContent = total.toLocaleString();
    }

    setRefresh("api-refresh");
    addLog("API 狀態面板已更新 — 節點總數: " + total, "ok");
  } catch (e) {
    addLog("API 面板錯誤: " + e.message, "err");
    document.getElementById("api-status-badge").textContent = "錯誤";
    document.getElementById("api-status-badge").className = "status-badge status-down";
  }
}

// Panel 3: Users / Submissions
async function loadUserStats() {
  try {
    var contactRes = await fetch(SUPA_URL + "/rest/v1/contact_submissions?select=id", {
      headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" }
    });
    var newsletterRes = await fetch(SUPA_URL + "/rest/v1/newsletter_subscriptions?select=id", {
      headers: { ...REST_HDR, "Prefer": "count=exact", "Range": "0-0" }
    });

    var contacts = 0, newsletters = 0;

    var cr1 = contactRes.headers.get("content-range");
    if (cr1) {
      var n1 = cr1.split("/")[1];
      if (n1 && n1 !== "*") { contacts = Number(n1); document.getElementById("usr-contacts").textContent = contacts; }
    } else {
      // Fallback: read full array
      var cData = await fetch(SUPA_URL + "/rest/v1/contact_submissions?select=id", { headers: REST_HDR });
      if (cData.ok) { var cArr = await cData.json(); contacts = cArr.length; document.getElementById("usr-contacts").textContent = contacts; }
    }

    var cr2 = newsletterRes.headers.get("content-range");
    if (cr2) {
      var n2 = cr2.split("/")[1];
      if (n2 && n2 !== "*") { newsletters = Number(n2); document.getElementById("usr-newsletter").textContent = newsletters; }
    } else {
      var nData = await fetch(SUPA_URL + "/rest/v1/newsletter_subscriptions?select=id", { headers: REST_HDR });
      if (nData.ok) { var nArr = await nData.json(); newsletters = nArr.length; document.getElementById("usr-newsletter").textContent = newsletters; }
    }

    document.getElementById("usr-total").textContent = (contacts + newsletters).toLocaleString();
    setRefresh("usr-refresh");
    addLog("用戶互動面板已更新 — 聯絡: " + contacts + " / 訂閱: " + newsletters, "ok");
  } catch (e) {
    addLog("用戶面板錯誤: " + e.message, "err");
  }
}

// Panel 4: Mini Live Feed (sidebar) + Full Activity Feed Table
async function loadActivityFeed() {
  try {
    var feedRes = await fetch(SUPA_URL + "/rest/v1/page_views?select=path,created_at,user_agent,country&order=created_at.desc&limit=10", { headers: REST_HDR });
    if (!feedRes.ok) throw new Error("HTTP " + feedRes.status);
    var data = await feedRes.json();

    // Mini feed (panel 4 — 5 items)
    var miniHtml = "";
    data.slice(0, 5).forEach(function(r) {
      miniHtml += '<li><span class="rp">' + (r.path || "/") + '</span><span class="rt">' + timeAgo(r.created_at) + '</span></li>';
    });
    document.getElementById("mini-feed").innerHTML = miniHtml;

    // Full activity feed table (10 items)
    var tbody = document.getElementById("activity-tbody");
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#555;padding:20px;">尚無瀏覽記錄</td></tr>';
    } else {
      var thtml = "";
      data.forEach(function(r) {
        var dt = new Date(r.created_at);
        var tsStr = dt.toLocaleString("zh-TW", { month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });
        thtml += '<tr>';
        thtml += '<td class="fp">' + (r.path || "/") + '</td>';
        thtml += '<td class="fts">' + tsStr + ' <span style="color:#555;">(' + timeAgo(r.created_at) + ')</span></td>';
        thtml += '<td class="fc">' + (r.country || "--") + '</td>';
        thtml += '<td class="fua" title="' + (r.user_agent || "").replace(/"/g, '&quot;') + '">' + shortUA(r.user_agent) + '</td>';
        thtml += '</tr>';
      });
      tbody.innerHTML = thtml;
    }

    setRefresh("feed-refresh");
    addLog("即時動態已更新 — " + data.length + " 筆記錄", "ok");
  } catch (e) {
    addLog("即時動態錯誤: " + e.message, "err");
  }
}

// Master refresh function
async function refreshAllPanels() {
  addLog("--- 面板自動刷新 ---", "ok");
  await Promise.allSettled([
    loadPageViews(),
    loadAPIStatus(),
    loadUserStats(),
    loadActivityFeed()
  ]);
}

// Initial load
refreshAllPanels();

// Auto-refresh every 30 seconds
setInterval(refreshAllPanels, 30000);
</script>
<script>
(function(){
  try {
    var cfg = window.__SEOBAIKE__ || {};
    var sUrl = cfg.supabaseUrl || 'https://vmyrivxxibqydccurxug.supabase.co';
    var sKey = cfg.anonKey || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteXJpdnh4aWJxeWRjY3VyeHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNDAwMjksImV4cCI6MjA4NTYxNjAyOX0.iBV-23LGdm_uKffAExgqSV34-NWoAyv8_-M_cJQZ8Gg';
    fetch(sUrl + '/rest/v1/page_views', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'apikey':sKey, 'Authorization':'Bearer '+sKey, 'Prefer':'return=minimal' },
      body: JSON.stringify({ path: location.pathname, referrer: document.referrer || null, user_agent: navigator.userAgent })
    }).catch(function(){});
  } catch(e){}
})();
</script>
</body>
</html>
